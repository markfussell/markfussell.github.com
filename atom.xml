<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Polyglot]]></title>
  <link href="http://markfussell.emenar.com/atom.xml" rel="self"/>
  <link href="http://markfussell.emenar.com/"/>
  <updated>2015-10-11T16:19:28-07:00</updated>
  <id>http://markfussell.emenar.com/</id>
  <author>
    <name><![CDATA[Mark Fussell]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Advanced Development and Delivery (ADD) [Part-10]]]></title>
    <link href="http://markfussell.emenar.com/blog/add-10/"/>
    <updated>2015-10-10T02:00:00-07:00</updated>
    <id>http://markfussell.emenar.com/blog/add-10</id>
    <content type="html"><![CDATA[<p>This is the tenth installment of describing a radically more productive development and delivery environment.</p>

<p>The first part is here: <a href="http://markfussell.emenar.com/blog/add-1/">Intro</a>.  In the previous parts I described the big picture, Vagrant and EC2,
node initialization, the one minute configuration HeartBeat, HipChat integration, presence, EC2, configuring nodes, and inter-machine presence.</p>

<h2>A good, opinionated, framework</h2>

<p>Back in 1972, Smalltalk became the first Object-Oriented Programming Language (Simula was Object-Based but there is a difference).
For decades this kind of language was &#8216;esoteric&#8217;.  It was like LISP or Prolog or APL: somehow exotic and inaccessible.
I was lucky: I had access to Smalltalk at Caltech.  I had access to lots of crazy expensive things at Caltech and that
made the exotic (e.g. making your own chips) into the mundane (e.g. made lots of chips, they were commonly broken,
had to be re-fabricated, and I eventually got bored with all that and moved a level up).</p>

<!-- more -->


<p>But back to the language of Smalltalk.  The problem with Smalltalk is that it appears to be a language when it is
actually a computer. &#8216;C&#8217; was a language.  It made programs. &#8216;Pascal&#8217;, &#8216;Lisp&#8217; (sans Machine), &#8216;Fortan&#8217;, and so on&#8230;
they were all languages.  Smalltalk <em>contains</em> a language.  It is named Smalltalk (darn).  But Smalltalk-80 was not
<em>just</em> a language, it was an <em>entire running operating system with applications and full source</em>  It could boot on
most any machine that you made the &#8216;bootstrap&#8217; code work on.  To make a new Smalltalk-80 machine, you cloned either
the primordial Smalltalk-80 &#8216;image&#8217; from PARC, or you cloned your own modified &#8216;image&#8217;.  And by &#8216;image&#8217; this is
basically the same concept as cloning a disk&#8230; bit by bit identical copy that happens to be on a different disk / computer.</p>

<p>Eventually OOP became mainstream with Java, C++, Objective-C, Ruby, Python, and the like.  So people thought they
were getting the &#8220;Smalltalk&#8221; (or LISP Machine) benefits.  But they left out the &#8216;computer&#8217; that went with the language.</p>

<h3>Why opinionated?</h3>

<p>The Smalltalk computer was quite functional and thoroughly opinionated.  It <em>already did</em> a bunch of things and showed
you how it did them.  It wasn&#8217;t opinionated like a human usually uses the term: &#8220;You should build that house out of bricks, not straw&#8221;.
It was opinionated like the planet is: &#8220;I have already created lots of flora and fauna&#8230; please use them wisely&#8221;.  Even
how humans on the planet are: &#8220;We have already created plenty of roads&#8230; please use them instead of driving through yards&#8221;</p>

<p>Opinionated is basically a synonym for &#8220;Working&#8221;.  Smalltalk computers &#8220;worked&#8221; so don&#8217;t break it.  They work, so you
should probably copy them for anything similar.  And they work, so you might want to study how they work even if you
are going to be creative later.</p>

<h3>Modern &#8216;working&#8217; frameworks</h3>

<p>Early frameworks (say for Java) &#8216;kind-of-worked&#8217;.  They didn&#8217;t fully work, but you could &#8216;configure&#8217; them to work.
That is like getting all &#8216;IKEA&#8217; furniture for your house.  You could easily build it wrong.  It could not work
together.  Yes, you get to &#8216;tweak&#8217; it, but if someone simply offered &#8220;a furnished house&#8221; you would save a lot of
time and leverage their full sense of design.  Or you could go to a different furnished house that more closely matched your tastes.</p>

<p>The later fully-working / opinionated frameworks (like Ruby/Rails) truly worked out of the box.  They would come up with a UI, Business/Domain
layer, and a Database layer.  You could add things to the UI and it would go down the whole stack.  Add things to the database
or Domain, and it would bubble up/down.  For the framework to do these things it had to have a model for what software (in its full form)
looks like.  These frameworks had patterns/templates/rules for building things at command.  This isn&#8217;t quite as good as Smalltalk (&#8220;it already exists&#8221;)
but it is getting close, especially with sample applications available.
It also gets rid of the one problem / hurdle with Smalltalk full-computers: you had to strip them
of things you didn&#8217;t want customers to see / use / clone.</p>

<h3>Languages</h3>

<p>There are many modern languages.  They are mostly quite similar and boring in the language themselves.  The community around the
language makes much more of a difference, and the libraries / frameworks that exist based on that community&#8217;s interest.</p>

<p>I mentioned that I switched to Java pretty early on, which cost me productivity.  But I wanted the community and their
libraries.  Java was popular enough that it had multiple communities associated with it.  Some were crazy stupid and
created things (even tried to mandate use of things) that were completely stupid.  But other communities continued
to plug along and evolve libraries and frameworks that are better than you can get in other languages.  On the whole,
I believe the Java ecosystem is by far the best &#8216;hub&#8217; to build most custom development and to pair
with other tools/components in other languages.  And by Java, I mean Java, Groovy, and potentially other JVM-targeting
languages.  The less Java-like the language, the less likely I would consider it acceptably an &#8216;other&#8217;.</p>

<h3>Framework</h3>

<p>I believe the best (general) application framework in Java is Grails, which lives on top of the Spring stack.  It is
very mature and has good minds in the drivers seat.  It gets simpler and more powerful every generation.  If Spring
does something right, Grails simply uses it.  If not, Grails augments it.  Very rational.  Very powerful.</p>

<h2>The first application</h2>

<p>The first application will simply be the default applications with a grails &#8216;create-app&#8217;.  To get the application we
need to get grails on the &#8216;app1&#8217; nodes, create the application, and then run it.</p>

<p>Grails needs Java, but ec2 instances automatically have that.  In other environments we would use something like:</p>

<h3>installJava.sh</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/bash</span>
</span><span class='line'><span class="c">#================================================</span>
</span><span class='line'><span class="c">#=== Java</span>
</span><span class='line'><span class="c">#================================================</span>
</span><span class='line'>
</span><span class='line'><span class="nb">export </span><span class="nv">JAVA_VERSION</span><span class="o">=</span>7u79
</span><span class='line'><span class="nb">export </span><span class="nv">JAVA_FULL_VERSION</span><span class="o">=</span>jdk-<span class="k">${</span><span class="nv">JAVA_VERSION</span><span class="k">}</span>-linux-x64
</span><span class='line'>
</span><span class='line'>mkdir -p .temp
</span><span class='line'>cp it/resource/<span class="k">${</span><span class="nv">JAVA_FULL_VERSION</span><span class="k">}</span>.rpm .temp/
</span><span class='line'>
</span><span class='line'>./bin/inflatePaths.sh .temp/<span class="k">${</span><span class="nv">JAVA_FULL_VERSION</span><span class="k">}</span>.rpm
</span><span class='line'>
</span><span class='line'>rpm -i .temp/<span class="k">${</span><span class="nv">JAVA_FULL_VERSION</span><span class="k">}</span>.rpm
</span></code></pre></td></tr></table></div></figure>


<p>The advantage of storing the RPM within our own system is speed of access and reliability.  EC2 to S3 communication
is very fast.  And S3 has never been down (AFAIK) at all, let alone when EC2 is running.  We also lock down on the
version we want vs. using &#8216;yum&#8217; without an explicit version.</p>

<h3>installGrails3_x.sh</h3>

<p>For grails we will get the latest version</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/bash</span>
</span><span class='line'><span class="c">#==========================================================</span>
</span><span class='line'><span class="c">#=== Install Grails 3.x</span>
</span><span class='line'><span class="c">#==========================================================</span>
</span><span class='line'>
</span><span class='line'>curl -s get.sdkman.io | bash
</span><span class='line'><span class="nb">source</span> <span class="s2">&quot;$HOME/.sdkman/bin/sdkman-init.sh&quot;</span>
</span><span class='line'>yes | sdk install grails
</span><span class='line'>
</span><span class='line'><span class="nb">source</span> ~/.bashrc
</span><span class='line'>grails -version
</span></code></pre></td></tr></table></div></figure>


<p>We need to source &#8216;~/.bashrc&#8217; so we get the additions to our path.</p>

<h3>Create &#8216;test&#8217; application</h3>

<p>At this point we have grails on the machine and can simply</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mkdir -p /root/app/
</span><span class='line'><span class="nb">cd</span> /root/app
</span><span class='line'>
</span><span class='line'>grails create-app <span class="nb">test</span>
</span><span class='line'><span class="nb">cd test</span>
</span><span class='line'>grails run-app
</span></code></pre></td></tr></table></div></figure>


<p>The application will come up at &#8216;localhost:8080&#8217; and if you wget/curl it, it returns the generated &#8216;index.html&#8217; file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="cp">&lt;!doctype html&gt;</span>
</span><span class='line'><span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">&quot;en&quot;</span> <span class="na">class=</span><span class="s">&quot;no-js&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;head&gt;</span>
</span><span class='line'>        <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;Content-Type&quot;</span> <span class="na">content=</span><span class="s">&quot;text/html; charset=UTF-8&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;X-UA-Compatible&quot;</span> <span class="na">content=</span><span class="s">&quot;IE=edge&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;title&gt;</span>Welcome to Grails<span class="nt">&lt;/title&gt;</span>
</span><span class='line'>        <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">&quot;viewport&quot;</span> <span class="na">content=</span><span class="s">&quot;width=device-width, initial-scale=1&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>...
</span><span class='line'>        <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;page-body&quot;</span> <span class="na">role=</span><span class="s">&quot;main&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>            <span class="nt">&lt;h1&gt;</span>Welcome to Grails<span class="nt">&lt;/h1&gt;</span>
</span><span class='line'>            <span class="nt">&lt;p&gt;</span>Congratulations, you have successfully started your first Grails application! At the moment
</span><span class='line'>               this is the default page, feel free to modify it to either redirect to a controller or display whatever
</span><span class='line'>               content you may choose. Below is a list of controllers that are currently deployed in this application,
</span><span class='line'>               click on each to execute its default action:<span class="nt">&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'>            <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;controller-list&quot;</span> <span class="na">role=</span><span class="s">&quot;navigation&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>                <span class="nt">&lt;h2&gt;</span>Available Controllers:<span class="nt">&lt;/h2&gt;</span>
</span><span class='line'>                <span class="nt">&lt;ul&gt;</span>
</span><span class='line'>
</span><span class='line'>                <span class="nt">&lt;/ul&gt;</span>
</span><span class='line'>            <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>
</span><span class='line'>        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;footer&quot;</span> <span class="na">role=</span><span class="s">&quot;contentinfo&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
</span><span class='line'>        <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;spinner&quot;</span> <span class="na">class=</span><span class="s">&quot;spinner&quot;</span> <span class="na">style=</span><span class="s">&quot;display:none;&quot;</span><span class="nt">&gt;</span>Loading<span class="ni">&amp;hellip;</span><span class="nt">&lt;/div&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/body&gt;</span>
</span><span class='line'><span class="nt">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Firewalls</h3>

<p>Unfortunately, you won&#8217;t be able to test this app from the outside unless you open the &#8216;8080&#8217; port.</p>

<p>If we open that port either initially or through commands:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;IpProtocol&quot;</span><span class="p">:</span><span class="s2">&quot;tcp&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;FromPort&quot;</span><span class="p">:</span><span class="s2">&quot;8080&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;ToPort&quot;</span><span class="p">:</span><span class="s2">&quot;8080&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;CidrIp&quot;</span><span class="p">:</span><span class="s2">&quot;0.0.0.0/0&quot;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We get the latest and greatest &#8216;Grails&#8217; application (3.0.8 as of this writing)</p>

<p><img src="http://markfussell.emenar.com/images/add-10/add10_grails1.png" /></p>

<h3>Demo2: PetClinic</h3>

<p>There is a PetClinic demo at: https://github.com/grails-samples/grails-petclinic .  Doing the same simple launch procedure you would get something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mkdir -p /root/app/
</span><span class='line'><span class="nb">cd</span> /root/app
</span><span class='line'>
</span><span class='line'>git clone git@github.com:grails-samples/grails-petclinic.git
</span><span class='line'><span class="nb">cd </span>grails-petclinic
</span><span class='line'>./gradlew run
</span></code></pre></td></tr></table></div></figure>


<p>And you get:</p>

<p><img src="http://markfussell.emenar.com/images/add-10/add10_grails2.png" /></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Advanced Development and Delivery (ADD) [Part-9]]]></title>
    <link href="http://markfussell.emenar.com/blog/add-9/"/>
    <updated>2015-10-08T02:00:00-07:00</updated>
    <id>http://markfussell.emenar.com/blog/add-9</id>
    <content type="html"><![CDATA[<p>This is the ninth installment of describing a radically more productive development and delivery environment.</p>

<p>The first part is here: <a href="http://markfussell.emenar.com/blog/add-1/">Intro</a>.  In the previous parts I described the big picture, Vagrant and EC2,
node initialization, the one minute configuration HeartBeat, HipChat integration, presence, EC2, and configuring nodes.</p>

<h2>Using Presence for configuration</h2>

<p>So far, presence has been just information that &#8216;humans&#8217; consume.  It shows up on dashboards, in chat rooms, and so on,
but nothing has acted upon it.  Until now!</p>

<p>We have &#8216;app&#8217; and &#8216;db&#8217; nodes.  Clearly the &#8216;app&#8217; nodes need to find the &#8216;db&#8217; nodes or the app is not going to be
able to persist much.  The &#8216;db&#8217; here happens to be &#8216;Maria&#8217; but it could be anything from a single DB node to a
cluster of Riak nodes.  At the moment, I just want to get the information that a &#8216;db&#8217; node knows (&#8220;I exist!&#8221;, &#8220;My IP is this!&#8221;)
over to the &#8216;app&#8217; nodes so they can process it.</p>

<h3>It is already there?</h3>

<p>But wait?  All nodes have &#8216;repo4&#8217; for writing?  Don&#8217;t they already have everything in &#8216;repo4&#8217; for reading as well?</p>

<p>And so they do.  The presence information is already there waiting patiently for somebody or someboty to read it.</p>

<!-- more -->


<p>As of this writing, repo4 looks like this:</p>

<p><img src="http://markfussell.emenar.com/images/add-9/add9_all.png" /></p>

<p>And the live hipchat still looks like this:</p>

<p><img src="http://markfussell.emenar.com/images/add-8/add8_demo1.png" /></p>

<p>So the DB server is definitely there:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>i-4e7cb59a:fed1/db1: Launched!</span></code></pre></td></tr></table></div></figure>


<p>And the information is there:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;filetype&quot;</span><span class="p">:</span> <span class="s2">&quot;nodepresence&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;a&quot;</span><span class="p">:</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;deployment&quot;</span><span class="p">:</span> <span class="s2">&quot;fed1&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;initgitrepo&quot;</span><span class="p">:</span> <span class="s2">&quot;repo2_petulant-cyril&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;instance-id&quot;</span><span class="p">:</span> <span class="s2">&quot;i-4e7cb59a&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;nodepart&quot;</span><span class="p">:</span> <span class="s2">&quot;db1&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;stacktype&quot;</span><span class="p">:</span> <span class="s2">&quot;lad1&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;done&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;statelog&quot;</span><span class="p">:</span> <span class="s2">&quot;setup:20151008-174646;initdone:20151008-174830;&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;statetss&quot;</span><span class="p">:</span> <span class="s2">&quot;20151008-174830&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>So the only issue is for nodes to &#8216;find their partners&#8217;</p>

<h3>Finding the partners</h3>

<p>By the HipChat there are only three nodes alive, so problem one is finding live nodes vs. dead nodes.  There are
two levels to that:</p>

<ul>
<li> Finding plausibly live nodes</li>
<li> Finding truly awake nodes</li>
</ul>


<p>The simplest approach to the first is to make sure there is some kind of heartbeat within &#8216;statetss&#8217;.  Every-minute
is clearly possible, but a bit noisy if done in the main part of repo4.  It would be nice to not to see the heartbeat
block out the actual state change information that is already there. An interesting alternative is to &#8216;flatten time&#8217;
and have an alternative branch that stores information as &#8216;it/presence/flattime/timestamp&#8217;.  Or given we are storing
the information differently, we could use the main branch and just change the comment to mention &#8216;flattime&#8217;.
Yes, the information in the files would not change very often.  But Git stores files separate from paths,
so there is very little overhead to adding new paths to identical files.</p>

<h4>Time flattened</h4>

<p>repo4 has folder under &#8216;presence&#8217; called &#8216;flattime&#8217; which contains the presence information where every checkin is a new path.
To keep things manageable the timestamp is complete &#8216;YYYYMMDDHHMM&#8217;, but year/month/day/hour/ is used to organize it.
Seconds are not used because we want everything to be together and there is no guarantee the seconds would match
between machines.</p>

<p>Looking at a few minutes of time, we get something like this:</p>

<p><img src="http://markfussell.emenar.com/images/add-9/add9_flattime1.png" /></p>

<p>The files change a bit because the machines are switching states and at the &#8216;capture&#8217; moment could be in almost any state
of their &#8216;state machine&#8217;.</p>

<h4>How precise?</h4>

<p>So this is quite precise in time and you could certainly slow it down.  Sometimes providers get annoyed if you use
git this way, but the software itself is thoroughly comfortable with it.  You can get some impressive merge graphs
as the machine count goes up.</p>

<p><img src="http://markfussell.emenar.com/images/add-9/add9_merge1.png" /></p>

<p>So making things less often and more jittered will help alleviate some stress.  Since
this is only the first stage of presence (what exists and is plausibly alive), we will deal with stale data in the
second stage.</p>

<h3>Who is what?</h3>

<p>So we have a directory of JSON files and we want to find certain kinds of partners.  It is simplest to just
run through all the files and see what is inside them.  The files can be loaded one-by-one or concatenated together
into a working temporary file.</p>

<p>A basic python script could look like this:</p>

<h4>buildLiveServerJson.py</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c">#!/usr/bin/env python</span>
</span><span class='line'>
</span><span class='line'><span class="c">#========================================================</span>
</span><span class='line'><span class="c">#=== buildLiveServerJson.py</span>
</span><span class='line'><span class="c">#=== This builds a JSON structure of server presence data</span>
</span><span class='line'><span class="c">#=== from a directory of presence data</span>
</span><span class='line'><span class="c">#=========================================================</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">json</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">string</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">os</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">sys</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">optparse</span> <span class="kn">import</span> <span class="n">OptionParser</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span><span class="n">timedelta</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
</span><span class='line'><span class="n">tss</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%Y%m</span><span class="si">%d</span><span class="s">%H%M%S&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="n">backminute</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'><span class="n">before</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="n">backminute</span>
</span><span class='line'>
</span><span class='line'><span class="n">tsm</span> <span class="o">=</span> <span class="n">before</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%Y%m</span><span class="si">%d</span><span class="s">%H%M&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">datepath</span> <span class="o">=</span> <span class="n">before</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%Y/%m/</span><span class="si">%d</span><span class="s">/%H&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="n">USAGE_STRING</span> <span class="o">=</span> <span class="s">&quot;usage: %prog [options]&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="n">parser</span> <span class="o">=</span> <span class="n">OptionParser</span><span class="p">(</span><span class="n">usage</span><span class="o">=</span><span class="n">USAGE_STRING</span><span class="p">)</span>
</span><span class='line'><span class="n">parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class='line'><span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;--source&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;store&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&quot;string&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;source&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&quot;The source directories of the presence files.  Use a comma to separate multiple source directories.&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;--adddatepath&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;adddatepath&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&quot;Whether to add the current datetime path to the source&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;--suffix&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;store&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&quot;string&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;suffix&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&quot;A suffix to add at the end of the source&quot;</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="n">source</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span class='line'><span class="n">adddatepath</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">adddatepath</span>
</span><span class='line'><span class="n">suffix</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">suffix</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="ow">not</span> <span class="n">source</span><span class="p">:</span>
</span><span class='line'>    <span class="n">parser</span><span class="o">.</span><span class="n">print_help</span><span class="p">()</span>
</span><span class='line'>    <span class="nb">exit</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="n">full_source</span> <span class="o">=</span> <span class="n">source</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">adddatepath</span><span class="p">:</span>
</span><span class='line'>   <span class="n">full_source</span> <span class="o">=</span> <span class="n">full_source</span> <span class="o">+</span> <span class="n">datepath</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="n">tsm</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">suffix</span><span class="p">:</span>
</span><span class='line'>   <span class="n">full_source</span> <span class="o">=</span> <span class="n">full_source</span> <span class="o">+</span> <span class="n">suffix</span>
</span><span class='line'>
</span><span class='line'><span class="c">#=========================================================</span>
</span><span class='line'><span class="c">#=========================================================</span>
</span><span class='line'><span class="c">#=========================================================</span>
</span><span class='line'>
</span><span class='line'><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;{&quot;source&quot;:&quot;&#39;</span><span class="o">+</span><span class="n">source</span><span class="o">+</span><span class="s">&#39;&quot;,&quot;suffix&quot;:&quot;&#39;</span><span class="o">+</span><span class="n">suffix</span><span class="o">+</span><span class="s">&#39;&quot;,&quot;full_source&quot;:&quot;&#39;</span><span class="o">+</span><span class="n">full_source</span><span class="o">+</span><span class="s">&#39;&quot;,&quot;tss&quot;:&quot;&#39;</span><span class="o">+</span><span class="n">tss</span><span class="o">+</span><span class="s">&#39;&quot;,&quot;tsm&quot;:&quot;&#39;</span><span class="o">+</span><span class="n">tsm</span><span class="o">+</span><span class="s">&#39;&quot;,&quot;datepath&quot;:&quot;&#39;</span><span class="o">+</span><span class="n">datepath</span><span class="o">+</span><span class="s">&#39;&quot;,&quot;nodes&quot;:[&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">isfirst</span> <span class="o">=</span> <span class="bp">True</span>
</span><span class='line'><span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">full_source</span><span class="p">):</span>
</span><span class='line'>  <span class="n">f_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">full_source</span><span class="o">+</span><span class="n">f</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="n">isfirst</span><span class="p">:</span>
</span><span class='line'>     <span class="n">isfirst</span> <span class="o">=</span> <span class="bp">False</span>
</span><span class='line'>  <span class="k">else</span><span class="p">:</span>
</span><span class='line'>     <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">f_json</span><span class="p">))</span>
</span><span class='line'><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;]}&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our first stage is to get a list of plausible nodes and store that:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>python buildLiveServerJson.py --source<span class="o">=</span>/root/gitrepo/repo4_sagacious-adventure/it/presence/flattime/ --adddatepath --suffix /all/ | python -mjson.tool &gt; /root/nodeinfo/liveserver.json
</span></code></pre></td></tr></table></div></figure>


<p><img src="http://markfussell.emenar.com/images/add-9/add9_json1.png" /></p>

<p>Next we can filter out the ones that don&#8217;t respond to our &#8216;awake&#8217; check.  That leaves
us with one or more remaining.  Depending on the kind of system you may actually want to know a bunch of nodes vs.
just one (e.g. ZooKeeper).</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Advanced Development and Delivery (ADD) [Part-8]]]></title>
    <link href="http://markfussell.emenar.com/blog/add-8/"/>
    <updated>2015-10-08T01:00:00-07:00</updated>
    <id>http://markfussell.emenar.com/blog/add-8</id>
    <content type="html"><![CDATA[<p>This is the eighth installment of describing a radically more productive development and delivery environment.</p>

<p>The first part is here: <a href="http://markfussell.emenar.com/blog/add-1/">Intro</a>.  In the previous parts I described the big picture, Vagrant and EC2,
node initialization, the one minute configuration HeartBeat, HipChat integration, presence, and EC2 integration.</p>

<h2>Configuring Node Parts and even fuller Presence and visibility</h2>

<p>So far our node was a generic &#8216;ControlNode&#8217;.  A ControlNode is a node that is in your data center
(to be near the other nodes), similar to your actual nodes, and configured to be able to do interesting tasks.
It is not a critical part of anything, so you can fiddle with it and just throw it away.  Say you want to
start configuring a database node.  You launch and login to a ControlNode and then try to install a database
(for example Maria).</p>

<!-- more -->




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>cat &gt; /etc/yum.repos.d/mariadb10.repo <span class="s">&lt;&lt;EOS</span>
</span><span class='line'><span class="s"># MariaDB 10.0 CentOS repository list - created 2015-10-08 15:16 UTC</span>
</span><span class='line'><span class="s"># http://mariadb.org/mariadb/repositories/</span>
</span><span class='line'><span class="s">[mariadb]</span>
</span><span class='line'><span class="s">name = MariaDB</span>
</span><span class='line'><span class="s">baseurl = http://yum.mariadb.org/10.0/centos7-amd64</span>
</span><span class='line'><span class="s">gpgkey=https://yum.mariadb.org/RPM-GPG-KEY-MariaDB</span>
</span><span class='line'><span class="s">gpgcheck=1</span>
</span><span class='line'><span class="s">EOS</span>
</span><span class='line'>
</span><span class='line'>yum install MariaDB-server MariaDB-client
</span></code></pre></td></tr></table></div></figure>


<p>Assuming you changed to root for the instance:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo bash
</span></code></pre></td></tr></table></div></figure>


<p>This works!  After confirming some things along the way&#8230;</p>

<p>OK, so now we want to have our database servers install MariaDB.  We first need an &#8216;installMaria&#8217; script with the above
in it.  Say</p>

<h3>installMaria10.sh</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/bash</span>
</span><span class='line'><span class="c">#================================================</span>
</span><span class='line'><span class="c">#=== Java</span>
</span><span class='line'><span class="c">#================================================</span>
</span><span class='line'>
</span><span class='line'>cat &gt; /etc/yum.repos.d/mariadb10.repo <span class="s">&lt;&lt;EOS</span>
</span><span class='line'><span class="s"># MariaDB 10.0 CentOS repository list - created 2015-10-08 15:16 UTC</span>
</span><span class='line'><span class="s"># http://mariadb.org/mariadb/repositories/</span>
</span><span class='line'><span class="s">[mariadb]</span>
</span><span class='line'><span class="s">name = MariaDB</span>
</span><span class='line'><span class="s">baseurl = http://yum.mariadb.org/10.0/centos7-amd64</span>
</span><span class='line'><span class="s">gpgkey=https://yum.mariadb.org/RPM-GPG-KEY-MariaDB</span>
</span><span class='line'><span class="s">gpgcheck=1</span>
</span><span class='line'><span class="s">EOS</span>
</span><span class='line'>
</span><span class='line'>yum install MariaDB-server MariaDB-client
</span></code></pre></td></tr></table></div></figure>


<h3>adding init</h3>

<p>And unless you want every node to install Maria, you need to add an &#8216;init&#8217; for the type of node we are dealing with.
In our case, the StackType is &#8216;lad1&#8217; (Load,App,Db,1) and the node type / part is &#8216;db1&#8217;.</p>

<p>So we get this hierarchy:</p>

<p><img src="http://markfussell.emenar.com/images/add-8/add8_hierarchy1.png" /></p>

<p>And the content of the &#8216;init.sh&#8217; file is simply:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/bash</span>
</span><span class='line'>
</span><span class='line'><span class="c">#====================================================</span>
</span><span class='line'><span class="c">#=== fed1/db1</span>
</span><span class='line'><span class="c">#====================================================</span>
</span><span class='line'>
</span><span class='line'>bash <span class="k">${</span><span class="nv">COMMON</span><span class="k">}</span>/installMaria10.sh
</span></code></pre></td></tr></table></div></figure>


<h3>CloudFormation</h3>

<p>We have a new CloudFormation named &#8216;awscf4_Fed1Db1&#8217; with the simple change of the nodepart being &#8216;db1&#8217;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="s2">&quot;TemplateConstant&quot;</span> <span class="err">:</span> <span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;stacktype&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="nt">&quot;value&quot;</span> <span class="p">:</span> <span class="s2">&quot;lad1&quot;</span> <span class="p">},</span>
</span><span class='line'>  <span class="nt">&quot;initgitrepo&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="nt">&quot;value&quot;</span> <span class="p">:</span> <span class="s2">&quot;repo2_petulant-cyril&quot;</span> <span class="p">},</span>
</span><span class='line'>  <span class="nt">&quot;nodepart&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="nt">&quot;value&quot;</span> <span class="p">:</span> <span class="s2">&quot;db1&quot;</span> <span class="p">},</span>
</span><span class='line'>  <span class="nt">&quot;state&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="nt">&quot;value&quot;</span> <span class="p">:</span> <span class="s2">&quot;presetup&quot;</span> <span class="p">},</span>
</span><span class='line'>  <span class="nt">&quot;statetss&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="nt">&quot;value&quot;</span> <span class="p">:</span> <span class="s2">&quot;&quot;</span> <span class="p">},</span>
</span><span class='line'>  <span class="nt">&quot;statelog&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="nt">&quot;value&quot;</span> <span class="p">:</span> <span class="s2">&quot;&quot;</span> <span class="p">},</span>
</span><span class='line'>  <span class="nt">&quot;deployment&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="nt">&quot;value&quot;</span> <span class="p">:</span> <span class="s2">&quot;fed1&quot;</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span><span class="err">,</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Demo or Die!</h3>

<p>Since the previous presence description, the presence system has upped itself and now nodes check-in with
more information than before.  After launching two &#8216;app&#8217; stack and one &#8216;db&#8217; stack we get this:</p>

<p><img src="http://markfussell.emenar.com/images/add-8/add8_demo1.png" /></p>

<p>So clearly our nodes know who they are, what deployment they are in, what the &#8216;part&#8217; in that deployment is, and how to
&#8220;do work&#8221;. But are they actually what they say they are?</p>

<h2>Being the &#8216;user&#8217;, fixing the &#8216;user&#8217;</h2>

<p>If you use the installMaria script above, it will not work.  Because I said: &#8220;This works!  After confirming some things along the way&#8230;&#8221;
During &#8216;boot&#8217; there is no user to confirm anything.  So the &#8216;yum&#8217; part fails although the yum repository is there
(the user is &#8216;root&#8217; so it has permission).  It ran the script but it didn&#8217;t work under &#8216;automation&#8217;.
The three annoying issues in automation:</p>

<ul>
<li> The user could be different from the user you think it is (say &#8216;ec2&#8217; vs. &#8216;root&#8217;)</li>
<li> The user is not interactive</li>
<li> The user did not &#8220;launch a login shell&#8221; and so some launch things that happen for you did not happen for them.</li>
</ul>


<p>There are trivial and super-effective solutions to all of these, but until you get them right, you can bang your head
quite a bit.</p>

<h3>Who is the user?  &#8216;root&#8217;</h3>

<p>The user provisioning a machine should always be &#8216;root&#8217;.  Yes, &#8216;root&#8217; is dangerous.  Because &#8216;root&#8217; is powerful.  And
given (a) if you mess up you simply kill the machine, and (b) everything is from version-controlled source files&#8230;
you can handle that power.  So don&#8217;t add silly hoops to jump through.  On a ControlNode, immediately &#8216;sudo bash&#8217;.
And if for some reason the default user isn&#8217;t &#8216;root&#8217; in a launch or cron script, &#8216;su root&#8217; or &#8216;sudo bash&#8217; to fix that.</p>

<h3>Is the user interactive? &#8216;no&#8217;</h3>

<p>We are doing production automation that is designed to scale into thousands of machines.  No one is going to answer
questions for thousands of machines.  That is not &#8216;scalable&#8217; or at all valuable.  You should always know all the
answers when a machine launches.  So script any UI that really requires some value put in, or use the variant of
a command that has default answers.</p>

<p>The true script for &#8216;installMaria&#8217; has this line.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>yes | yum -y install MariaDB-server MariaDB-client
</span></code></pre></td></tr></table></div></figure>


<p>The &#8216;yum -y&#8217; <em>should</em> never ask any questions.  But just in case it does, I give it a &#8216;y&#8217; for every answer.  If you
are testing something and get a question, check if it has a flag like &#8216;-y&#8217;</p>

<p><img src="http://markfussell.emenar.com/images/add-8/add8_yes.png" /></p>

<h3>Has the user launch as a login shel? &#8216;yes&#8217;</h3>

<p>Since getting on a machine without &#8216;logging in&#8217; is quite a bit more painful than &#8216;ssh&#8217; into the machine, just make sure
any &#8216;init&#8217; and &#8216;work&#8217; script has read the files a login shell would automatically read.</p>

<p>A simple &#8216;source /root/.bashrc&#8217; fixes the problem immediately</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#========================================</span>
</span><span class='line'><span class="c">#=== Do the work for this repository</span>
</span><span class='line'><span class="c">#========================================</span>
</span><span class='line'>
</span><span class='line'><span class="nb">source</span> /root/.bashrc
</span><span class='line'>...
</span></code></pre></td></tr></table></div></figure>


<h2>Node Work</h2>

<p>Just like the &#8216;init&#8217; hierarchy, the &#8216;db1&#8217; nodes can have their own work items to do regularly by simply adding the &#8216;work.sh&#8217;
into the hierarchy:</p>

<p><img src="http://markfussell.emenar.com/images/add-8/add8_hierarchy2.png" /></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Advanced Development and Delivery (ADD) [Part-7]]]></title>
    <link href="http://markfussell.emenar.com/blog/add-7/"/>
    <updated>2015-10-04T01:00:00-07:00</updated>
    <id>http://markfussell.emenar.com/blog/add-7</id>
    <content type="html"><![CDATA[<p>This is the seventh installment of describing a radically more productive development and delivery environment.</p>

<p>The first part is here: <a href="http://markfussell.emenar.com/blog/add-1/">Intro</a>.  In the previous parts I described the big picture, Vagrant and EC2,
node initialization, the one minute configuration HeartBeat, HipChat integration, and presence.</p>

<h2>Fuller Presence and EC2 Integration</h2>

<p>In the previous part, I went through a very simple but powerful model of &#8216;presence&#8217; using simply GitHub repositories.
The content of those presence statements was enough to figure out what nodes exist, but not much more about them.
The second level of presence is to update the state of the node as it changes.  For example, a node goes through
a few bootstrap steps:</p>

<ul>
<li> presetup – The node before any updates are possible (no ability to change status)</li>
<li> setup – The beginning of the &#8216;setup&#8217; phase where the node is alive enough to change it&#8217;s status</li>
<li> initdone – The time a node is done are initialization and can start doing &#8216;work&#8217; as the &#8216;nodepart&#8217; it is</li>
</ul>


<p>A node getting to &#8216;setup&#8217; is pretty important: before that it may be a zombie!  And we don&#8217;t want zombie&#8217;s in
our federation!</p>

<!-- more -->


<p>So far for the ADD we now have four resources within which track node states:</p>

<ul>
<li> On the node (say &#8216;/root/log&#8217; or &#8216;/root/nodeinfo/state.txt)</li>
<li> Within the presence system</li>
<li> Within HipChat</li>
<li> On EC2 itself</li>
</ul>


<p>I recommend using <em>all</em> of them.</p>

<h3>On node</h3>

<p> On the node is very helpful in that it is isolated from any other failures.  You
 can &#8216;tail&#8217; the logs or &#8216;cat&#8217; the state file.  This tangibility helps understand things and debug if there is failure.</p>

<h3>Within Presence</h3>

<p> Within the presence system is the most powerful and flexible.  It is easy to see history and all the activity of your
 nodegrid.  And the nodegrid can use the presence system to figure out what nodes are present and in full &#8216;working&#8217;
 mode.</p>

<h3>HipChat</h3>

<p> Within HipChat lets everyone see and talk about the changes.  It can get noisy though, so you need
 to separate the &#8216;chatty&#8217; state changes from the &#8216;critical&#8217; ones.  An example of &#8216;critical&#8217; is when a machine realizes
 it is broken.  It is running the cron job, but something is wrong and it can tell that the &#8216;work&#8217; is not completable.
 I call this being &#8216;wedged&#8217;.  If a machine is &#8216;wedged&#8217;, it should tell people and then we can work on improving its
 DNA so it can unwedge itself in the future.  And then kill the machine.</p>

<h3>EC2</h3>

<p> By using EC2 tags you can leverage the EC2 dashboard.  I view &#8216;tags&#8217; as read-only because the ADD should not get
 attached (be dependent) on EC2, but it is helpful for visibility.</p>

<h3>Examples</h3>

<p>The following show two machines initializing through Presence, HipChat, and EC2.  The only trigger for this was
killing the existing two instances: the AutoScalingGroup automatically replaced them.</p>

<h4>Launching viewed within EC2 Dashboard</h4>

<p>Nicely the &#8216;add:&#8217; prefix makes all the properties that are most important appear on the left.  Some of the names
of concepts are intentionally alphabetically &#8216;sorted&#8217; so they appear in the correct column.</p>

<p><img src="http://markfussell.emenar.com/images/add-7/add7_ec2_cv1b.png" /></p>

<p>Click here: <a target="add7_ec2_cv1b" href="http://markfussell.emenar.com/images/add-7/add7_ec2_cv1b.png" >add7_ec2_cv1b</a> to expand.</p>

<p>The ‘stacktype’ of ‘lad1’ in the capture is short for a stack of</p>

<ul>
<li>Load Balancer</li>
<li>Application</li>
<li>Database</li>
</ul>


<h4>Working viewed within HipChat</h4>

<p><img src="http://markfussell.emenar.com/images/add-7/add7_hipchat_cv1.png" /></p>

<h4>Working viewed within Presence / SourceTree</h4>

<p><img src="http://markfussell.emenar.com/images/add-7/add7_presence_cv1.png" /></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Advanced Development and Delivery (ADD) [Part-6]]]></title>
    <link href="http://markfussell.emenar.com/blog/add-6/"/>
    <updated>2015-10-02T01:00:00-07:00</updated>
    <id>http://markfussell.emenar.com/blog/add-6</id>
    <content type="html"><![CDATA[<p>This is the sixth installment of describing a radically more productive development and delivery environment.</p>

<p>The first part is here: <a href="http://markfussell.emenar.com/blog/add-1/">Intro</a>.  In the previous parts I described the big picture, Vagrant and EC2,
node initialization, the one minute configuration HeartBeat, and HipChat integration.</p>

<h2>&#8216;Part&#8217; Provisioning</h2>

<p>Each node plays a singular &#8216;Part&#8217;.  A &#8216;part&#8217; is a unique combination of roles (in the chef sense) that identifies
exactly how the node should be provisioned, usually globally, but at least for each stacktype.  A standard array
of parts would be the LAMP stack:</p>

<ul>
<li> Load Balancer (lb)</li>
<li> Application Server (app)</li>
<li> Database Server  (db)</li>
</ul>


<!-- more -->


<p>The most interesting thing about parts is hooking them together.  Load balancers need to know about application servers.
Application servers need to know where the databases are.  This feature I call &#8216;presence&#8217;.  There are a lot
of fancy ways to solve &#8216;presence&#8217;.  There could be &#8216;presence&#8217; servers that servers register with.  Or &#8216;presence&#8217; servers
that poll AWS registries.  Certain products keep their &#8216;CI&#8217; (Configuration Item) information in databases: both SQL and
other kinds.</p>

<p>All of this is stupidly complex and treats the nodes as if they are idiots.  Pretty sure these nodes can be made about
as smart as a young student (say elementary school or even younger).  A young person is perfectly capable of putting
their name on a list.  And then listing some other interesting things about them.  A node can do the same.  So all
we need is a list.  The classic list for a computer?  A folder.  A folder containing files.  A file named after a node&#8217;s
unique name.  And a file containing information about the node.  Voila.  No SPOF (can have two folders stored differently),
and no additional nodes doing something stupidly simple.</p>

<h2>Demo or Die!</h2>

<p>So we already have a &#8216;HeartBeat&#8217; server, all we need are for it to write somewhere what it&#8217;s state is.  That is
quite simple:</p>

<h3>updatePresence.sh</h3>

<p>This simply writes information in ~/nodeinfo into a JSON file.  To make that JSON file a little nicer we python
format it.  What gets written into the JSON file?  Basically anything we want!  When?  Every minute!  Ta Da&#8230;
the trick is done.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/bash</span>
</span><span class='line'>
</span><span class='line'>...
</span><span class='line'>
</span><span class='line'><span class="c">#====================================================</span>
</span><span class='line'><span class="c">#=== Generate file</span>
</span><span class='line'><span class="c">#====================================================</span>
</span><span class='line'>
</span><span class='line'><span class="nb">export </span><span class="nv">INSTANCE_ID</span><span class="o">=</span><span class="s2">&quot;`cat /root/nodeinfo/instance-id.txt`&quot;</span>
</span><span class='line'><span class="nb">echo</span> <span class="nv">$INSTANCE_ID</span>
</span><span class='line'>
</span><span class='line'>cat <span class="s">&lt;&lt;EOS &gt;&gt;$PRESENCE_TEMP</span>
</span><span class='line'><span class="s">{</span>
</span><span class='line'><span class="s">&quot;filetype&quot;:&quot;nodepresence&quot;,</span>
</span><span class='line'><span class="s">&quot;value&quot;: {</span>
</span><span class='line'><span class="s">    &quot;a&quot;:&quot;a&quot;</span>
</span><span class='line'><span class="s">EOS</span>
</span><span class='line'>
</span><span class='line'><span class="nv">FILES</span><span class="o">=(</span> <span class="s2">&quot;initgitrepo&quot;</span> <span class="s2">&quot;instance-id&quot;</span> <span class="s2">&quot;nodepart&quot;</span> <span class="s2">&quot;stacktype&quot;</span> <span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">for </span>i in <span class="s2">&quot;${FILES[@]}&quot;</span>
</span><span class='line'><span class="k">do</span>
</span><span class='line'><span class="k">    </span>cat <span class="s">&lt;&lt;EOS &gt;&gt;$PRESENCE_TEMP</span>
</span><span class='line'><span class="s">    ,</span>
</span><span class='line'><span class="s">    &quot;$i&quot;:&quot;`cat /root/nodeinfo/${i}.txt`&quot;</span>
</span><span class='line'><span class="s">EOS</span>
</span><span class='line'><span class="k">done</span>
</span><span class='line'>
</span><span class='line'>cat <span class="s">&lt;&lt;EOS &gt;&gt;$PRESENCE_TEMP</span>
</span><span class='line'><span class="s">}</span>
</span><span class='line'><span class="s">}</span>
</span><span class='line'><span class="s">EOS</span>
</span><span class='line'>
</span><span class='line'>cat <span class="nv">$PRESENCE_TEMP</span> | python -mjson.tool &gt; <span class="nv">$PRESENCE_TEMP2</span>
</span><span class='line'>cat <span class="nv">$PRESENCE_TEMP2</span>
</span><span class='line'>
</span><span class='line'><span class="c">#| bash ${COMMON}/send_hipchat.sh -c green</span>
</span><span class='line'>
</span><span class='line'><span class="c">#====================================================</span>
</span><span class='line'><span class="c">#=== Switch to the presence repository and copy file</span>
</span><span class='line'><span class="c">#====================================================</span>
</span><span class='line'>
</span><span class='line'><span class="nb">pushd</span> <span class="nv">$REPO_ROOT</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> ! -d <span class="s2">&quot;$PRESENCE_REPO&quot;</span> <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">  </span><span class="nb">echo</span> <span class="s2">&quot;git clone git@github.com:shaklee/${PRESENCE_REPO}.git&quot;</span>
</span><span class='line'>  git clone git@github.com:shaklee/<span class="k">${</span><span class="nv">PRESENCE_REPO</span><span class="k">}</span>.git
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> -d <span class="s2">&quot;$PRESENCE_REPO&quot;</span> <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">  </span><span class="nb">cd</span> <span class="nv">$PRESENCE_REPO</span>
</span><span class='line'>  git pull
</span><span class='line'>
</span><span class='line'>  <span class="c">#Now splat it out to all the proper places</span>
</span><span class='line'>  <span class="nv">TARGETS</span><span class="o">=(</span> <span class="s2">&quot;it/presence/all&quot;</span> <span class="o">)</span>
</span><span class='line'>  <span class="k">for </span>i in <span class="s2">&quot;${TARGETS[@]}&quot;</span>
</span><span class='line'>  <span class="k">do</span>
</span><span class='line'><span class="k">    </span>mkdir -p <span class="nv">$i</span>
</span><span class='line'>    cp -f <span class="nv">$PRESENCE_TEMP2</span> <span class="nv">$i</span>/<span class="k">${</span><span class="nv">INSTANCE_ID</span><span class="k">}</span>.json
</span><span class='line'>  <span class="k">done</span>
</span><span class='line'>
</span><span class='line'><span class="k">  </span>git add .
</span><span class='line'>  git commit -m <span class="s2">&quot;Updated by $INSTANCE_ID&quot;</span>; git push
</span><span class='line'>  <span class="c">#Now need to see if this works... but the following is an easy trick in the small</span>
</span><span class='line'>  git pull; git push; git pull; git push
</span><span class='line'>
</span><span class='line'>  <span class="c">#Repeat until push succeeds</span>
</span><span class='line'><span class="k">else</span>
</span><span class='line'><span class="k">  </span><span class="nb">echo</span> <span class="s2">&quot;Not working!&quot;</span>
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="nb">popd</span>
</span></code></pre></td></tr></table></div></figure>


<p>And with the above script we get this simple and beautiful view:</p>

<p><img src="http://markfussell.emenar.com/images/add-6/add6_sourceTree_cv1.png" /></p>

<h2>Collisions</h2>

<p>OK, updating a GitHub repository every minute is not the smartest thing to do at scale&#8230; but: if the file
is the same, Git won&#8217;t do anything.  And if we want, we can always turn down the noise.</p>

<h2>Death</h2>

<p>A machine can die or be killed, so presence information could be out of date.  The solution is just to
broadcast a &#8216;HeartBeat&#8217; in either the presence repository or another repository.  Or to make sure to
check if the machine is actually responsive (e.g. HAProxy will interact with the machine to make sure it
is actually alive) vs. being present.  This final interaction is pretty critical (no Zombies in my data center),
so that is the best way to figure out who is alive and alert vs. just being present.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Advanced Development and Delivery (ADD) [Part-5]]]></title>
    <link href="http://markfussell.emenar.com/blog/add-5/"/>
    <updated>2015-10-02T01:00:00-07:00</updated>
    <id>http://markfussell.emenar.com/blog/add-5</id>
    <content type="html"><![CDATA[<p>This is the fifth installment of describing a radically more productive development and delivery environment.</p>

<p>The first part is here: <a href="http://markfussell.emenar.com/blog/add-1/">Intro</a>.  In the previous parts I described the big picture, Vagrant and EC2,
node initialization, and the one minute configuration HeartBeat.</p>

<h2>HipChat</h2>

<p>The fourth ingredient to the ADD is HipChat.  HipChat is meant to help people communicate and see the state of the world.
It is an excellent communication program with a plethora of integrations.  But for ADD the critical capability is
to mix notifications of machines with communication between people.  You can also have it be used to drive the ADD
system (kind of like a command line) but that isn&#8217;t very important since it would just make changes in GitHub
which can be made in lots of different ways.</p>

<p>The demo of this is very simple:</p>

<p><img src="http://markfussell.emenar.com/images/add-5/add5_hipchat_cv1.png" /></p>

<!-- more -->


<p>The GitHub part is an integration that works out of the box, and the AddBot1 notification is a minor addition
to the working script:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">echo</span> <span class="s2">&quot;Doing the work for ${GIT_VERSION}&quot;</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;Doing the work for ${GIT_VERSION}&quot;</span> | bash <span class="k">${</span><span class="nv">COMMON</span><span class="k">}</span>/send_hipchat.sh
</span><span class='line'>sleep 121
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;Done the work for ${GIT_VERSION}&quot;</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;Done the work for ${GIT_VERSION}&quot;</span> | bash <span class="k">${</span><span class="nv">COMMON</span><span class="k">}</span>/send_hipchat.sh -c green
</span></code></pre></td></tr></table></div></figure>


<p>So now we have &#8216;Action in GitHub&#8217; and visibility to all the activities of the machines that reacted to
that action.  Finally we can have human augmentation like &#8220;@Team New version is up on the development server&#8221;
to transform something technical to something more meaningful.  With proper use of colors, the state
of the world is fairly well communicated at a glance (e.g. Reds, Yellows, Greens, and Blues).</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Advanced Development and Delivery (ADD) [Part-4]]]></title>
    <link href="http://markfussell.emenar.com/blog/add-4/"/>
    <updated>2015-10-01T03:00:00-07:00</updated>
    <id>http://markfussell.emenar.com/blog/add-4</id>
    <content type="html"><![CDATA[<p>This is the fourth installment of describing a radically more productive development and delivery environment.</p>

<p>The first part is here: <a href="http://markfussell.emenar.com/blog/add-1/">Intro</a>.  In the previous parts I described the big picture and the Vagrant and EC2 bootstrap.</p>

<h2>Node initialization</h2>

<p>The previous parts described getting Vagrant and EC2 to have an operational node.  For Vagrant it leverages &#8216;host&#8217; virtual
disk access to configure and bootstrap itself.  For EC2, it leverages CloudFormation to configure and bootstrap itself.
In both cases the very last thing the node does in the bootstrap is:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">cd</span> /root/gitrepo/<span class="sb">`</span>cat /root/nodeinfo/initgitrepo.txt<span class="sb">`</span>
</span><span class='line'>include <span class="o">()</span> <span class="o">{</span> <span class="k">if</span> <span class="o">[[</span> -f <span class="se">\&quot;</span><span class="nv">$1</span><span class="se">\&quot;</span> <span class="o">]]</span>; <span class="k">then </span><span class="nb">source</span> <span class="se">\&quot;</span><span class="nv">$1</span><span class="se">\&quot;</span>; <span class="k">else </span><span class="nb">echo</span> <span class="se">\&quot;</span>Skipped missing: <span class="nv">$1</span><span class="se">\&quot;</span>; <span class="k">fi</span> <span class="o">}</span>
</span><span class='line'>include it/nodeinit/common/init.sh
</span></code></pre></td></tr></table></div></figure>




<!-- more -->


<p>It is an &#8216;include/source&#8217; to make sure it is at the same level as the initial bootstrap script.  For EC2 this affects
logging, so continual sourcing is preferred.  In other cases, the &#8216;source&#8217; enables sub-scripts to set values for subsequent
scripts where subshells are more isolated.</p>

<h3>init.sh</h3>

<p>The init script first figures out where it is and sets up some important paths.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/bash</span>
</span><span class='line'>
</span><span class='line'><span class="c">#===================================================</span>
</span><span class='line'><span class="c">#=== Want DIR to be root of the &#39;nodeinit&#39; directory</span>
</span><span class='line'><span class="c">#===================================================</span>
</span><span class='line'>
</span><span class='line'><span class="nb">export </span><span class="nv">DIR</span><span class="o">=</span><span class="s2">&quot;$( cd -P &quot;</span><span class="k">$(</span> dirname <span class="s2">&quot;${BASH_SOURCE[0]}&quot;</span> <span class="k">)</span><span class="s2">&quot; &amp;&amp; pwd )/../&quot;</span>
</span><span class='line'><span class="nb">export </span><span class="nv">RESOURCE</span><span class="o">=</span><span class="k">${</span><span class="nv">DIR</span><span class="k">}</span>/resource
</span><span class='line'><span class="nb">export </span><span class="nv">COMMON</span><span class="o">=</span><span class="k">${</span><span class="nv">DIR</span><span class="k">}</span>/common
</span></code></pre></td></tr></table></div></figure>


<h3>cron_1m.sh</h3>

<p>It then gets some AWS resources, sets up a shared &#8216;cron&#8217;, and so on.  I like a single &#8216;cron&#8217; job running every minute
so it is easy to understand what is going on.  This is the &#8216;heartbeat&#8217; of the server configuration infrastructure: a
server can want to change any &#8216;minute&#8217;.  They look every minute for something that makes them want to change and
then they launch an activity.  The look need to be fast: take about a second or two per &#8216;look&#8217; and not cause much load.
But the &#8216;change&#8217; does not have to be fast: it could take minutes to reconfigure based on the change.  So while
changing, the &#8216;looking&#8217; is disabled.  For example, deploying a new WAR can take a while.  The server stops looking
for new WARs when deploying a WAR.  Then starts looking again when it is back online.</p>

<p>At scale (say 100 servers) with servers all on NTP this one-minute rhythm can cause resource rushing.  To
counter that we need to &#8216;jitter&#8217; the servers so they work on a different
second of the minute, or even as much as minutes later at super-scale (1000 servers).
That is done within the cron_1m.sh script after the look has established something needs to be done.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mkdir -p /root/bin
</span><span class='line'>cp <span class="k">${</span><span class="nv">RESOURCE</span><span class="k">}</span>/cron_1m.sh /root/bin/cron_1m.sh
</span><span class='line'>chmod +x /root/bin/cron_1m.sh
</span><span class='line'>
</span><span class='line'>cat <span class="s">&lt;&lt;EOS &gt; /var/spool/cron/root</span>
</span><span class='line'><span class="s">MAILTO=&quot;&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="s">* * * * *  /root/bin/cron_1m.sh</span>
</span><span class='line'><span class="s">EOS</span>
</span></code></pre></td></tr></table></div></figure>


<h3>More specific initialization</h3>

<p>The above activities are done for any node.  They all need to have heartbeats and some other common resources.
But beyond that, it depends on the type of node and the type of stack what should be put on a particular node.
This is done by simple &#8216;includes&#8217; with the &#8216;nodeinfo&#8217; that came from the configuration.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>include <span class="k">${</span><span class="nv">DIR</span><span class="k">}</span>part/<span class="sb">`</span>cat /root/nodeinfo/nodepart.txt<span class="sb">`</span>/init.sh
</span><span class='line'>include <span class="k">${</span><span class="nv">DIR</span><span class="k">}</span>stacktype/<span class="sb">`</span>cat /root/nodeinfo/stacktype.txt<span class="sb">`</span>/init.sh
</span><span class='line'>include <span class="k">${</span><span class="nv">DIR</span><span class="k">}</span>stacktype/<span class="sb">`</span>cat /root/nodeinfo/stacktype.txt<span class="sb">`</span>/part/<span class="sb">`</span>cat /root/nodeinfo/nodepart.txt<span class="sb">`</span>/init.sh
</span></code></pre></td></tr></table></div></figure>


<p>You can see the layout in the directory picture.</p>

<p><img src="http://markfussell.emenar.com/images/add-2/vag1_20151001b.png" /></p>

<p>As of that picture, no &#8216;part&#8217; or &#8216;stacktype&#8217; exists.  So a machine that is brought up is simply a heart-beating server,
but a heart-beating server that can mutate on command every minute.</p>

<h2>What are nodes doing every minute?</h2>

<p>The next cool feature of ADD is that nodes do work based on the state of git repositories.  For any given repository, they
look for a &#8216;work.sh&#8217; file within a &#8216;nodework&#8217; directory for either all types of nodes (i.e. common again), or the specific
type of node they are.  So just like the other &#8216;include&#8217; we get:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>        bash_ifexist bin/nodework/common/work.sh
</span><span class='line'>        bash_ifexist bin/nodework/part/<span class="sb">`</span>cat /root/nodeinfo/nodepart.txt<span class="sb">`</span>/work.sh
</span><span class='line'>        bash_ifexist bin/nodework/stacktype/<span class="sb">`</span>cat /root/nodeinfo/stacktype.txt<span class="sb">`</span>/work.sh
</span><span class='line'>        bash_ifexist bin/nodework/stacktype/<span class="sb">`</span>cat /root/nodeinfo/stacktype.txt<span class="sb">`</span>/part/<span class="sb">`</span>cat /root/nodeinfo/nodepart.txt<span class="sb">`</span>/work.sh
</span></code></pre></td></tr></table></div></figure>


<p>where the only change is these are not &#8216;sourced&#8217; but executed within a sub-shell since they could do weird things to each other, and
also this enables them not to block each other (if desired).</p>

<p>All of these &#8216;work&#8217; scripts should quickly determine if anything has changed and then release themselves.  While &#8216;work&#8217; is going on,
 the main cron script is locked out.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>     <span class="k">if</span> <span class="o">[[</span> -e <span class="k">${</span><span class="nv">CURRENT_ACTION_FILE</span><span class="k">}</span> <span class="o">]]</span>; <span class="k">then</span>
</span><span class='line'>         : <span class="c">#Don&#39;t do anything until the current action completes</span>
</span></code></pre></td></tr></table></div></figure>


<h3>work.sh</h3>

<p>The main purpose of &#8216;work.sh&#8217; is to detect changes.  Any actual work will be in &#8216;work_ActualWork.sh&#8217;.  In reverse, the ActualWork is
simply:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">echo</span> <span class="s2">&quot;Doing the work for ${GIT_VERSION}&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>So a one-liner appears in the log for the cron job just to prove the &#8216;ActualWork&#8217; was done.</p>

<p>But &#8216;work.sh&#8217; has to do a few things (very quickly) to detect if there are changes of relevance.  It stores files in the &#8216;repo/.temp/add&#8217;
directory that keeps track of state.  The example &#8216;work.sh&#8217; will detect changes to the repository based on a watched &#8216;path&#8217;.  This
allows multiple things to use the same git repository but be looking at different parts.  By default they look at the root, but it
can be changed.  No matter what &#8216;path&#8217; is watched, the version of the &#8216;work&#8217; is always the version of the git repository&#8230; not the path itself.
In total, there are four &#8216;outer&#8217; states possible:</p>

<ul>
<li>The version of the work previously done is identical to the version of git now</li>
<li>The version of the work previously done is different from the version of git now, but the version of the watched path is the same</li>
<li>The version of the work previously done is different from the version of git now, and the watched path has changed</li>
<li>There is no work previously done (the first run of the work)</li>
</ul>


<p>Of the above, only the last two should trigger work.  You can branch differently based on the first run or subsequent runs, but
generally it is best to be &#8216;idempotent&#8217; with the work: you change the state of the server to a new state without caring
what the previous state is/was.</p>

<p>The &#8216;inner&#8217; state issue is the server could already be doing &#8216;ActualWork&#8217;, so you have to wait until that is done.</p>

<p>The core of the work.sh script is</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">export </span><span class="nv">WORK_VERSION</span><span class="o">=</span><span class="nv">$ADD_TEMP</span>/work.sh_VERSION
</span><span class='line'><span class="nb">export </span><span class="nv">WORK_DOING_VERSION</span><span class="o">=</span><span class="nv">$ADD_TEMP</span>/work.sh_DOING_VERSION
</span><span class='line'><span class="nb">export </span><span class="nv">WORK_WATCH_PATH</span><span class="o">=</span><span class="nv">$ADD_TEMP</span>/work.sh_WATCH_PATH.txt
</span><span class='line'>
</span><span class='line'><span class="nb">export </span><span class="nv">WORK_WATCH_VALUE</span><span class="o">=</span><span class="sb">`</span>cat <span class="nv">$WORK_WATCH_PATH</span><span class="sb">`</span>
</span><span class='line'><span class="nb">export </span><span class="nv">PREV_WORK_VERSION</span><span class="o">=</span><span class="sb">`</span>cat <span class="nv">$WORK_VERSION</span><span class="sb">`</span>
</span><span class='line'>
</span><span class='line'><span class="c">#====================================================</span>
</span><span class='line'><span class="c">#=== Now do comparison</span>
</span><span class='line'><span class="c">#====================================================</span>
</span><span class='line'>
</span><span class='line'><span class="nb">export </span><span class="nv">GIT_VERSION</span><span class="o">=</span><span class="sb">`</span>git rev-parse HEAD<span class="sb">`</span>
</span><span class='line'>
</span><span class='line'><span class="nb">export </span><span class="nv">DETECT_GIT_CHANGE</span><span class="o">=</span><span class="sb">`</span>git log --pretty<span class="o">=</span>oneline <span class="k">${</span><span class="nv">PREV_WORK_VERSION</span><span class="k">}</span>..  -- <span class="k">${</span><span class="nv">WORK_WATCH_VALUE</span><span class="k">}</span> | awk <span class="s1">&#39;{print $1}&#39;</span><span class="sb">`</span>
</span><span class='line'>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;Compared ${PREV_WORK_VERSION} to ${GIT_VERSION} for ${WORK_WATCH_VALUE} and got ${DETECT_GIT_CHANGE}&quot;</span>
</span><span class='line'>
</span><span class='line'>mkdir -p <span class="k">${</span><span class="nv">ADD_TEMP</span><span class="k">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;${DETECT_GIT_CHANGE}&quot;</span> <span class="o">]]</span> ;
</span><span class='line'><span class="k">then</span>
</span><span class='line'><span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;Detected Change in Git Version!&quot;</span>;
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="o">[[</span> -e <span class="k">${</span><span class="nv">WORK_DOING_VERSION</span><span class="k">}</span> <span class="o">]]</span> ;
</span><span class='line'>    <span class="k">then</span>
</span><span class='line'><span class="k">       </span><span class="nb">echo</span> <span class="s2">&quot;Already doing `cat ${WORK_DOING_VERSION}`&quot;</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'><span class="k">       </span><span class="nb">echo</span> <span class="nv">$GIT_VERSION</span> &gt; <span class="k">${</span><span class="nv">WORK_DOING_VERSION</span><span class="k">}</span>
</span><span class='line'>       <span class="nb">source</span> <span class="k">${</span><span class="nv">COMMON</span><span class="k">}</span>/work_ActualWork.sh
</span><span class='line'>
</span><span class='line'>       <span class="c">#Update the state.  This also does a clean startup on first run</span>
</span><span class='line'>
</span><span class='line'>       <span class="nb">echo</span> <span class="nv">$GIT_VERSION</span> &gt; <span class="k">${</span><span class="nv">WORK_VERSION</span><span class="k">}</span>
</span><span class='line'>       <span class="nb">echo</span> <span class="nv">$WORK_WATCH_VALUE</span> &gt; <span class="k">${</span><span class="nv">WORK_WATCH_PATH</span><span class="k">}</span>
</span><span class='line'>
</span><span class='line'>       rm -fr <span class="k">${</span><span class="nv">WORK_DOING_VERSION</span><span class="k">}</span>
</span><span class='line'>    <span class="k">fi</span>
</span><span class='line'><span class="k">else</span>
</span><span class='line'><span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;No change, move along&quot;</span>;
</span><span class='line'><span class="k">fi</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Speed!</h3>

<p>How fast does this detection take? Basically one second for it to figure out which of the variations it is in, plus the time of the &#8216;git pull&#8217;.  With a
&#8216;small&#8217; server and a small change, this a single second and basically no load:</p>

<h4>Difference detected: start the work</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>cron_1m.sh: Start  20151002-013401
</span><span class='line'>~/gitrepo/repo2_petulant-cyril ~
</span><span class='line'>
</span><span class='line'><span class="o">==</span>&gt; /root/log/cron_1m.sh_error.txt &lt;<span class="o">==</span>
</span><span class='line'>From github.com:shaklee/repo2_petulant-cyril
</span><span class='line'>   57f20ff..6f85e76  master     -&gt; origin/master
</span><span class='line'>
</span><span class='line'><span class="o">==</span>&gt; /root/log/cron_1m.sh_log.txt &lt;<span class="o">==</span>
</span><span class='line'>Updating 57f20ff..6f85e76
</span><span class='line'>Fast-forward
</span><span class='line'> bin/nodework/common/work.sh | 2 ++
</span><span class='line'> 1 file changed, 2 insertions<span class="o">(</span>+<span class="o">)</span>
</span><span class='line'>Compared 57f20ff734c8836fa34f938bcc540a89bad9215c to 6f85e76a507ce599f42762ad7bf4ae639884ae12 <span class="k">for  </span>and got 6f85e76a507ce599f42762ad7bf4ae639884ae12
</span><span class='line'>Detected Change in Git Version!
</span><span class='line'>Starting ActualWork at 20151002-013402
</span><span class='line'>Doing the work <span class="k">for </span>6f85e76a507ce599f42762ad7bf4ae639884ae12
</span></code></pre></td></tr></table></div></figure>


<h4>Difference detected (but already doing something)</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>cron_1m.sh: Start  20151002-012301
</span><span class='line'>~/gitrepo/repo2_petulant-cyril ~
</span><span class='line'>Already up-to-date.
</span><span class='line'>Compared 7916053bb9f8bc3d952588a87a48da96dda7abe6 to 57f20ff734c8836fa34f938bcc540a89bad9215c <span class="k">for  </span>and got 57f20ff734c8836fa34f938bcc540a89bad9215c
</span><span class='line'>Detected Change in Git Version!
</span><span class='line'>Already doing 57f20ff734c8836fa34f938bcc540a89bad9215c
</span><span class='line'>Skipped missing: bin/nodework/part/controlnode/work.sh
</span><span class='line'>Skipped missing: bin/nodework/stacktype/ControlServer1/work.sh
</span><span class='line'>Skipped missing: bin/nodework/stacktype/ControlServer1/part/controlnode/work.sh
</span><span class='line'>~
</span><span class='line'>cron_1m.sh: Finish 20151002-012302
</span></code></pre></td></tr></table></div></figure>


<h4>No Difference</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>cron_1m.sh: Start  20151002-012801
</span><span class='line'>~/gitrepo/repo2_petulant-cyril ~
</span><span class='line'>Already up-to-date.
</span><span class='line'>Compared 57f20ff734c8836fa34f938bcc540a89bad9215c to 57f20ff734c8836fa34f938bcc540a89bad9215c <span class="k">for  </span>and got
</span><span class='line'>No change, move along
</span><span class='line'>Skipped missing: bin/nodework/part/controlnode/work.sh
</span><span class='line'>Skipped missing: bin/nodework/stacktype/ControlServer1/work.sh
</span><span class='line'>Skipped missing: bin/nodework/stacktype/ControlServer1/part/controlnode/work.sh
</span><span class='line'>~
</span><span class='line'>cron_1m.sh: Finish 20151002-012802
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Advanced Development and Delivery (ADD) [Part-3]]]></title>
    <link href="http://markfussell.emenar.com/blog/add-3/"/>
    <updated>2015-10-01T02:00:00-07:00</updated>
    <id>http://markfussell.emenar.com/blog/add-3</id>
    <content type="html"><![CDATA[<p>This is the third installment of describing a radically more productive development and delivery environment.</p>

<p>The first part is here: <a href="http://markfussell.emenar.com/blog/add-1/">Intro</a>.  In the previous parts I described the big picture and the
first part of the Vagrant bootstrap.</p>

<h2>EC2</h2>

<p>The Vagrant bootstrap occurred through &#8216;bash&#8217; files that shaped (put shape information into files) and
the &#8216;init&#8217; itself to get access to the repo (repo2) that contains the true configuration.  For EC2
the same thing happens within a CloudFormation template.  The code of the &#8216;init&#8217; is almost identical, but because
it is in a JSON file there is a lot of noise as the string gets concatenated together.</p>

<!-- more -->


<h3>Shaping</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="s2">&quot;TemplateConstant&quot;</span> <span class="err">:</span> <span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;stacktype&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="nt">&quot;value&quot;</span> <span class="p">:</span> <span class="s2">&quot;ControlServer1&quot;</span> <span class="p">},</span>
</span><span class='line'>  <span class="nt">&quot;initgitrepo&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="nt">&quot;value&quot;</span> <span class="p">:</span> <span class="s2">&quot;repo2_petulant-cyril&quot;</span> <span class="p">},</span>
</span><span class='line'>  <span class="nt">&quot;nodepart&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="nt">&quot;value&quot;</span> <span class="p">:</span> <span class="s2">&quot;controlnode&quot;</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span><span class="err">,</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'>        <span class="s2">&quot;files&quot;</span> <span class="err">:</span> <span class="p">{</span>
</span><span class='line'>          <span class="nt">&quot;/root/nodeinfo/stacktype.txt&quot;</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="nt">&quot;content&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="nt">&quot;Fn::Join&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">[</span>
</span><span class='line'>              <span class="p">{</span> <span class="nt">&quot;Fn::FindInMap&quot;</span> <span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;TemplateConstant&quot;</span><span class="p">,</span> <span class="s2">&quot;stacktype&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span> <span class="p">]</span> <span class="p">},</span>
</span><span class='line'>              <span class="s2">&quot;&quot;</span>
</span><span class='line'>            <span class="p">]]},</span>
</span><span class='line'>            <span class="nt">&quot;mode&quot;</span>  <span class="p">:</span> <span class="s2">&quot;000700&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;owner&quot;</span> <span class="p">:</span> <span class="s2">&quot;root&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;group&quot;</span> <span class="p">:</span> <span class="s2">&quot;root&quot;</span>
</span><span class='line'>          <span class="p">},</span>
</span><span class='line'>          <span class="nt">&quot;/root/nodeinfo/initgitrepo.txt&quot;</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="nt">&quot;content&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="nt">&quot;Fn::Join&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">[</span>
</span><span class='line'>              <span class="p">{</span> <span class="nt">&quot;Fn::FindInMap&quot;</span> <span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;TemplateConstant&quot;</span><span class="p">,</span> <span class="s2">&quot;initgitrepo&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span> <span class="p">]</span> <span class="p">},</span>
</span><span class='line'>              <span class="s2">&quot;&quot;</span>
</span><span class='line'>            <span class="p">]]},</span>
</span><span class='line'>            <span class="nt">&quot;mode&quot;</span>  <span class="p">:</span> <span class="s2">&quot;000700&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;owner&quot;</span> <span class="p">:</span> <span class="s2">&quot;root&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;group&quot;</span> <span class="p">:</span> <span class="s2">&quot;root&quot;</span>
</span><span class='line'>          <span class="p">},</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Init</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'>    <span class="s2">&quot;UserData&quot;</span>       <span class="err">:</span> <span class="p">{</span> <span class="nt">&quot;Fn::Base64&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="nt">&quot;Fn::Join&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">[</span>
</span><span class='line'>      <span class="s2">&quot;#!/bin/bash -v\n&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="s2">&quot;yum update -y aws-cfn-bootstrap\n&quot;</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>      <span class="s2">&quot;# Helper function\n&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="s2">&quot;function error_exit\n&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="s2">&quot;{\n&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="s2">&quot;  /opt/aws/bin/cfn-signal -e 1 -r \&quot;$1\&quot; &#39;&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="nt">&quot;Ref&quot;</span> <span class="p">:</span> <span class="s2">&quot;WaitHandle&quot;</span> <span class="p">},</span> <span class="s2">&quot;&#39;\n&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="s2">&quot;  exit 1\n&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="s2">&quot;}\n&quot;</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>      <span class="s2">&quot;# Install LAMP packages\n&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="s2">&quot;/opt/aws/bin/cfn-init -s &quot;</span><span class="p">,</span> <span class="p">{</span> <span class="nt">&quot;Ref&quot;</span> <span class="p">:</span> <span class="s2">&quot;AWS::StackName&quot;</span> <span class="p">},</span> <span class="s2">&quot; -r PrimaryLaunchConfig &quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="s2">&quot;    --access-key &quot;</span><span class="p">,</span>  <span class="p">{</span> <span class="nt">&quot;Ref&quot;</span> <span class="p">:</span> <span class="s2">&quot;HostKeys&quot;</span> <span class="p">},</span>
</span><span class='line'>      <span class="s2">&quot;    --secret-key &quot;</span><span class="p">,</span> <span class="p">{</span><span class="nt">&quot;Fn::GetAtt&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;HostKeys&quot;</span><span class="p">,</span> <span class="s2">&quot;SecretAccessKey&quot;</span><span class="p">]},</span>
</span><span class='line'>      <span class="s2">&quot;    --region &quot;</span><span class="p">,</span> <span class="p">{</span> <span class="nt">&quot;Ref&quot;</span> <span class="p">:</span> <span class="s2">&quot;AWS::Region&quot;</span> <span class="p">},</span> <span class="s2">&quot; || error_exit &#39;Failed to run cfn-init&#39;\n&quot;</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>      <span class="s2">&quot;yum -y install git \n&quot;</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>      <span class="s2">&quot;echo &#39;Fetch s3cmd to get credentials&#39; \n&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="s2">&quot;mkdir /root/download/ \n&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="s2">&quot;pushd /root/download/ \n&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="s2">&quot;git clone git://github.com/s3tools/s3cmd.git \n&quot;</span><span class="p">,</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Launching and Clusters</h3>

<p>A CloudFormation can provision a single server, but it is used more for clusters.  Instead of creating a server, we create
a server definition and then say how many servers we want.  The &#8216;PrimaryServerGroup&#8217; defines this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="s2">&quot;PrimaryServerGroup&quot;</span> <span class="err">:</span> <span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;Type&quot;</span> <span class="p">:</span> <span class="s2">&quot;AWS::AutoScaling::AutoScalingGroup&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;Properties&quot;</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;Tags&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>      <span class="p">{</span> <span class="nt">&quot;Key&quot;</span><span class="p">:</span> <span class="s2">&quot;add:stacktype&quot;</span><span class="p">,</span> <span class="nt">&quot;Value&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="nt">&quot;Fn::FindInMap&quot;</span> <span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;TemplateConstant&quot;</span><span class="p">,</span> <span class="s2">&quot;stacktype&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span> <span class="p">]</span> <span class="p">},</span> <span class="nt">&quot;PropagateAtLaunch&quot;</span> <span class="p">:</span> <span class="s2">&quot;true&quot;</span> <span class="p">},</span>
</span><span class='line'>      <span class="p">{</span> <span class="nt">&quot;Key&quot;</span><span class="p">:</span> <span class="s2">&quot;add:nodepart&quot;</span><span class="p">,</span> <span class="nt">&quot;Value&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="nt">&quot;Fn::FindInMap&quot;</span> <span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;TemplateConstant&quot;</span><span class="p">,</span> <span class="s2">&quot;nodepart&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span> <span class="p">]</span> <span class="p">},</span> <span class="nt">&quot;PropagateAtLaunch&quot;</span> <span class="p">:</span> <span class="s2">&quot;true&quot;</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">],</span>
</span><span class='line'>    <span class="nt">&quot;AvailabilityZones&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="nt">&quot;Fn::GetAZs&quot;</span> <span class="p">:</span> <span class="s2">&quot;&quot;</span> <span class="p">},</span>
</span><span class='line'>    <span class="nt">&quot;LaunchConfigurationName&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="nt">&quot;Ref&quot;</span> <span class="p">:</span> <span class="s2">&quot;PrimaryLaunchConfig&quot;</span> <span class="p">},</span>
</span><span class='line'>    <span class="nt">&quot;MinSize&quot;</span> <span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;MaxSize&quot;</span> <span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;DesiredCapacity&quot;</span> <span class="p">:</span> <span class="s2">&quot;1&quot;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span><span class="err">,</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note that it ends with &#8216;1&#8217;, &#8216;1&#8217;, &#8216;1&#8217; meaning this is just a single server.  But those numbers can be changed at any time.</p>

<p>Given the DesiredCapacity is &#8216;1&#8217;, if you ever kill a server, a new one will be spun up.</p>

<h3>EC2 Keypairs</h3>

<p>Another difference of the EC2 model is that EC2 holds onto the keypair that is used for logging into it.  So that information
doesn&#8217;t need to be exposed.  And further, the EC2 version creates a special &#8216;IAM&#8217; agent for the machine.</p>

<h3>EC2 Dashboard</h3>

<p>The dashboard shows some standard EC2 properties along with the add:stacktype and add:nodepart.  The nodepart shows the
kind of node it is (say a load-balancer vs. a game server) and is used within the bootstrap to put the right software
onto the machine.  The &#8216;nodepart&#8217; and the &#8216;stacktype&#8217; are the core DNA switches of a server.  Later we will add in
&#8216;federation&#8217; which primarily configures the size of the node (e.g. no &#8216;small&#8217; in production)</p>

<p><img src="http://markfussell.emenar.com/images/add-3/add3_ec2_cv1.png" /></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Advanced Development and Delivery (ADD) [Part-2]]]></title>
    <link href="http://markfussell.emenar.com/blog/add-2/"/>
    <updated>2015-10-01T01:00:00-07:00</updated>
    <id>http://markfussell.emenar.com/blog/add-2</id>
    <content type="html"><![CDATA[<p>This is the second installment of describing a radically more productive development and delivery environment.</p>

<p>The first part is here: <a href="http://markfussell.emenar.com/blog/add-1/">Intro</a>, but to summarize: since the 1970s, the most productive way
to develop and deliver software was present in Smalltalk, Lisp, and other languages (Mesa/Cedar at Xerox)
by using a very simple and powerful model.  You take a computer with a fully running environment, you tweak it,
and then you clone that.  This way you: (a) minimize what could go wrong, and (b) maximize what will continue to work.
It is very tangible and very instructive (you have full source for everything that is running).  You tweak other
people&#8217;s masterpieces until they do what you want, and you learn from their masterpieces to create your own.</p>

<h2>ADD: How Better?</h2>

<p>As described before, ADD has four ingredients:</p>

<ul>
<li>Amazon EC2 <a href="http://aws.amazon.com/">http://aws.amazon.com/</a></li>
<li>Amazon S3  <a href="http://aws.amazon.com/">http://aws.amazon.com/</a></li>
<li>GitHub.com <a href="http://github.com/">http://github.com/</a></li>
<li>HipChat    <a href="http://HipChat.com/">http://HipChat.com/</a></li>
</ul>


<p>And these are hooked together to enable &#8216;Changers&#8217;, &#8216;Watchders&#8217;, and &#8216;Machines&#8217; to be super-productive.  How
is the ADD <em>more productive</em> than the tweak and clone model?  It is because it solves the core problems
of the clone model:</p>

<ul>
<li>How do we clone to <em>different</em> environments?  Different hardware or configuration changes?</li>
<li>How do we reduce the amount of information we have to clone?</li>
<li>How do we reduce the time it takes to transport the clone?</li>
<li>How do we know what version of the clone is on any machine?</li>
<li>How do we create thousands of clones?</li>
<li>How do we know what is different about the different clones?</li>
<li>&#8230;</li>
</ul>


<!-- more -->


<p>The first three ingredients are the most powerful and enables a fantastic improvement to the tweak and clone model.
The last ingredient is mainly for people to be able to enjoy the ADD more easily.  It is like the &#8216;salt-to-taste&#8217;
and how much you integrate HipChat in with the rest of the ecosystem is up to your team.  But the more it is integrated,
the more your team will know what is going on, the more easily your team will solve problems/issues, and the more easily
you will onboard new people.</p>

<h2>ADD: GitHub</h2>

<p>GitHub will become your primary resource for <em>everything</em> related to &#8216;information&#8217;.  Human notes&#8230; go into GitHub
in Markdown format (like this blog).  Meeting notes.  GitHub.  Images to go with Meeting notes.  GitHub.  Your first,
most important, repository will be called &#8216;repo1&#8217; and will be all the notes you want the team to see.  No more
arguing about the best Wiki, blogger, file store, etc.  The answer will always be the same.  It is in GitHub.  Because
<em>everything</em> is in GitHub.</p>

<p>Why?  Because it is simple.  It is accessible.  It is powerful.  Keeps history.  Takes almost no space.
It works offline (on an airplane).  And it works with multiple writers.  And if GitHub dies&#8230;
you have a complete copy of everything you need to bring up your own &#8216;Git&#8217;.  Asking &#8216;Why?&#8217; is silly.  First
move to GitHub for all of this, and then ask &#8216;Why?&#8217; to everything else.</p>

<h2>ADD: S3 : Annexed Repositories</h2>

<p>Git and GitHub are not good with large binary assets.  They get stored in a notably raw way and just make the
repository huge for no benefit.  So don&#8217;t store large binary assets in GitHub.  Instead store a reference to
the binary object up in S3.  Retrieve it as needed.  See <a href="http://markfussell.emenar.com/blog/git-about-everything-annex">Annex</a></p>

<h2>ADD: EC2 and Vagrant and GitHub and S3</h2>

<p>Using EC2 and Vagrant with a &#8216;PushMe-PullYou&#8217; model (see <a href="http://markfussell.emenar.com/blog/git-about-everything-it-automation-2">PushMePullYou</a>)
solves a host of development, delivery, and operations issues.  The benefits are:</p>

<ul>
<li>Complete version control of machines – both operations and developers&#8217; machines (or part of a developers&#8217; machines)</li>
<li>A very simple model that enables machines to be provisioned rapidly and to change their state every minute (if needed)</li>
<li>An impressive fan-out of activity</li>
<li>An ability to work offline (say GitHub goes down) or to have complete redundancy (use both GitHub and BitBucket to avoid SPOF)</li>
<li>Inherently no SPOF</li>
<li>Dependent on <em>nothing</em> - Not EC2, Not Vagrant, not GitHub, not S3.  These may be gold standards, but they can all be swapped out</li>
</ul>


<p>This is where the ADD just shoots through the roof.  The ADD uses particular technology to show &#8220;How it is done&#8221; and
get you doing it right.  But it is not dependent on those technologies.  No Chef.  Unless you want it (and I recommend &#8216;Solo&#8217;).
No Linux unless you want it.  No Grails or Groovy unless you want it.  Use Google Compute if you want to.  Or even your
own Big Iron.  The ADD is a set of tools and methods that work well together and is most easily seen with the Gold Standard.
But it is beyond them: like a mathematical formula (the Golden Ratio) that can be present in many forms.</p>

<h2>Demo or Die!</h2>

<p>The core demo for this article will walk through bringing up a server on EC2 <em>and</em> Vagrant.  If you are not familiar
with EC2 and Vagrant, please read some of my other articles or meeting notes, or look to the web for resources.</p>

<h3>Vagrant</h3>

<p>The demo in Vagrant is slightly simpler than in EC2 because you are dealing with a machine at a time.  On EC2 you
should be thinking &#8216;Clusters&#8217; of machines that work together in &#8216;Federations&#8217;, and the technology to do that is
more complicated and more EC2-centric.</p>

<p>In Vagrant, you have a &#8216;Box&#8217; definition and then an actual virtual instance.  To provision an instance you have
to &#8216;init&#8217; it, bring it up, and then configure it.  Except you don&#8217;t.  As long as the instance knows how to
bootstrap itself.  Demo:</p>

<h4>Vagrantfile</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">inline</span><span class="p">:</span> <span class="o">&lt;&lt;-</span><span class="no">SHELL</span>
</span><span class='line'><span class="sh">     su root</span>
</span><span class='line'><span class="sh">     source /vagrant/resource/centos7a_cf2_ControlServer1.sh</span>
</span><span class='line'><span class="sh">     source /vagrant/resource/centos7a_cred_bot1.sh</span>
</span><span class='line'><span class="sh">     source /vagrant/resource/centos7a_boot1.sh</span>
</span><span class='line'><span class="no">  SHELL</span>
</span></code></pre></td></tr></table></div></figure>


<p>As the last step of the Vagrantfile, the (linux) server does three things:</p>

<ul>
<li>It &#8216;shapes&#8217; itself to be a ControlServer</li>
<li>It &#8216;shapes&#8217; itself to be &#8216;bot1&#8217; for it&#8217;s credentials</li>
<li>It configures itself with a boot script</li>
</ul>


<p>By the end of the boot script it will be fully alive and running.  Watching for changes to repositories that
indicate it should do something.  You should never have to SSH into the machine&#8230; ever.  You can to look around
(like the Magic Schoolbus) but you should treat it like it is a living creature and <em>never</em> touch anything inside
it.  If you have to touch something, fix the &#8216;DNA&#8217; (that boot script), kill the server, and launch a new one.</p>

<p>Given this is a Vagrant file on the developer&#8217;s machine, they can certainly feel free to fiddle with things.  But that is
to learn to <em>understand</em> the server.  Some EC2 servers may even be for &#8216;fiddling&#8217;.  But QA and production servers should
never be touched and should only be looked at if they are confusing people (who already understand the fiddling and Vagrant servers).</p>

<p>Both &#8216;ControlServer1.sh&#8217; and &#8216;cred_bot1.sh&#8217; simply put information into files under &#8216;/root/nodeinfo/&#8217;.  This is an
amazingly flexible approach that works very simply for Vagrant and EC2.</p>

<h4>ControlServer1.sh</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/bash -v</span>
</span><span class='line'>
</span><span class='line'><span class="nb">export </span><span class="nv">stacktype</span><span class="o">=</span><span class="s2">&quot;ControlServer1&quot;</span>
</span><span class='line'><span class="nb">export </span><span class="nv">initgitrepo</span><span class="o">=</span><span class="s2">&quot;repo2_petulant-cyril&quot;</span>
</span><span class='line'><span class="nb">export </span><span class="nv">nodepart</span><span class="o">=</span><span class="s2">&quot;controlnode&quot;</span>
</span><span class='line'>
</span><span class='line'>mkdir /root/nodeinfo
</span><span class='line'><span class="nb">echo</span> <span class="nv">$stacktype</span> &gt; /root/nodeinfo/stacktype.txt
</span><span class='line'><span class="nb">echo</span> <span class="nv">$initgitrepo</span> &gt; /root/nodeinfo/initgitrepo.txt
</span><span class='line'><span class="nb">echo</span> <span class="nv">$nodepart</span> &gt; /root/nodeinfo/nodepart.txt
</span></code></pre></td></tr></table></div></figure>


<h4>cred_bot1.sh</h4>

<p>The actual version of this would contain real credential information.  The actual version would be developer-specific and not in version control.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/bash -v</span>
</span><span class='line'>
</span><span class='line'><span class="nb">export </span><span class="nv">access_key</span><span class="o">=</span><span class="s2">&quot;access_key&quot;</span>
</span><span class='line'><span class="nb">export </span><span class="nv">secret_key</span><span class="o">=</span><span class="s2">&quot;secret_key&quot;</span>
</span><span class='line'><span class="nb">export </span><span class="nv">keyname</span><span class="o">=</span><span class="s2">&quot;keyname&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="nb">echo</span> <span class="nv">$access_key</span> &gt; /root/nodeinfo/access_key.txt
</span><span class='line'><span class="nb">echo</span> <span class="nv">$secret_key</span> &gt; /root/nodeinfo/secret_key.txt
</span><span class='line'><span class="nb">echo</span> <span class="nv">$keyname</span> &gt; /root/nodeinfo/keyname.txt
</span><span class='line'>
</span><span class='line'>cat &gt;&gt; /root/.s3cfg <span class="s">&lt;&lt;EOS</span>
</span><span class='line'><span class="s">[default]</span>
</span><span class='line'><span class="s">access_key = $access_key</span>
</span><span class='line'><span class="s">secret_key = $secret_key</span>
</span><span class='line'>
</span><span class='line'><span class="s">EOS</span>
</span></code></pre></td></tr></table></div></figure>


<h4>centos7a_boot1.sh</h4>

<p>This script mirrors most of how EC2 works: we need this machine to be able to checkout a repository from GitHub but
we only have Amazon credentials.  So we put the full credentials into S3 and check them out.  Then we can clone
the &#8216;repo2&#8217; provisioning repo and go from there.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/bash -v</span>
</span><span class='line'>
</span><span class='line'>yum -y install git
</span><span class='line'>
</span><span class='line'><span class="nb">echo</span> <span class="s1">&#39;Fetch s3cmd to get credentials&#39;</span>
</span><span class='line'>mkdir /root/download/
</span><span class='line'><span class="nb">pushd</span> /root/download/
</span><span class='line'>git clone git://github.com/s3tools/s3cmd.git
</span><span class='line'><span class="nb">cd </span>s3cmd
</span><span class='line'>git checkout a91c40fcd14772fa48297e676c8c6efa1aabc3c0
</span><span class='line'>python --version
</span><span class='line'>python setup.py install
</span><span class='line'>mkdir /root/bin/
</span><span class='line'>mv /root/download/s3cmd /root/bin/s3cmd
</span><span class='line'><span class="nb">popd</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nb">echo</span> <span class="s1">&#39;Retrieve SSH keys for Github&#39;</span>
</span><span class='line'><span class="nb">pushd</span> /root/.ssh
</span><span class='line'>/root/bin/s3cmd/s3cmd --config /root/.s3cfg get s3://gapshaklee/it/key/shakbot1key2/*
</span><span class='line'>chmod 600 id*
</span><span class='line'><span class="nb">cd</span> /root
</span><span class='line'>ssh -v -o <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no -T git@github.com
</span><span class='line'>
</span><span class='line'>mkdir /root/gitrepo
</span><span class='line'><span class="nb">cd</span> /root/gitrepo
</span><span class='line'>git clone git@github.com:shaklee/<span class="sb">`</span>cat /root/nodeinfo/initgitrepo.txt<span class="sb">`</span>.git
</span><span class='line'>
</span><span class='line'><span class="nb">cd</span> /root/gitrepo/<span class="sb">`</span>cat /root/nodeinfo/initgitrepo.txt<span class="sb">`</span>
</span><span class='line'>include <span class="o">()</span> <span class="o">{</span> <span class="k">if</span> <span class="o">[[</span> -f <span class="se">\&quot;</span><span class="nv">$1</span><span class="se">\&quot;</span> <span class="o">]]</span>; <span class="k">then </span><span class="nb">source</span> <span class="se">\&quot;</span><span class="nv">$1</span><span class="se">\&quot;</span>; <span class="k">else </span><span class="nb">echo</span> <span class="se">\&quot;</span>Skipped missing: <span class="nv">$1</span><span class="se">\&quot;</span>; <span class="k">fi</span> <span class="o">}</span>
</span><span class='line'>include it/nodeinit/common/init.sh
</span><span class='line'>
</span><span class='line'><span class="c">#Zzzzz....</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Directory Layout</h4>

<p>An image of the directory structure is below.  The little-meaning but organized name &#8216;repo2&#8217; is augmented with a human suffix &#8216;petulant-cyril&#8217;
to make it unique and memorable. &#8216;repo2&#8217; is always the first operations repo and &#8216;repo3&#8217; is always the first development repo.
The suffix is generated by GitHub or other name generators.</p>

<p>The layout of the directory contains a few things:</p>

<ul>
<li> A &#8216;bin&#8217; that contains scripts that can be run within this repository.  The &#8216;deflateAll.sh&#8217; script is important enough to be put in the root, but the rest are inside &#8216;bin&#8217;.</li>
<li> All things other than the README and deflatAll should be in consistent subdirectories.  The &#8216;s3info&#8217; is for the annex.  And &#8216;it&#8217; is for everything related to being it.  &#8216;src&#8217; and &#8216;test&#8217; are meaningless at the root level and should not be checked in.</li>
<li> You can see the &#8216;node&#8217; folders.  A &#8216;node&#8217; is a virtual server (Chef and others terminology).  &#8216;nodeaws&#8217; is for aws related node configuration.  &#8216;nodeinit&#8217; is common.  &#8216;nodevag&#8217; is for vagrant.  &#8216;resource&#8217; contains resourceds in general if under &#8216;it&#8217; and for something more specific if lower</li>
<li> folder names are never capitalized or pluralized to avoid inter-operating-system issues.  File names can be any format, but I use augmented CamelCase (with snakes) or snake_case depending on the situation.</li>
<li> You can see the annexed files in the &#8216;/it/resource&#8217; folder.  They are all &#8216;50 bytes&#8217;</li>
</ul>


<p><img src="http://markfussell.emenar.com/images/add-2/vag1_20151001b.png" /></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Advanced Development and Delivery (ADD)]]></title>
    <link href="http://markfussell.emenar.com/blog/add-1/"/>
    <updated>2015-09-24T01:00:00-07:00</updated>
    <id>http://markfussell.emenar.com/blog/add-1</id>
    <content type="html"><![CDATA[<p>I have been paid to develop and deliver software since about 1980.  That is 35 years of professional experience.
When I started in 1980 there were a lot of &#8216;old timers&#8217; who had been around since 1965 or so.  They were 15 years
ahead of me, and even after finishing college, I had less than ten years to their twenty or so.  This was both
intimidating but also very helpful: after college my main programming language was Smalltalk (ParcPlace, Digitalk, etc.),
which included full source to everything.  So the &#8216;masters&#8217; would write masterpieces of code, and I would read them.  And then
try to write my own beautiful things leveraging the masterpieces.  I was late to the party, but could learn quickly.</p>

<p>I also have one other unusual advantage: I do startups.  Lots of startups (<a href="http://SlumsOfPaloAlto.com/">http://SlumsOfPaloAlto.com/</a>).  A total of ten software startups over a period of
a bit more than a decade.  Each of these startups failed for one reason or another, but each one <em>hugely</em> progressed in
how good my development team ran.  Eight, nine, and ten were <em>crazy</em> productive: I would run production servers for the
whole company at the same time that I built out the product.  Alone.  And generally way faster than the product management
team could keep up.  At PeerCase the product team actually asked me to <em>slow down</em> delivery so they could ponder what
they wanted for longer.  I literally went to Disney World during ASH (a medical conference) to prevent myself from
releasing new features I knew they wanted.  I was paid to <em>not work</em> (well, I was contracting at the time, so I stopped the
hourly billing clock, but my project bonus was the same).</p>

<h2>10x Productivity</h2>

<p>Besides doing startups, I also consult for companies.  I try to help them improve their development methods, usually by at least 4x if not 10x.
A lot of times, people don&#8217;t believe you can improve things to &#8216;10x&#8217; the productivity of the current team using new
development and delivery techniques.  At one company, the CIO and a number of other executives believed me, but I had to convince
a lot more stakeholders.  So two amigos and I sent me into the trenches.  I started taking projects estimated as two-developers, six-months,
and doing them in one month.  Part time.  That is more than 12x productivity.  Realistically it was likely about 20x the productivity
because the teams tend to miss their estimates (they go over).</p>

<!-- more -->


<p>Then for fun, I was sent into the trenches again but this time had to use <em>some</em> of their development methods.  Still way faster,
but back down to 10x or a bit better.  As the trenches became &#8220;less mine&#8221; and &#8220;more theirs&#8221; I would slow down more and more.
Eventually everyone tired of each other and the experiments stopped.</p>

<p>Bizarrely, this company that saw the 20x&#8230; continues to use the slow, unreliable, method of development.  The workers may have
been scared that the company would only need one in ten of them if they changed to a better method.</p>

<h2>Development Stagnation</h2>

<p>Again, I have been doing this for 35 years.  My skill as a developer has improved over that time, and I now view myself as an &#8216;8&#8217;
where each increase from &#8216;0&#8217; represents a doubling of business productivity.  So I am 256 times as productive as a &#8216;0&#8217;, and 16 times
as productive as a &#8216;4&#8217;.  Stephen Wolfram, Bill Joy, and others are above me, but there are not a lot of people up there anymore.</p>

<p>Getting to be a &#8216;4&#8217; involves understanding how to program.  Getting to a &#8216;6&#8217; involves understanding business needs.  But getting to an &#8216;8&#8217;
involved an incredible / revolutionary change to how software is developed and delivered.  For most of my career, getting to an &#8216;8&#8217;
was not possible.  Or at least the scale had to be different (i.e. add 50% for each number vs. doubling).</p>

<p>The problem was that software development had made <em>absolutely no progress</em> for 40+ years.  &#8220;You lie!&#8221; people claim.  &#8220;We build software very
differently then we used to!&#8221; they say.  Yes, <em>some people</em> have made progress.  But it was people doing it wrong for 40+ years.  The
people who did it right (Xerox PARC, MIT&#8217;s Lisp group, Xerox El Segundo, Tektronics, etc.) were buzzing along happily with a 4-10x speed
advantage over the rest of the industry.</p>

<p>What is this amazing way to build software?  Well, for 40+ years, the best way to write software was to take a working computer and tweak it.
Then clone that. Voila: you have a new capability on all your computers.  Testing is trivial.  Demoing is trivial.  Fixing
is trivial.  Tweak.  Clone.  Repeat.  Smalltalk, Lisp Machines, Xerox Stars, and so on all used this model.  And they were
blazingly fast to develop on.  And to learn how to develop on.</p>

<p>If you wrote software any way different from that, you were just punishing yourself.  Your software would regress because
you touched too much and broke things.  Your software would take too long to write and be buggy because you wrote it
from scratch instead of tweaking something that worked.  Your software would not do what the business wanted because
you spent months writing it instead of hours tweaking something that was close.  Pain&#8230; pain&#8230; pain&#8230;</p>

<p>When I shifted to Java, I dropped to a &#8216;6&#8217; from an &#8216;8&#8217; in Smalltalk.  Lots of developers hated leaving Smalltalk
because of that.  But in my case, I cared about the libraries and people who were moving into Java.  It was not
a great language, but it had a lot of potential.  And Smalltalk imploded when Java was released for free.</p>

<h2>Automated Testing</h2>

<p>So I am in this crappy new language, dealing with jars/libraries (usually without source), deploying to containers, building out
linux servers in data centers, and trying to make this whole thing scale to millions of users and international
development teams who like to break my code.  It was fun and hell at the same time.  To avoid my going down to a &#8216;4&#8217;
because other people broke my code, I leveraged XP practices that were entrenched in startup #3 (Evant / Retail Aspect).
This was one of the first full-bore XP companies with Kent Beck and Rob Mee at the helm of the development team.</p>

<p>XP is very much oriented to &#8220;Write tests first&#8221;.  That is stupid.  You need to figure out what you are doing and
writing tests is not a good way to figure out how to do something.  You <em>do it</em> to figure out how to do it.  But
after you <em>do it</em>, you should write tests to make sure the code still does it tomorrow.  Unfortunately, people
usually forget to write tests after, hence the XP maxim.  I lucked out and a whole bunch of tests existed
when I showed up to help save Evant.  I needed to scale the product to be bigger and faster.  On the order of a million times
bigger data set and a thousands times faster execution.  But it should still work, and if it did work it would
not fail any existing test (unless we changed functionality).</p>

<p>That sold me on automated testing.  It made me slower (say a &#8216;5&#8217;) but it protected me from other people breaking
my working code.  Eventually we used Excel for the automated tests, the business people wrote them directly, and
I was back to a &#8216;6&#8217;.</p>

<h2>Grails and Opinionated Frameworks</h2>

<p>I became an &#8216;8&#8217; again when I started using <a href="http://grails.org/">http://grails.org/</a>.  The language (Groovy and Annotated Java)
was now approaching Smalltalk if a bit uglier.  And the automated binding to the database, plugin model,
and other great features in Grails made it so I simply didn&#8217;t have to worry about a lot of stuff.  I
was getting different benefits from Smalltalk, but they netted out.  And I had the same benefit as
Smalltalk in onboarding others: (1) This is the Grails way, (2) These are my &#8216;tweaks&#8217; to the Grails way&#8230;
now start asking for features and go build them.</p>

<h2>Flex and Angular</h2>

<p>On the client side, I had shifted to using Flex very early on for a company called Winster.  It was a bit
bleeding edge at the time, but Flex was very powerful and very productive.  It was basically Smalltalk
on the client.  Eventually Flex/Flash became non-viable because of the iPhone issue, but then Angular
jumped in to replace it.  I tried others (e.g. YUI, Sencha, etc.) and they have pros-and-cons, but Angular
is very good and very Flex-like.</p>

<h2>Advanced Development and Delivery (ADD)</h2>

<p>OK, so above describes a lot of the stack I tend to use, but that isn&#8217;t where the &#8216;256x&#8217; comes from.  Above I claimed
I was an &#8216;8&#8217; but that was on the old &#8216;50%&#8217; or maybe &#8216;70%&#8217; more scale.  On the new scale, I am a &#8216;6&#8217; with the stack above
<em>until</em> you add in the ADD: The Advanced Development and Delivery environment.</p>

<p>The ADD came to me incrementally from Evant, through my own failed attempt at productizing it (Velidom), and fully
germinated with my last software startup: Rumble.  &#8220;Amusingly&#8221;, Velidom was killed by two of the four ingredients,
tried to work around problems with SVN that is replaced by one of the four ingredients, and included as part
of the product one of the four ingredients.  If we had just focused on that <em>one ingredient</em> and not the whole
software factory, Velidom would now be owned by Atlassian.</p>

<p>The four ingredients are:</p>

<ul>
<li>Amazon EC2 <a href="http://aws.amazon.com/">http://aws.amazon.com/</a></li>
<li>Amazon S3  <a href="http://aws.amazon.com/">http://aws.amazon.com/</a></li>
<li>GitHub.com <a href="http://github.com/">http://github.com/</a></li>
<li>HipChat    <a href="http://HipChat.com/">http://HipChat.com/</a></li>
</ul>


<p>These four ingredients, when baked properly together, give individuals and teams 4x or more productivity.  No, you
can not substitute the ingredients.  Not until you understand what they are and how they work together.  Yes, <em>I</em>
can substitute ingredients for the above, but the above are the current gold standard.  And hosting your own version
of any of these products is also a &#8216;substitution&#8217; and not equivalent to using them as a service.</p>

<h3>Four Ingredients, Three Roles</h3>

<p><img width="432" height="414" src="http://markfussell.emenar.com/images/add-1/ADD_FourIngredients_ThreeRoles_mlf1a1.png" /></p>

<p>For more details or questions, please contact me.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Being a git about everything (IT Automation [2])]]></title>
    <link href="http://markfussell.emenar.com/blog/git-about-everything-it-automation-2/"/>
    <updated>2013-02-19T18:16:00-08:00</updated>
    <id>http://markfussell.emenar.com/blog/git-about-everything-it-automation-2</id>
    <content type="html"><![CDATA[<p>This is the fifth in a series of using git as part of interesting solutions to problems.</p>

<p>The first is here: <a href="http://markfussell.emenar.com/blog/git-about-everything-intro/">Intro</a> and the previous
part of this topic is here: <a href="http://markfussell.emenar.com/blog/git-about-everything-it-automation/">IT Automation</a></p>

<h2>PushMePullYou or Leveraging git to enable mass-automated IT</h2>

<div style="float:right">
<img width="244" height="191" src="http://markfussell.emenar.com/images/git-about-everything-it-automation/Pushmepullyou_mlf1c.png" />
</div>


<p>The previous post dealt with the groundwork of having Git be a central part of IT automation.  That
showed the core idea but was a bit too simple to fully express the power of the approach.
This post will be dealing with all the things that were left off, especially support for:</p>

<ul>
<li> Many different types of servers with both their own and shared &#8216;recipes&#8217;</li>
<li> More complicated install/upgrade actions</li>
<li> More sophisticated install behavior</li>
<li> Multiple versions of &#8216;recipes&#8217; and an ability to promote whole IT from development to production</li>
<li> Getting information from other active repositories</li>
</ul>


<!-- more -->


<p>To just jump-in and not be so incremental, I want to build the following deployment:</p>

<ul>
<li> A load-balancing layer that registers itself with the outside world and knows how to talk to the application layer</li>
<li> An application layer that runs an application which may be updated at any time</li>
<li> A database layer using a cluster of Riak servers</li>
<li> A presence server that can record what servers are present (so other servers can leverage)</li>
</ul>


<p>Each of these will be a different stack for easier management.  There will also be a Control server
which makes setting up the deployment easier (for example, it will make sure you have the latest AWS CLI).</p>

<h2>The Control Server</h2>

<p>To get everything up and running check out the repository:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>git clone git://github.com/markfussell/giteveryrepo4.git
</span></code></pre></td></tr></table></div></figure>


<p>And then in the Amazon AWS console launch the control server with the file template at <code>it/aws/cloudformation/GitEvery4ControlServer.template</code>.</p>

<p><img src="http://markfussell.emenar.com/images/git-about-everything-it-automation-2/create_control_stack.png" /></p>

<p>You can then SSH into the server and <code>sudo su -</code> to change to root. And <code>cd gitrepo/giteveryrepo4</code> to get into the root of the repository.</p>

<p><img src="http://markfussell.emenar.com/images/git-about-everything-it-automation-2/control_server_login.png" /></p>

<h2>Handling Different Types of Servers</h2>

<p>A major difference from the previous example is there are now several types of servers, and they
will have different:</p>

<ul>
<li> Firewall permissions</li>
<li> Initial setup of software</li>
<li> Ongoing configuration changes</li>
</ul>


<p>There are also a number of similarities and ideally the CloudFormation files are as similar and
simple as possible.</p>

<h3>Firewall Permissions</h3>

<p>One major change is to get rid of stack-generated security groups: these are difficult to manage since
they have ever-changing and obscure names.  I believe it is better for any real deployment to control
the security groups independently of the Stacks.  So now we have two kinds of security groups:</p>

<ul>
<li> One for the <code>deployment</code> as a whole</li>
<li> One for each <code>part</code> a server node can be</li>
</ul>


<p>The <code>deployment</code> and <code>part</code> are assigned as constants in the Stack template mappings:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'>  <span class="s2">&quot;Mappings&quot;</span> <span class="err">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;TemplateConstant&quot;</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>       <span class="nt">&quot;stacktype&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="nt">&quot;value&quot;</span> <span class="p">:</span> <span class="s2">&quot;GitEvery4LbServer&quot;</span> <span class="p">},</span>
</span><span class='line'>       <span class="nt">&quot;initgitrepo&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="nt">&quot;value&quot;</span> <span class="p">:</span> <span class="s2">&quot;giteveryrepo4&quot;</span> <span class="p">},</span>
</span><span class='line'>       <span class="nt">&quot;nodepart&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="nt">&quot;value&quot;</span> <span class="p">:</span> <span class="s2">&quot;applbnode&quot;</span> <span class="p">},</span>
</span><span class='line'>       <span class="nt">&quot;deployment&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="nt">&quot;value&quot;</span> <span class="p">:</span> <span class="s2">&quot;testdeployment&quot;</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">},</span>
</span></code></pre></td></tr></table></div></figure>


<p>and then later referenced in the security group section:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'>    <span class="s2">&quot;SecurityGroups&quot;</span> <span class="err">:</span> <span class="p">[</span> <span class="p">{</span> <span class="nt">&quot;Fn::FindInMap&quot;</span> <span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;TemplateConstant&quot;</span><span class="p">,</span> <span class="s2">&quot;deployment&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span> <span class="p">]</span> <span class="p">},</span> <span class="p">{</span> <span class="nt">&quot;Fn::FindInMap&quot;</span> <span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;TemplateConstant&quot;</span><span class="p">,</span> <span class="s2">&quot;nodepart&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span> <span class="p">]</span> <span class="p">}</span> <span class="p">]</span><span class="err">,</span>
</span></code></pre></td></tr></table></div></figure>


<p>Before we create the stack, we create the appropriate groups.  For example, the <code>deployment</code> group will enable SSH into
the nodes and any node within the deployment to talk to any other node:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#===================</span>
</span><span class='line'><span class="c">#=== testdeployment</span>
</span><span class='line'><span class="c">#===================</span>
</span><span class='line'>
</span><span class='line'>ec2-create-group testdeployment -d  testdeployment
</span><span class='line'><span class="nb">export </span><span class="nv">OWNER</span><span class="o">=</span><span class="sb">`</span>ec2-describe-group | grep GROUP | head -n 1 | cut -f 3<span class="sb">`</span>
</span><span class='line'>
</span><span class='line'><span class="c">#Enable SSH In</span>
</span><span class='line'>ec2-authorize testdeployment -p 22 -s 0.0.0.0/0
</span><span class='line'>
</span><span class='line'><span class="c">#Enable deployment to talk to itself</span>
</span><span class='line'>ec2-authorize testdeployment -o testdeployment -u <span class="k">${</span><span class="nv">OWNER</span><span class="k">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Initial setup of software</h3>

<p>Within the CloudFormation template, we use the same approach as last time: simply checkout a git repository and call into it.  In Bash it would be:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>yum -y install git
</span><span class='line'>mkdir /root/gitrepo
</span><span class='line'><span class="nb">cd</span> /root/gitrepo
</span><span class='line'>git clone git://github.com/markfussell/<span class="sb">`</span>cat /root/nodeinfo/initgitrepo.txt<span class="sb">`</span>.git
</span><span class='line'>
</span><span class='line'><span class="nb">cd</span> /root/gitrepo/<span class="sb">`</span>cat /root/nodeinfo/initgitrepo.txt<span class="sb">`</span>
</span><span class='line'>include <span class="o">()</span> <span class="o">{</span> <span class="k">if</span> <span class="o">[[</span> -f <span class="s2">&quot;$1&quot;</span> <span class="o">]]</span>; <span class="k">then </span><span class="nb">source</span> <span class="s2">&quot;$1&quot;</span>; <span class="k">else </span><span class="nb">echo</span> <span class="s2">&quot;Skipped missing: $1&quot;</span>; <span class="k">fi</span> <span class="o">}</span>
</span><span class='line'>include bin/init/common/init.sh
</span></code></pre></td></tr></table></div></figure>


<p>which is converted to JSON (string-quoted) within the template.</p>

<p>This entering on a common <code>init.sh</code> entrypoint makes the CloudFormation stacks simpler and more general.  It is much
easier to update and push to the git repository than to update all the stacks that are using the repository.</p>

<p>The new part is now at the end of the common entrypoint: jumping into more specific initialization depending
on the properties of the node:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>include bin/init/part/<span class="sb">`</span>cat /root/nodeinfo/nodepart.txt<span class="sb">`</span>/init.sh
</span><span class='line'>include bin/init/stacktype/<span class="sb">`</span>cat /root/nodeinfo/stacktype.txt<span class="sb">`</span>/init.sh
</span><span class='line'>include bin/init/stacktype/<span class="sb">`</span>cat /root/nodeinfo/stacktype.txt<span class="sb">`</span>/part/<span class="sb">`</span>cat /root/nodeinfo/nodepart.txt<span class="sb">`</span>/init.sh
</span></code></pre></td></tr></table></div></figure>


<p>We so far have three variations:</p>

<ul>
<li> The <code>part</code></li>
<li> The <code>stacktype</code></li>
<li> Combining both of the above.</li>
</ul>


<p>We can be as general or as specific as we want.</p>

<p>A <code>stacktype</code> is simply the name of the template (vs. the name of an instantiated stack which has to be unique).
The main advantage of <code>stacktype</code> is it allows easy separation of behavior by kind of stack and
also allows versioning if <code>stacktype</code> includes a version number.</p>

<p>A <code>part</code> is the singular role a node plays within a deployment.  I use <code>part</code> instead of <code>role</code> to avoid
conflict with Chef where a node can have many roles.  A node has exactly one <code>part</code> it plays in the deployment,
and each <code>part</code> can have any number of <code>roles</code>.  A <code>part</code> should normally be fairly universal.  In our case
the five parts are <code>applbnode</code> (The main application load balancer), <code>appnode</code> (The main app), <code>riaknode</code> (The
riak database node), <code>presencenode</code> (A server presence recording server), and <code>controlnode</code> (The main launching
control server, which isn&#8217;t really part of the running deployment).</p>

<p>With just the application and load-balancing parts/nodes running along with the controlnode, we have something like this:</p>

<p><img src="http://markfussell.emenar.com/images/git-about-everything-it-automation-2/pushmepullyou_lbandappawsarch.png" /></p>

<p>Each <code>part</code> has its own stack template and instance, which creates one or more nodes of that <code>part</code> type.</p>

<p>&#8230;More To Come&#8230;</p>

<h2>References</h2>

<ul>
<li> <a href="http://bitfieldconsulting.com/scaling-puppet-with-distributed-version-control">http://bitfieldconsulting.com/scaling-puppet-with-distributed-version-control</a></li>
<li> <a href="http://blog.afistfulofservers.net/post/2012/12/21/promises-lies-and-dryrun-mode/">http://blog.afistfulofservers.net/post/2012/12/21/promises-lies-and-dryrun-mode/</a></li>
</ul>


<h2>Next</h2>

<p>Our next problem will be&#8230;</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Being a git about everything (IT Automation)]]></title>
    <link href="http://markfussell.emenar.com/blog/git-about-everything-it-automation/"/>
    <updated>2013-02-16T18:16:00-08:00</updated>
    <id>http://markfussell.emenar.com/blog/git-about-everything-it-automation</id>
    <content type="html"><![CDATA[<p>This is the fourth in a series of using git as part of interesting solutions to problems.</p>

<p>The first is here: <a href="http://markfussell.emenar.com/blog/git-about-everything-intro/">Intro</a></p>

<h2>Leveraging git to help enable automated IT</h2>

<p>Doing IT for computers involves installing software, configuring things, doing backups, updates, etc.
The ultimate IT is one that <em>&#8216;simply works&#8217;</em> and involves almost no human interaction
even in failure situations.  Ideally IT should be equivalent to
a macro-level program that does everything that does not require touching
a physical machine.</p>

<p>This IT-as-program has become easier and easier over the last many years with
better and more standardized operating systems, free software that does not
require annoying human interaction during installation, and virtualization on top of physical
hardware that makes provisioning and reprovisioning easier.  With cloud computing,
IT-as-program becomes almost a necessity as hundreds of virtual computers are created, updated, failed,
migrated, and decommissioned.</p>

<p>Git alone doesn&#8217;t enable IT-as-program but it can be a core component in many areas.  Among these are:</p>

<ul>
<li> Easy &#8216;Live IT&#8217; servers</li>
<li> A Push-Me-Pull-You model for continual deployment</li>
<li> Server presence</li>
</ul>


<p>Having git as a core piece of IT infrastructure enables thousands of machines to very rapidly react (within a minute or two)
without needing a heavy infrastructure.  You simply need one or two (for redundancy) git servers, of which one can be GitHub
or a similar free or inexpensive service.  Other technologies in this space have significantly more complicated servers,
are more likely to be SPOFs (Single points of failures) or bottlenecks, and are much more expensive as a service.</p>

<!-- more -->


<h2>Easy &#8216;Live IT&#8217; servers</h2>

<p>A &#8216;Live IT&#8217; server is one that can automatically do new things when something about the IT world changes.  This
is not referring to how sophisticated the applications on a server are, but whether the server itself can
manage upgrades or other configuration changes to itself.  Examples are:</p>

<ul>
<li> Deploying new version of a Java war or a Rails app</li>
<li> Doing database backups and offloads</li>
<li> Offloading or deleting logs (that are harder than logrotate)</li>
<li> Reacting to simple configuration changes</li>
<li> Reacting to server presence changes</li>
</ul>


<p>There are a number of ways to do the activities listed above, from manually interacting with machines, through cron jobs,
mass &#8216;push&#8217; model interactions (e.g. Capistrano), and finally puppetry via Chef and similar.  I have found almost all of
these to be lacking in many ways, including:</p>

<ul>
<li> Lack of documented change-to-server</li>
<li> Difficulty in rolling back changes</li>
<li> Not scaling nicely (one client hitting many servers, or many servers doing queries against another server)</li>
<li> Lack of flexibility</li>
<li> Slowness or non-responsiveness (delays) of applying changes</li>
<li> Differences from &#8216;bootstrap&#8217; of cloud servers</li>
</ul>


<h3>Pull Model</h3>

<p>A different approach leveraging Git (or any other DVCS) seems to produce much simpler and more powerful
solutions.  The approach is composed of:</p>

<ul>
<li> A git repository that has working scripts (in any language people like, including Chef-solo)</li>
<li> A simple bootstrap script that clones the repository and calls an <code>init.sh</code> script in it</li>
<li> A cron job that is set up by the <code>init.sh</code> script.  This cron job executes every minute

<ul>
<li>Goes into the working git repository</li>
<li>Does a pull to get the latest version of scripts</li>
<li>Then calls into a <code>work.sh</code> script</li>
</ul>
</li>
</ul>


<p>This flow enables activity at every minute, using the latest version of the git repository, and with very little overhead
for the core behavior.  Advantages are:</p>

<ul>
<li> All changes to a server are caused by one or more git repositories changing.  Servers can even publish there status by showing the git revision they are on.</li>
<li> Rolling back changes is simply reversing a commit</li>
<li> The only centralized activity is the <code>git fetch</code> which is very simple and fast.</li>
<li> So far the only constraint is the time is every minute, and that could be sub-minute but needing that is rare</li>
<li> Delays are at most a minute, and again that could easily become less (but not sub-second)</li>
<li> The behavior is actually the same as bootstrapping a server.  A bootstrap is just the first minute of work.</li>
</ul>


<h3>Example-1</h3>

<p>Example-1 is the initial example of this model.  The repository is</p>

<ul>
<li> <a href="https://github.com/markfussell/giteveryrepo3/">https://github.com/markfussell/giteveryrepo3/</a></li>
</ul>


<p>with the CloudFormation template being:</p>

<ul>
<li> <a href="https://github.com/markfussell/giteveryrepo3/blob/master/it/aws/cloudformation/GitEverythingServer3.template">https://github.com/markfussell/giteveryrepo3/blob/master/it/aws/cloudformation/GitEverythingServer3.template</a></li>
</ul>


<p>This has a UserData section which does the initial bootstrap of cloning the repository and
calling an init script inside it.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'>      <span class="s2">&quot;yum -y install git \n&quot;</span><span class="err">,</span>
</span><span class='line'>      <span class="s2">&quot;mkdir /root/gitrepo \n&quot;</span><span class="err">,</span>
</span><span class='line'>      <span class="s2">&quot;cd /root/gitrepo \n&quot;</span><span class="err">,</span>
</span><span class='line'>      <span class="s2">&quot;git clone git://github.com/markfussell/giteveryrepo3.git  \n&quot;</span><span class="err">,</span>
</span><span class='line'>
</span><span class='line'>      <span class="s2">&quot;cd /root/gitrepo/giteveryrepo3 \n&quot;</span><span class="err">,</span>
</span><span class='line'>      <span class="s2">&quot;source bin/init/common/init.sh \n&quot;</span><span class="err">,</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>init.sh</code> script simply sets up a cron job that calls the <code>cron_1m.sh</code> script
in <code>/root/bin/</code>.  I prefer to have crontab files that are very simple (e.g. one line)
and call into /root/bin/ scripts so (a) it is more visible what crons are running
(b) if there are any inter-cron issues they can be managed, and (c) it is easy to
disable a cron by doing a rename.</p>

<p>The <code>init.sh</code> file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">================================</span>
</span><span class='line'><span class="c">#=== Have a preference that crons</span>
</span><span class='line'><span class="c">#=== all go through a single file</span>
</span><span class='line'><span class="c">#================================</span>
</span><span class='line'>
</span><span class='line'>mkdir -p /root/bin
</span><span class='line'>cp ./bin/init/common/cron_1m.sh /root/bin/cron_1m.sh
</span><span class='line'>chmod +x /root/bin/cron_1m.sh
</span><span class='line'>
</span><span class='line'>cat <span class="s">&lt;&lt;EOS &gt; /var/spool/cron/root</span>
</span><span class='line'><span class="s">MAILTO=&quot;&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="s">* * * * *  /root/bin/cron_1m.sh</span>
</span><span class='line'><span class="s">EOS</span>
</span></code></pre></td></tr></table></div></figure>


<p>And the <code>cron_1m.sh</code> file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#! /bin/bash</span>
</span><span class='line'><span class="c">#================================</span>
</span><span class='line'><span class="c">#=== Simple worker example</span>
</span><span class='line'><span class="c">#================================</span>
</span><span class='line'>
</span><span class='line'><span class="nb">export </span><span class="nv">ME</span><span class="o">=</span><span class="sb">`</span>basename <span class="nv">$0</span><span class="sb">`</span>
</span><span class='line'><span class="nb">export </span><span class="nv">LOG</span><span class="o">=</span>/root/log/<span class="k">${</span><span class="nv">ME</span><span class="k">}</span>_log.txt
</span><span class='line'><span class="nb">export </span><span class="nv">ERROR</span><span class="o">=</span>/root/log/<span class="k">${</span><span class="nv">ME</span><span class="k">}</span>_error.txt
</span><span class='line'><span class="nb">export </span><span class="nv">START_TSS</span><span class="o">=</span><span class="s2">&quot;`date +%Y%m%d-%H%M%S`&quot;</span>
</span><span class='line'>
</span><span class='line'>mkdir -p /root/log/
</span><span class='line'>
</span><span class='line'><span class="nb">exec </span>1&gt;&gt; <span class="k">${</span><span class="nv">LOG</span><span class="k">}</span>
</span><span class='line'><span class="nb">exec </span>2&gt;&gt; <span class="k">${</span><span class="nv">ERROR</span><span class="k">}</span>
</span><span class='line'>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;${ME}: Start  ${START_TSS}&quot;</span> &gt;&gt; <span class="k">${</span><span class="nv">LOG</span><span class="k">}</span>
</span><span class='line'>
</span><span class='line'><span class="nb">export </span><span class="nv">REPOS</span><span class="o">=</span><span class="sb">`</span>find /root/gitrepo/ -maxdepth 1 -mindepth 1 <span class="sb">`</span>
</span><span class='line'><span class="k">for </span>REPO in <span class="k">${</span><span class="nv">REPOS</span><span class="k">}</span>; <span class="k">do</span>
</span><span class='line'><span class="k">    </span><span class="nb">pushd</span> <span class="k">${</span><span class="nv">REPO</span><span class="k">}</span>
</span><span class='line'>        git pull
</span><span class='line'>
</span><span class='line'>        <span class="nb">source </span>bin/work/common/work.sh
</span><span class='line'>    <span class="nb">popd</span>
</span><span class='line'><span class="k">done</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nb">export </span><span class="nv">FINISH_TSS</span><span class="o">=</span><span class="s2">&quot;`date +%Y%m%d-%H%M%S`&quot;</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;${ME}: Finish ${FINISH_TSS}&quot;</span> &gt;&gt; <span class="k">${</span><span class="nv">LOG</span><span class="k">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see the <code>cron_1m.sh</code> script is &#8220;repo flexible&#8221;.
It will do any and all <code>work.sh</code> file it finds in the repositories under
<code>/root/gitrepo/</code>.  You might want to be more restrictive than
that (say only &#8216;active&#8217; repos), but this at least shows the power of the
generalization.</p>

<p>If you login to the server, you will find it doing some kind of work:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@ip-10-120-174-182 ~<span class="o">]</span><span class="c"># tail -f /root/log/*</span>
</span><span class='line'><span class="o">==</span>&gt; /root/log/cron_1m.sh_error.txt &lt;<span class="o">==</span>
</span><span class='line'>
</span><span class='line'><span class="o">==</span>&gt; /root/log/cron_1m.sh_log.txt &lt;<span class="o">==</span>
</span><span class='line'>Already up-to-date.
</span><span class='line'>We are doing some kind of work
</span><span class='line'>~
</span><span class='line'>cron_1m.sh: Finish 20130219-050202
</span><span class='line'>cron_1m.sh: Start  20130219-050301
</span><span class='line'>~/gitrepo/giteveryrepo3 ~
</span><span class='line'>Already up-to-date.
</span><span class='line'>We are doing some kind of work
</span><span class='line'>~
</span><span class='line'>cron_1m.sh: Finish 20130219-050301
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, the total time to do a &#8220;Hello World&#8221; is under a second.  Very fast!</p>

<h4>Inherent overhead of approach</h4>

<p>The amount of overhead associated associated with this approach is less than a second.  The fetch itself:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@ip-10-120-174-182 giteveryrepo3<span class="o">]</span><span class="c"># time git fetch</span>
</span><span class='line'>
</span><span class='line'>real  0m0.087s
</span><span class='line'>user  0m0.002s
</span><span class='line'>sys   0m0.006s
</span></code></pre></td></tr></table></div></figure>


<p>is 87 milliseconds and the system overhead is 8 milliseconds on an m1.small (that isn&#8217;t doing anything else).
With a busier server the &#8216;real&#8217; time goes up a bit, but the system overhead is still tens of milliseconds at
most.</p>

<p>Although fetching is useful on its own, we will initially always merge as well, so let us time that:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@ip-10-120-174-182 giteveryrepo3<span class="o">]</span><span class="c"># time git pull</span>
</span><span class='line'>Already up-to-date.
</span><span class='line'>
</span><span class='line'>real  0m0.105s
</span><span class='line'>user  0m0.007s
</span><span class='line'>sys   0m0.053s
</span></code></pre></td></tr></table></div></figure>


<p>Pulling requires a bit more effort to do a no-op merge but things are still in the tens of milliseconds of &#8216;effort&#8217;
and a clock time well under a second.</p>

<h2>Push-Me-Pull-You</h2>

<div style="float:right">
<img width="244" height="191" src="http://markfussell.emenar.com/images/git-about-everything-it-automation/Pushmepullyou_mlf1c.png" />
</div>


<p>The previous section discussed having &#8216;Live IT&#8217; servers that use the very-fast git pull to
get updates that the server will react to.  Updating central git repositories uses an atomic &#8216;push&#8217;
operation, so the obvious name for this pattern of pushing changes from one place (say &#8216;me&#8217;)
to a hundred servers who are listening (let us call them &#8216;you&#8217;) is&#8230; &#8216;Push-Me-Pull-You&#8217;&#8230;
which even has a handy mascot.</p>

<p>Some great things about the PushMePullYou were identified above:</p>

<ul>
<li> Extremely low overhead and very simple model</li>
<li> All changes to a server are caused by one or more git repositories changing.  Servers can even publish there status by showing the git revision they are on.</li>
<li> Rolling back changes is simply reversing a commit</li>
<li> The only centralized activity is the <code>git fetch</code> which is very simple and fast.</li>
<li> So far the only constraint is the time is every minute, and that could be sub-minute but needing that is rare</li>
<li> Delays are at most a minute, and again that could easily become less (but not sub-second)</li>
<li> The behavior is actually the same as bootstrapping a server.  A bootstrap is just the first minute of work.</li>
</ul>


<p>A few additional ones are:</p>

<ul>
<li> You can &#8216;push&#8217; from anywhere you want&#8230; so you can test a change on the target IT environment and then push from there if it works</li>
<li> It is very easy to organize many different kinds of machines, kinds of deployments, etc. within a single repository</li>
<li> It is very easy to detect whether a change happens at all, whether it is potentially relevant, and with a few easy patterns, whether it would have an impact that requires real action</li>
</ul>


<p>The architectural model looks a bit like this</p>

<p><img src="http://markfussell.emenar.com/images/git-about-everything-it-automation/pushmepullyou_simpleawsarch.png" /></p>

<h3>Going beyond naive</h3>

<p>The Example-1 above had the naive &#8216;pull and do something no matter what&#8217;.  We need to get a bit beyond that
to have a truly useful approach.</p>

<h3>Checking commit version</h3>

<p>The simplest sanity check is to see whether we have a new commit.  This can be done in a few ways, including:</p>

<ul>
<li> Do a &#8216;fetch&#8217; and check whether the remote branch is different from the local branch</li>
<li> After each action, store the commit version that was acted upon.  On each pull compare the old to the new</li>
<li> Have a local acted-upon branch separate from the main branch</li>
</ul>


<p>The last one has a nice feature of showing &#8216;history-according-to-this-machine&#8217; where the other two are purely
&#8216;what is now&#8217;, but it is simpler to avoid having a per-machine branch and multiple versions (the differing
merges depending on local history) occurring
everywhere.</p>

<h4>Fetch based</h4>

<p>The simplest check is just to see if there are any differences between the &#8216;origin&#8217; and the local branch.  This
would look something like <code>detectOriginFetchDiff.sh</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#=================================================</span>
</span><span class='line'><span class="c">#=== Detect whether the version of the origin</span>
</span><span class='line'><span class="c">#=== is the same as the local version.</span>
</span><span class='line'><span class="c">#=== Return the ORIGIN_VERSION if different</span>
</span><span class='line'><span class="c">#=================================================</span>
</span><span class='line'>
</span><span class='line'>git fetch
</span><span class='line'>
</span><span class='line'><span class="nb">export </span><span class="nv">ORIGIN_VERSION</span><span class="o">=</span><span class="sb">`</span>git rev-parse origin/master<span class="sb">`</span>
</span><span class='line'><span class="nb">export </span><span class="nv">LOCAL_VERSION</span><span class="o">=</span><span class="sb">`</span>git rev-parse HEAD<span class="sb">`</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;${ORIGIN_VERSION}&quot;</span> <span class="o">=</span> <span class="s2">&quot;${LOCAL_VERSION}&quot;</span> <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'>    : <span class="c">#Don&#39;t do anything</span>
</span><span class='line'><span class="k">else</span>
</span><span class='line'><span class="k">    </span><span class="nb">echo</span> <span class="k">${</span><span class="nv">ORIGIN_VERSION</span><span class="k">}</span>
</span><span class='line'><span class="k">fi</span>
</span></code></pre></td></tr></table></div></figure>


<p>Where you can use this script with:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;`./bin/pushmepullyou/detectOriginDiff.sh`&quot;</span> <span class="o">]]</span> ; <span class="k">then</span>
</span><span class='line'>   : <span class="c">#React to the change</span>
</span><span class='line'><span class="k">else</span>
</span><span class='line'>   : <span class="c">#Do nothing / exit</span>
</span><span class='line'><span class="k">fi</span>
</span></code></pre></td></tr></table></div></figure>


<p>This should be lightning fast.  The only drawback is:</p>

<ul>
<li> If you don&#8217;t pull (merge) until after executing the script&#8230; you might not be able to easily change the code determining whether to executing the script</li>
</ul>


<p>You can redo an action by forcing the local branch back a version.  For example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>git reset --hard master~1
</span></code></pre></td></tr></table></div></figure>


<h4>Last-action based</h4>

<p>An alternative to the fetch-based model is to record the last action performed by the local machine.  This
deals with the drawback above: you already have the latest version of code no matter what.  Also it starts
down the path of &#8216;mid-action&#8217; protection (to avoid doing a change or sequence of changes on top of each
other).  For example <code>detectLastActionDiff.sh</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#=================================================</span>
</span><span class='line'><span class="c">#=== Detect whether the last action version</span>
</span><span class='line'><span class="c">#=== is the same as the current pulled version.</span>
</span><span class='line'><span class="c">#=== Return the LOCAL_VERSION if different</span>
</span><span class='line'><span class="c">#=================================================</span>
</span><span class='line'>
</span><span class='line'><span class="nb">export </span><span class="nv">LOCAL_VERSION</span><span class="o">=</span><span class="sb">`</span>git rev-parse HEAD<span class="sb">`</span>
</span><span class='line'><span class="nb">export </span><span class="nv">LASTACTION_FILE</span><span class="o">=</span>./.temp/nodeinfo/lastaction.txt
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="o">[[</span> -e <span class="k">${</span><span class="nv">LASTACTION_FILE</span><span class="k">}</span> <span class="o">]]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">    </span><span class="nb">export </span><span class="nv">LAST_ACTION</span><span class="o">=</span><span class="sb">`</span>cat <span class="k">${</span><span class="nv">LASTACTION_FILE</span><span class="k">}</span><span class="sb">`</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;${LAST_ACTION}&quot;</span> <span class="o">=</span> <span class="s2">&quot;${LOCAL_VERSION}&quot;</span> <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'>        : <span class="c">#Don&#39;t do anything</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'><span class="k">        </span><span class="nb">echo</span> <span class="k">${</span><span class="nv">LOCAL_VERSION</span><span class="k">}</span>
</span><span class='line'>    <span class="k">fi</span>
</span><span class='line'><span class="k">else</span>
</span><span class='line'><span class="k">    </span><span class="nb">echo</span> <span class="k">${</span><span class="nv">LOCAL_VERSION</span><span class="k">}</span>
</span><span class='line'><span class="k">fi</span>
</span></code></pre></td></tr></table></div></figure>


<p>And after completing any action you write the version into the lastaction version file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">export </span><span class="nv">LOCAL_VERSION</span><span class="o">=</span><span class="sb">`</span>git rev-parse HEAD<span class="sb">`</span>
</span><span class='line'><span class="nb">export </span><span class="nv">LASTACTION_FILE</span><span class="o">=</span>./.temp/nodeinfo/lastaction.txt
</span><span class='line'><span class="nb">export </span><span class="nv">LASTACTION_DIR</span><span class="o">=</span><span class="s2">&quot;$( cd -P &quot;</span><span class="k">$(</span> dirname <span class="s2">&quot;${LASTACTION_FILE}&quot;</span> <span class="k">)</span><span class="s2">&quot; &amp;&amp; pwd )/&quot;</span>
</span><span class='line'>
</span><span class='line'>mkdir -p LASTACTION_DIR
</span><span class='line'><span class="nb">echo</span> <span class="k">${</span><span class="nv">LOCAL_VERSION</span><span class="k">}</span> &gt; <span class="k">${</span><span class="nv">LASTACTION_FILE</span><span class="k">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Avoiding mid-action collision</h3>

<p>The main advantage of the Last-action approach is it starts down the path of
making sure you are not executing things twice.  Alternatively, you could
have an <code>flock</code> associated with the calling script (say the <code>cron_1m.sh</code>),
but writing to a <code>currentaction</code> file is a bit more
OS independent, can document what version is being acted upon,
and supports multiple paths hitting the same file.</p>

<p>Ideally if anything is currently working, the automatic <code>merge</code> would stop,
so the test for <code>currentaction</code> should be very early.  We should go
back to our initial worker example</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#! /bin/bash</span>
</span><span class='line'><span class="c">#================================</span>
</span><span class='line'><span class="c">#=== Simple worker example</span>
</span><span class='line'><span class="c">#================================</span>
</span><span class='line'>
</span><span class='line'><span class="nb">export </span><span class="nv">ME</span><span class="o">=</span><span class="sb">`</span>basename <span class="nv">$0</span><span class="sb">`</span>
</span><span class='line'><span class="nb">export </span><span class="nv">LOG</span><span class="o">=</span>/root/log/<span class="k">${</span><span class="nv">ME</span><span class="k">}</span>_log.txt
</span><span class='line'><span class="nb">export </span><span class="nv">ERROR</span><span class="o">=</span>/root/log/<span class="k">${</span><span class="nv">ME</span><span class="k">}</span>_error.txt
</span><span class='line'><span class="nb">export </span><span class="nv">START_TSS</span><span class="o">=</span><span class="s2">&quot;`date +%Y%m%d-%H%M%S`&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="nb">export </span><span class="nv">CURRENTACTION_FILE</span><span class="o">=</span>./.temp/nodeinfo/currentaction.txt
</span><span class='line'>
</span><span class='line'>mkdir -p /root/log/
</span><span class='line'>
</span><span class='line'><span class="nb">exec </span>1&gt;&gt; <span class="k">${</span><span class="nv">LOG</span><span class="k">}</span>
</span><span class='line'><span class="nb">exec </span>2&gt;&gt; <span class="k">${</span><span class="nv">ERROR</span><span class="k">}</span>
</span><span class='line'>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;${ME}: Start  ${START_TSS}&quot;</span> &gt;&gt; <span class="k">${</span><span class="nv">LOG</span><span class="k">}</span>
</span><span class='line'>
</span><span class='line'><span class="nb">export </span><span class="nv">REPOS</span><span class="o">=</span><span class="sb">`</span>find /root/gitrepo/ -maxdepth 1 -mindepth 1 <span class="sb">`</span>
</span><span class='line'><span class="k">for </span>REPO in <span class="k">${</span><span class="nv">REPOS</span><span class="k">}</span>; <span class="k">do</span>
</span><span class='line'><span class="k">    </span><span class="nb">pushd</span> <span class="k">${</span><span class="nv">REPO</span><span class="k">}</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">[[</span> -e <span class="k">${</span><span class="nv">CURRENTACTION_FILE</span><span class="k">}</span> <span class="o">]]</span>; <span class="k">then</span>
</span><span class='line'>            : <span class="c">#Don&#39;t do anything until the current action completes</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'><span class="k">            </span>git pull
</span><span class='line'>
</span><span class='line'>            bash bin/work/common/work.sh
</span><span class='line'>        <span class="k">fi</span>
</span><span class='line'><span class="k">    </span><span class="nb">popd</span>
</span><span class='line'><span class="k">done</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nb">export </span><span class="nv">FINISH_TSS</span><span class="o">=</span><span class="s2">&quot;`date +%Y%m%d-%H%M%S`&quot;</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;${ME}: Finish ${FINISH_TSS}&quot;</span> &gt;&gt; <span class="k">${</span><span class="nv">LOG</span><span class="k">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Note: If you want to have each repository have more control of it&#8217;s behavior
you would need to move the <code>if</code> test and the <code>pull</code> into the work file.</p></blockquote>

<p>While the action is running you can either touch or copy
the current version into <code>currentaction</code>, and when
finished, delete or rename it.  Since everything
is running so fast, you probably don&#8217;t need to do
an <code>flock</code> or even a second <code>[[ -e ]]</code> check.  Acquiring
the lock is simply:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">export </span><span class="nv">LOCAL_VERSION</span><span class="o">=</span><span class="sb">`</span>git rev-parse HEAD<span class="sb">`</span>
</span><span class='line'><span class="nb">export </span><span class="nv">CURRENTACTION_FILE</span><span class="o">=</span>./.temp/nodeinfo/currentaction.txt
</span><span class='line'><span class="nb">export </span><span class="nv">CURRENTACTION_DIR</span><span class="o">=</span><span class="s2">&quot;$( cd -P &quot;</span><span class="k">$(</span> dirname <span class="s2">&quot;${CURRENTACTION_FILE}&quot;</span> <span class="k">)</span><span class="s2">&quot; &amp;&amp; pwd )/&quot;</span>
</span><span class='line'>
</span><span class='line'>mkdir -p CURRENTACTION_DIR
</span><span class='line'><span class="nb">echo</span> <span class="k">${</span><span class="nv">LOCAL_VERSION</span><span class="k">}</span> &gt; <span class="k">${</span><span class="nv">CURRENTACTION_FILE</span><span class="k">}</span>
</span><span class='line'>
</span><span class='line'><span class="c">#Now officially own the current action</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Dealing with different types and collections of servers</h3>

<p>All the above had a single type of machine watching any changes in the
repository and doing the same thing.  Although this does work if you
have either very few servers or are happy with a plethora of repositories
or branches, it would be good to have a way for many different types
and collections of servers to share a single repository.  We
will deal with that in the next blog.</p>

<h2>Summary</h2>

<p>Git can help automate IT with a very fast and effective PushMePullYou
model.  Hundreds of servers can be continually polling one or more
central Git servers to see if anything has changed and then act
upon those changes.  This provides history for any activity, a
very fast response time, and almost no load when nothing has changed.
Also, this approach enables bootstrapping and updating to use exactly
the same paths.</p>

<p>In all, it provides a superior foundation for IT automation in spite of
being so simple.</p>

<h2>References</h2>

<ul>
<li> Chef-Server Scalability

<ul>
<li><a href="http://lists.opscode.com/sympa/arc/chef/2012-01/msg00422.html">http://lists.opscode.com/sympa/arc/chef/2012-01/msg00422.html</a></li>
<li><a href="http://www.opscode.com/hosted-chef/">http://www.opscode.com/hosted-chef/</a></li>
</ul>
</li>
</ul>


<h2>Credit</h2>

<ul>
<li> Initial Llama for Push-Me-Pull-You Image credit: <a href='http://www.123rf.com/photo_11398752_llama-llove--two-llamas-kiss-their-necks-forming-a-heart-shape.html'>fiftyfootelvis / 123RF Stock Photo</a></li>
</ul>


<h2>Next</h2>

<p>Our next problem will be <a href="http://markfussell.emenar.com/blog/git-about-everything-it-automation-2/">Mass IT Automation</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Being a git about everything (IT)]]></title>
    <link href="http://markfussell.emenar.com/blog/git-about-everything-it/"/>
    <updated>2013-02-13T18:16:00-08:00</updated>
    <id>http://markfussell.emenar.com/blog/git-about-everything-it</id>
    <content type="html"><![CDATA[<p>This is the third in a series of using git as part of interesting solutions to problems.</p>

<p>The first is here: <a href="http://markfussell.emenar.com/blog/git-about-everything-intro/">Intro</a></p>

<h2>Leveraging git to help with IT tasks</h2>

<p>Doing IT for computers involves installing software, configuring things, doing backups, updates, etc.
Git can help out with a lot of this, with several big benefits.  Some examples:</p>

<ul>
<li> IT changes should always be version controlled in case of mistake.  Git and a couple patterns/tools makes that easy</li>
<li> Installing software can frequently be done with &#8216;yum&#8217; and similar commands, but some software needs a package, and some times you want more direct &#8216;this version&#8217; control.  An annexed git repository helps with that</li>
<li> Doing backups or other kinds of off-lining with an annexed repo is very simple and flexible</li>
<li> Git enables a PushMePullYou model that is very flexible and capable of driving hundreds of machines to do either (or both) very light and very heavy-weight operation</li>
</ul>


<p>Some of these things can be done with other tools, but I have found an annexed git repository to make doing these things easier and better</p>

<!-- more -->


<h2>IT Changes</h2>

<p>Any time you have a running computer you should be careful about making changes to it that you can&#8217;t
easily revert.  The classic <code>rm -fr /</code> is amongst the most painful, but even a few simple tweaks of a
configuration file could cause you minutes or hours of pain if you do them wrong and can&#8217;t just
start over.</p>

<p>There are many solutions to this problem:</p>

<ul>
<li> Create a &#8216;.bak&#8217; file</li>
<li> Create a &#8216;.datestamp&#8217; file of the file before you touch it</li>
<li> Copy the file into a backup folder</li>
<li> Rsync the directory somewhere else</li>
<li> Version control the whole directory structure</li>
<li> Have frequent backups of the whole machine</li>
</ul>


<p>Git can help with a number of different approaches, but
I will start with one approach that I find to be among the simplest, most-general, and most-beneficial.</p>

<h3>Copy &#8216;changing&#8217; files into an IT repo</h3>

<p>To get a huge step up on the problem, we are going to allocate an annexed git repository to &#8216;being for IT&#8217;.
And further we will have every computer out there have its own directory within the repository.  A computer&#8217;s
directory is simply it&#8217;s name (e.g. <code>hostname</code> in unix systems).  This give us a structure like this:</p>

<ul>
<li> IT-Repository (e.g. giteveryrepo2)

<ul>
<li>it/comp/

<ul>
<li>{computer1}

<ul>
<li>Any files you want with their full path as if under &#8216;/&#8217;</li>
</ul>
</li>
<li>{computer2}</li>
<li>{computer3}</li>
</ul>
</li>
</ul>
</li>
</ul>


<p>As long as computers have unique names, we can freely work with any computer&#8217;s files without collision
with another computer.  And because Git is distributed, we can work on files <em>on</em> any computer and
merging is very unlikely to be an issue.</p>

<p>An example of an IT repository is at:</p>

<ul>
<li> <a href="https://github.com/markfussell/giteveryrepo2">https://github.com/markfussell/giteveryrepo2</a></li>
</ul>


<p>and more specifically, the directory for computers is at:</p>

<ul>
<li> <a href="https://github.com/markfussell/giteveryrepo2/tree/master/it/comp">https://github.com/markfussell/giteveryrepo2/tree/master/it/comp</a></li>
</ul>


<p>As of this writing, there are two computers listed.  Both are EC2 machines, so they have the standard
patterns for AWS machine naming.</p>

<ul>
<li> domu-12-31-39-0e-e2-53</li>
<li> ip-10-28-81-39</li>
</ul>


<p>On each machine, I ran a script to copy from system files to the repository.  The scripts are in repo2/bin/copy
so a sequence looks like this</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>./bin/copy/copyFromSystemFile.sh /var/www/html/index.html
</span><span class='line'>git pull; git add it; git commit -m <span class="s2">&quot;Server2&quot;</span>; git push
</span></code></pre></td></tr></table></div></figure>


<p>Again, because the machines have their own directories, merging should be automatic no matter what order
or how much time-overlap occurs.  Two notes:</p>

<ul>
<li> The machine names are lower-cased to avoid confusing behavior.  I strongly recommend keeping directories all lowercase</li>
<li> If you have any binary files you are copying from the machine, you need to remember to &#8216;deflateAll&#8217; the repository before the git line.</li>
</ul>


<h4>Flattening Computers next to each other</h4>

<p>An advantage of flattening out computers next to each other is you can compare them:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>diff -r it/comp/*
</span><span class='line'>diff -r it/comp/domu-12-31-39-0e-e2-53/var/www/html/index.html it/comp/ip-10-28-81-39/var/www/html/index.html
</span><span class='line'>1c1
</span><span class='line'>&lt; domU-12-31-39-0E-E2-53
</span><span class='line'>---
</span><span class='line'>&gt; ip-10-28-81-39
</span></code></pre></td></tr></table></div></figure>


<p>In this case it should be apparent that the files have the <code>hostname</code> inside them, so that is what is changing.</p>

<p>So you can compare the history of a particular computer by looking through git history, and you can compare two
different computers to each other by comparing the different directories that each computer owns.</p>

<h3>Copy files from the IT repo</h3>

<p>There is also a script to copy from the IT repo to a particular system location.  This is a little more
risky, but can be useful at times.  Effectively this would roll back your local change if you didn&#8217;t touch
the repo from anywhere else, and it can be used to document a proposed change before applying it.  This
leads to more of &#8216;git for IT automation&#8217; though, which I will cover later.</p>

<h2>Software installation</h2>

<p>Software installation is the major part of machine provisioning.  Unless you have a fully-baked AMI or
really are happy with the factory install, you need to add more software to make your computer useful.
Installing software can frequently be done with &#8216;yum&#8217; and similar commands, but some software needs a
package install (e.g. with &#8216;rpm&#8217;) and some times you want more direct control of the version installed.</p>

<p>Fetching RPMs from the web at install time is a major source of automation failure and annoyance.  Sites
go down and if you are fetching from many different sites, you could have a computer with 9 out of 10
things installed on it.  Generally I try to make machine provisioning <em>all or nothing</em> : Either everything
gets installed properly or I just wipe the machine and try again.  Primordial scripted installs are
easy to write (no human interaction), but trying to recover from a partial install is
a way to become very unproductive (potentially very angry too).  Additionally, some sites can be slow
and you don&#8217;t want to be penalized by that for every computer you provision.</p>

<p>A solution is to store RPMs and the like in an Annexed Git repository.  S3 is both very fast and very reliable,
with an SLA that &#8216;guarantees&#8217; four nines (99.99%) of uptime a year, which is &lt; 1-hour of downtime.  If
all install packages are stored in S3, provisioning would be almost solely dependent on S3, so it would
always be an <em>all (99.99%) or nothing (00.01%)</em> provisioning model.</p>

<h3>Example and idioms</h3>

<p>You could put RPMs and the like anywhere you want since the annexing is orthogonal to file location,
but I conventionally put things in &#8216;it/resource&#8217;</p>

<ul>
<li> <a href="https://github.com/markfussell/giteveryrepo2/tree/master/it/resource">https://github.com/markfussell/giteveryrepo2/tree/master/it/resource</a></li>
</ul>


<p>An annexed repo will also tend to have a &#8216;.temp&#8217; directory in the &#8216;.gitignore&#8217;, so that is a handy place
to do temporary work without risk of colliding with changes to the repository itself.  When you inflate a file,
it is &#8216;dirty&#8217; / changed so it could conflict with a subsequent merge and you would have to either deflate
or &#8216;git checkout&#8217; the file/s to clean up.  Worse would be an archive that expanded into a directory structure,
so it is generally nice to work in &#8216;.temp&#8217; where these aspects don&#8217;t cause issues.</p>

<p>In giteveryrepo2 there is a Java-7 rpm, which can be installed as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">pushd</span> /root/gitrepo/giteveryrepo2
</span><span class='line'>git pull
</span><span class='line'>mkdir -p .temp
</span><span class='line'>cp it/resource/jdk-7u13-linux-x64.rpm .temp
</span><span class='line'>./bin/inflatePaths.sh .temp/
</span><span class='line'>rpm -i .temp/jdk-7u13-linux-x64.rpm
</span><span class='line'>/usr/java/default/bin/java -version
</span></code></pre></td></tr></table></div></figure>


<p>Similarly for installing Apache Tomcat:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">pushd</span> /root/gitrepo/giteveryrepo2
</span><span class='line'>git pull
</span><span class='line'>mkdir -p .temp
</span><span class='line'>
</span><span class='line'>cp it/resource/apache-tomcat-7.0.35.tar.gz .temp
</span><span class='line'>./bin/inflatePaths.sh .temp/
</span><span class='line'>
</span><span class='line'><span class="nb">pushd</span> .temp
</span><span class='line'>tar -xvf apache-tomcat-7.0.35.tar.gz
</span><span class='line'>mv apache-tomcat-7.0.35 /usr/share
</span><span class='line'>ln -s /usr/share/apache-tomcat-7.0.35 /usr/share/tomcat7
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nb">popd</span>
</span></code></pre></td></tr></table></div></figure>


<p>And just to show the install actually works.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>cat &gt; /etc/httpd/conf.d/proxy_ajp.conf <span class="s">&lt;&lt;EOS</span>
</span><span class='line'><span class="s">ProxyPass /tomcat/ ajp://localhost:8009/</span>
</span><span class='line'><span class="s">EOS</span>
</span><span class='line'>
</span><span class='line'>service httpd restart
</span><span class='line'>
</span><span class='line'>/usr/share/tomcat7/bin/startup.sh
</span></code></pre></td></tr></table></div></figure>


<p>should bring up a standard Tomcat welcome screen.</p>

<p><img width="743" height="352" src="http://markfussell.emenar.com/images/git-about-everything-it/TomcatScreenshot1.png" /></p>

<h2>Backups</h2>

<p>Backing up database dumps, logs, etc. is as easy as copying them into an appropriate folder within the repo and deflating.
This is similar to IT changes: you just put things in a reasonable location on the machine and then</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>./bin/copy/copyFromSystemFile.sh <span class="o">{</span>reasonable-location<span class="o">}</span>
</span><span class='line'>./deflateAll.sh
</span><span class='line'>git pull; git add it; git commit -m <span class="s2">&quot;Backup of `hostname` as of `date`&quot;</span>; git push
</span></code></pre></td></tr></table></div></figure>


<p>This bascially works fine, with two minor issues:</p>

<ul>
<li> You probably want the backup repo to be different from the IT repo even though their layout would be similar.  You wouldn&#8217;t want a bunch of &#8216;backup&#8217; activity happening on something you are using for IT maintenance or even machine provisioning.  The rhythm and types of commits would be inconsistent.</li>
<li> At some point, you are going to have <em>too many backups</em> and you need to get rid of some noise.  This is &#8216;cleaning the annex&#8217;</li>
</ul>


<h3>Cleaning the Annex</h3>

<p>By default the Annex has a copy of every &#8216;big&#8217; file you have ever annexed in the history of the repository.  Given S3 doesn&#8217;t
cost very much, this may never be an issue for you.  But if it is an issue, you need to throw out the garbage.  There
are fancier versions of this process but the simplest involves:</p>

<ul>
<li> Removing any files you no longer want to keep around from the current HEAD of git.  So if you have 1000 backups in the filesystem and want less than that, delete and commit the ones to get rid of.  Ideally this is completely automated as part of normal activities (e.g. new backups cause some older backups to be deleted)</li>
<li> Inflating the whole repository from the current Annex (Annex2a)</li>
<li> Changing the current Annex to point to a new empty Annex (Annex2b)</li>
<li> Deflating the whole repository to the new Annex (Annex2b)</li>
<li> Committing the change of Annex into git</li>
</ul>


<p>Note that at this point you have the option to delete the old annex or not.  If you leave it around you have a &#8216;shiny new&#8217;
cleaner Annex2b which can make some things go faster, but if you ever want to go back to an old version it will work too.
Because the annex information is in the version, checking out an old version will automatically switch the annex to use
with it too.</p>

<p>The &#8216;moveToNewAnnex.sh&#8217; script looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>die <span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="nb">echo</span> &gt;&amp;2 <span class="s2">&quot;$@&quot;</span>
</span><span class='line'>    <span class="nb">exit </span>1
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">[</span> <span class="s2">&quot;$#&quot;</span> -eq 1 <span class="o">]</span> <span class="o">||</span> die <span class="s2">&quot;1 argument required, $# provided&quot;</span>
</span><span class='line'><span class="nb">echo</span> <span class="nv">$1</span> | grep -E -q <span class="s1">&#39;^s3://&#39;</span> <span class="o">||</span> die <span class="s2">&quot;S3 bucket URL required, $1 provided&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="nb">export </span><span class="nv">NEW_ANNEX</span><span class="o">=</span><span class="s2">&quot;$1&quot;</span>
</span><span class='line'>
</span><span class='line'>./bin/inflatePaths.sh .
</span><span class='line'>
</span><span class='line'><span class="nb">echo</span> <span class="nv">$NEW_ANNEX</span> &gt; s3info/s3annex_config.txt
</span><span class='line'>
</span><span class='line'>./deflateAll.sh
</span></code></pre></td></tr></table></div></figure>


<p>An example using the contents of &#8216;giteveryrepo2&#8217;:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#Remove the temp directory since we don&#39;t want to annex it</span>
</span><span class='line'>rm -fr .temp
</span><span class='line'>
</span><span class='line'>./bin/moveToNewAnnex.sh s3://emenar.com/gitevery/giteveryrepo2v2/
</span><span class='line'>git status
</span><span class='line'>git diff s3info/s3annex_config.txt
</span><span class='line'>
</span><span class='line'><span class="c">#Go back to previous annex again</span>
</span><span class='line'>
</span><span class='line'>git checkout -- s3info/s3annex_config.txt
</span><span class='line'>git status
</span></code></pre></td></tr></table></div></figure>


<p>It would be &#8216;more optimal&#8217; to go directly from S3 -> S3, but the above works well enough if you have decent bandwidth
and especially if you are within EC2.</p>

<h2>Summary</h2>

<p>Annexed git repositories can make certain IT activities much easier, more reliable, or more powerful (diff two machines&#8217; configurations).
The above wasn&#8217;t showing IT automation, but it shows a valuable tool for IT automation as well as more manual interactions.</p>

<h2>Next</h2>

<p>Our next problem will be <a href="http://markfussell.emenar.com/blog/git-about-everything-it-automation/">IT Automation</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Being a git about everything (Annexing)]]></title>
    <link href="http://markfussell.emenar.com/blog/git-about-everything-annex/"/>
    <updated>2013-01-13T18:16:00-08:00</updated>
    <id>http://markfussell.emenar.com/blog/git-about-everything-annex</id>
    <content type="html"><![CDATA[<p>This is the second in a series of using git as part of interesting solutions to problems.</p>

<p>The first is here: <a href="http://markfussell.emenar.com/blog/git-about-everything-intro/">Intro</a></p>

<h2>Dealing with Binary Files</h2>

<p>As mentioned in the first posting, git and similar DVCS have issues with binary files.  Adding 100s of 10MB files, or 100s of
versions of 10MB files will produce gigabytes worth of data that must be cloned by everyone using the repository.  How do we avoid this?</p>

<p>There are a number of solutions in this space out there with differing characteristics, but the core approach is usually similar:
&#8220;Don&#8217;t store it in git&#8221;.  Instead we want to record enough information to retrieve the binary files from somewhere else.</p>

<!-- more -->


<h2>Record Enough of the Binary File</h2>

<p>What is
enough information?  How about 160 bits!  Using SHA1 or any similar hash, we can identify the contents of any file.  To add
a bit of consistency and readability, we will make this hex-based, so we get 40 characters.  And to make it a little clearer what
hash was used and what this string is, we add &#8216;sha1_&#8217; to the front and &#8216;.blob&#8217; to the end.  Now our 10MB file has become 50 to 52 bytes depending on
human-entered white spaces.  For example:</p>

<ul>
<li> sha1_8ac02ee34b94461fed19320d789f251e6a2a6796.blob</li>
<li> SHA1-Hash = 8ac02ee34b94461fed19320d789f251e6a2a6796</li>
<li> Google test: <a href="http://www.google.com/search?q=8ac02ee34b94461fed19320d789f251e6a2a6796">http://www.google.com/search?q=8ac02ee34b94461fed19320d789f251e6a2a6796</a></li>
</ul>


<p>And we have confirmed that the hash is enough to identify that file&#8217;s content (and the file itself if it has a unique name).</p>

<p>Storing tens of thousands of 50Byte files is still under a few megabytes, so that part is good.</p>

<h2>Put the content into the Cloud (or similar)</h2>

<p>Where should we store the actual content?  Pretty much anywhere we want if things are simple (only a few files at a time to store and retrieve, need
only local access), but
if we want to store and retrieve thousands of files from anywhere rapidly things get nastier.  For example, there are projects that try to
hide the process of file-contents being moved elsewhere using git smudge/clean filters.  Unfortunately this make the process all of: sequential, heavy, and
perpetual.  We would have similar major issues if we moved the content via some other sequential approach that was not super-fast.  And
git is meant to be highly distributed, so our approach needs to work for all the &#8216;clones&#8217; of a repository.  And finally, we don&#8217;t
want to break our bank over this.</p>

<p>The solution?  Amazon S3 or similar.  Amazon S3 is:</p>

<ul>
<li> Relatively inexpensive for what it does (about a dime a month for 1GB)</li>
<li> Highly distributed</li>
<li> Reasonably fast in network transfers</li>
<li> Incredibly fast as you throw more workers at the network transfers</li>
<li> Blazingly fast if you throw many workers from EC2 at it</li>
</ul>


<p>So if we want to move files from our Git repository into S3, how do we do that?  This isn&#8217;t really a git issue at all if we do
it before &#8216;add&#8217; and after &#8216;pull&#8217;.  It becomes
a simple filesystem-to-S3 issue and s3cmd <a href="http://s3tools.org/s3cmd">http://s3tools.org/s3cmd</a> is a very well trusted tool for this.
Add in the parallel patch <a href="https://github.com/pcorliss/s3cmd-modification">https://github.com/pcorliss/s3cmd-modification</a> and
you can have any numbers of workers running.  We want to be a &#8216;git&#8217; about everything, but we can solve this issue independently
of git and combine the two.  The only large remaining issues are the actual processes of:</p>

<ul>
<li> &#8216;deflating&#8217;: moving the content of a file somewhere and leaving a content-hash in its place.</li>
<li> &#8216;inflating&#8217;: replacing a content-hash with the actual content</li>
</ul>


<p>A highly annex-augmented version of s3cmd is here <a href="https://github.com/markfussell/s3annex">https://github.com/markfussell/s3annex</a>
and was done while working at <a href="http://www.rumblegames.com">Rumble</a> where we needed to move gigabytes of high-quality art assets around
as part of the build-deploy pipeline.</p>

<p>The architectural design looks a bit like this:</p>

<p><img width="743" height="352" src="http://markfussell.emenar.com/images/git-about-everything-annex/annex_architecture.png" /></p>

<p>where the GH/BB repository in the upper left is just symbolizing pushing to some central repo.  It isn&#8217;t required for the
annex concept, but is standard Git behavior.</p>

<h2>Working with S3 Annexed Git Repositories</h2>

<p>The three things you need for an S3-Annexed repository are:</p>

<ul>
<li> A git repository</li>
<li> An S3 bucket to put content into</li>
<li> The augmented s3cmd from here <a href="https://github.com/markfussell/s3annex">https://github.com/markfussell/s3annex</a></li>
</ul>


<p>A repository that is paired with an S3 bucket is located here:</p>

<ul>
<li> <a href="https://github.com/markfussell/giteveryrepo1">https://github.com/markfussell/giteveryrepo1</a></li>
</ul>


<p>You can clone that repository and get a working annexed-repository and some example content (without write permission).  The repository is tiny but
grants access to several megabytes worth of images.</p>

<h3>Configuration</h3>

<p>The configuration of the Annex is located in &#8216;s3info&#8217;:</p>

<ul>
<li> blob_includes.txt &mdash; The file extensions you want annexed</li>
<li> s3annex_config.txt &mdash; The location of the annex</li>
<li> s3cmd_config.txt &mdash; Some s3cmd configuration, but most importantly the access/secret</li>
<li> s3worker_config.txt &mdash; The number of workers used for annexing</li>
</ul>


<h4>blob_includes</h4>

<p>The blob_includes should be updated with any new file types you want annexed.  To make things fast and simple, annexing is
based on file extensions not size or other properties.  It would be nice if this was more automatic, but being explicit
was simple and very visible.</p>

<h4>s3annex_config</h4>

<p>This is simply the location of the annex.  This can change over time as a quick way to do &#8216;garbage collection&#8217;
but normally it stays the same.  Because of the content-based approach, you can share annexes across many
repositories.</p>

<h4>s3cmd_config</h4>

<p>The s3cmd configuration including access credentials.  If you don&#8217;t want access credentials in the repository itself, you could take out the s3cmd_config file and it should use your defaults (you may need to tweak a couple scripts).</p>

<h4>s3worker_config</h4>

<p>The number of s3workers to run at a time.  More workers will make the S3 combined throughput faster: this should be 100 or more on an EC2 instance.</p>

<h3>Working commands</h3>

<p>All the commands expect to be run from the root of the git repository.  The main working commands are:</p>

<ul>
<li> bin/deflatePaths.sh &mdash; Move the contents of files into the Annex and replace them with a hash stub/reference</li>
<li> bin/inflatePaths.sh &mdash; Put the proper contents of the files into the filesystem based on their hash stub/reference</li>
</ul>


<p>Because annexed repositories should always be fully deflated before committing, there is a command in the root of the directory to
remind people of this:</p>

<ul>
<li> deflateAll.sh &mdash; Visible reminder and simple equivalent to &#8216;bin/deflatePaths.sh .&#8217;</li>
</ul>


<p>These commands are all you need for annexing proper.  To make it easier to see the Annex itself, there is also an &#8216;lsAnnex.sh&#8217;
script which is used below.</p>

<h3>Annex (S3) Layout</h3>

<p>The layout of the Annex within the S3 bucket is either:</p>

<ul>
<li> Flat in a single bucket plus path prefix</li>
<li> Hierarchical based on some amount of leading hash digits</li>
</ul>


<p>The completely flat version is the simpler and truer representation.
The hierarchy simply allows multiple threads to get listings of the annex files in parallel, which
matters for performance when you have thousands of files within the annex.</p>

<h4>Annex listing</h4>

<p>You can see the contents of the annex with:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>./bin/lsAnnex.sh
</span></code></pre></td></tr></table></div></figure>


<p>For the example repository, this gives:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>2013-01-22 00:04   4742594   s3://emenar.com/gitevery/giteveryrepo1/sha1_02bf4b647b623dac68e1913b8d3494856041047c.blob
</span><span class='line'>2013-01-22 00:11   4742594   s3://emenar.com/gitevery/giteveryrepo1/sha1_02bf4b647b623dac68e1913b8d3494856041047c.blob__.jpg
</span><span class='line'>2013-01-22 00:10   2679517   s3://emenar.com/gitevery/giteveryrepo1/sha1_2abd18dfa4510e1dfc72f643bff3639b42f2aa32.blob
</span><span class='line'>2013-01-22 00:15   2679517   s3://emenar.com/gitevery/giteveryrepo1/sha1_2abd18dfa4510e1dfc72f643bff3639b42f2aa32.blob__.jpg
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, in the annex are files that start with &#8216;sha1_&#8217; and end in &#8216;.blob&#8217; or &#8216;.blob__.xxx&#8217; where &#8216;.xxx&#8217; is a proper MIME extension.
The reason for the MIME extension is just that it can be useful to see or directly retrieve the content
with proper interpretation.  The normal Annex behavior only uses the &#8216;.blob&#8217; version.</p>

<p>The names of the files in the Annex match the &#8216;sha1&#8217; hash of the contents of the file.  So &#8216;sha1_55b15eb3ac72351249125a3de7a81aee2bda6a2a.blob__.jpg&#8217;
has a sha1 hash of &#8216;55b15eb3ac72351249125a3de7a81aee2bda6a2a&#8217;.  It is impossible for files to collide unless they are exactly the same
content, so a completely flat representation is correct and simple.</p>

<h3>Example Walk-through</h3>

<p>If you cloned the example repository:</p>

<ul>
<li> <a href="https://github.com/markfussell/giteveryrepo1">https://github.com/markfussell/giteveryrepo1</a></li>
</ul>


<p>you should have something less than a megabyte, but it represents more than 100MB of image files (30 images of 3MB each).  But all the image
files are stubbed out with just the content hash inside.</p>

<p>To see example details of these stubbed/annexed files, look inside any of the jpg files in <code>image/album</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">echo</span> -n <span class="s2">&quot;content: &quot;</span>; cat image/album/GitEverythingAlbum_01.jpg ; <span class="nb">echo</span>
</span></code></pre></td></tr></table></div></figure>


<p>This returns the blob identifier:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>content: sha1_55b15eb3ac72351249125a3de7a81aee2bda6a2a.blob
</span></code></pre></td></tr></table></div></figure>


<h4>Inflating a file</h4>

<p>To inflate a file, run <code>./bin/inflatePaths.sh</code> with the specific file path:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>./bin/inflatePaths.sh image/album/GitEverythingAlbum_01.jpg
</span></code></pre></td></tr></table></div></figure>


<p>And you will get some feedback:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>INFO: Compiling list of <span class="nb">local </span>files <span class="k">for</span> <span class="s1">&#39;file://image/album/GitEverythingAlbum_01.jpg&#39;</span>, <span class="s1">&#39;GitEverythingAlbum_01.jpg&#39;</span>, <span class="s1">&#39;image/album/GitEverythingAlbum_01.jpg&#39;</span>
</span><span class='line'>INFO: Applying --exclude/--include
</span><span class='line'>INFO: Retrieving list of remote files <span class="k">for </span>s3://emenar.com/gitevery/giteveryrepo1/ ...
</span><span class='line'>INFO: Summary: 1 <span class="nb">local </span>files to fetch, 60 remote files present
</span><span class='line'>INFO: Inflating<span class="o">[</span>1<span class="o">]</span> from S3 <span class="o">(</span>1<span class="o">)</span> <span class="o">(</span>sha1_55b15eb3ac72351249125a3de7a81aee2bda6a2a.blob<span class="o">)</span>: image/album/GitEverythingAlbum_01.jpg &lt;- s3://emenar.com/gitevery/giteveryrepo1/sha1_55b15eb3ac72351249125a3de7a81aee2bda6a2a.blob
</span><span class='line'>s3://emenar.com/gitevery/giteveryrepo1/sha1_55b15eb3ac72351249125a3de7a81aee2bda6a2a.blob -&gt; image/album/GitEverythingAlbum_01.jpg  <span class="o">[</span>1 of 1<span class="o">]</span>
</span><span class='line'> 4960530 of 4960530   100% in    7s   633.43 kB/s  <span class="k">done</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now you should have a normal file and can view a picture of Nob Hill.</p>

<p>Note that <code>git status</code> will now show a change.  The approach here is not to hide or conflate annexing within git (e.g. being part of smudge),
but to create something that when combined with normal git makes git even more useful.</p>

<h4>Deflating a file</h4>

<p>Since we are in a git repository, we could simply do a reset to get the file back to it&#8217;s original content
(it is already annexed) but it is much safer to always
&#8216;deflate&#8217; in case the contents changed vs. being the same as the original commit.</p>

<p>To deflate a single file you run <code>./bin/deflatePaths.shs</code> with the specific file path:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>./bin/deflatePaths.sh image/album/GitEverythingAlbum_01.jpg
</span></code></pre></td></tr></table></div></figure>


<p>Because the contents are the same, you should see this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>INFO: Compiling list of <span class="nb">local </span>files <span class="k">for</span> <span class="s1">&#39;file://image/album/GitEverythingAlbum_01.jpg&#39;</span>, <span class="s1">&#39;GitEverythingAlbum_01.jpg&#39;</span>, <span class="s1">&#39;image/album/GitEverythingAlbum_01.jpg&#39;</span>
</span><span class='line'>INFO: Applying --exclude/--include
</span><span class='line'>INFO: Retrieving list of remote files <span class="k">for </span>s3://emenar.com/gitevery/giteveryrepo1/ ...
</span><span class='line'>INFO: Summary: 1 <span class="nb">local </span>files to upload, 60 remote files already present
</span><span class='line'>INFO: Skipped    <span class="o">(</span>1<span class="o">)</span> <span class="o">(</span>sha1_55b15eb3ac72351249125a3de7a81aee2bda6a2a.blob<span class="o">)</span>: image/album/GitEverythingAlbum_01.jpg -&gt; s3://emenar.com/gitevery/giteveryrepo1/sha1_55b15eb3ac72351249125a3de7a81aee2bda6a2a.blob
</span><span class='line'>INFO: Skipped    <span class="o">(</span>1<span class="o">)</span> <span class="o">(</span>sha1_55b15eb3ac72351249125a3de7a81aee2bda6a2a.blob__.jpg<span class="o">)</span>: image/album/GitEverythingAlbum_01.jpg -&gt; s3://emenar.com/gitevery/giteveryrepo1/sha1_55b15eb3ac72351249125a3de7a81aee2bda6a2a.blob__.jpg
</span></code></pre></td></tr></table></div></figure>


<p>The original annexing of the file did upload two files, and looked like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>INFO: Upload     <span class="o">(</span>1<span class="o">)</span>: ./image/album/GitEverythingAlbum_01.jpg -&gt; s3://emenar.com/gitevery/giteveryrepo1/sha1_55b15eb3ac72351249125a3de7a81aee2bda6a2a.blob
</span><span class='line'>File <span class="s1">&#39;./image/album/GitEverythingAlbum_01.jpg&#39;</span> started <span class="o">[</span>1 of 30<span class="o">]</span>
</span><span class='line'>...
</span><span class='line'>File <span class="s1">&#39;./image/album/GitEverythingAlbum_01.jpg&#39;</span> stored as <span class="s1">&#39;s3://emenar.com/gitevery/giteveryrepo1/sha1_55b15eb3ac72351249125a3de7a81aee2bda6a2a.blob&#39;</span> <span class="o">(</span>4960530 bytes ...<span class="o">)</span> <span class="o">[</span>1 of 30<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Inflating Many Files</h4>

<p>The <code>inflate</code> and <code>deflate</code> scripts accept paths so you can inflate the whole album with:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>./bin/inflatePaths.sh image/album
</span></code></pre></td></tr></table></div></figure>


<p>or even inflate the whole repository:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>./bin/inflatePaths.sh .
</span></code></pre></td></tr></table></div></figure>


<p>With the default settings, this will launch 10 workers doing 10 files at a time in total.  How long
the whole 100MB download takes will almost likely depend on your maximum bandwidth, but if not,
just change the number of workers to a larger number.  S3 is very supportive of many requests by
different workers.</p>

<h3>EC2 Walkthrough</h3>

<p>On EC2 the performance numbers are pretty amazing, so I created a simple CloudFormation so people
can test it out.  The CloudFormation is here:</p>

<ul>
<li> <a href="https://s3.amazonaws.com/emenar.com/gitevery/aws/cloudformation/GitEverythingServer1.template">https://s3.amazonaws.com/emenar.com/gitevery/aws/cloudformation/GitEverythingServer1.template</a></li>
</ul>


<p>and it can be run by going to AWS CloudFormation and just giving it one of your keypairs:</p>

<ul>
<li> <a href="https://console.aws.amazon.com/cloudformation/">https://console.aws.amazon.com/cloudformation/</a></li>
</ul>


<h4>EC2 Performance</h4>

<p>After the instance launches, SSH in, &#8216;sudo su -&#8216;, and change to the repository:</p>

<ul>
<li> /root/gitrepo/giteveryrepo1</li>
</ul>


<p>run <code>inflatePaths</code> with the standard 10 workers</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">time</span> ./bin/inflatePaths.sh image
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>INFO: Compiling list of <span class="nb">local </span>files <span class="k">for</span> <span class="s1">&#39;file://image&#39;</span>, <span class="s1">&#39;image&#39;</span>, <span class="s1">&#39;image&#39;</span>
</span><span class='line'>INFO: Applying --exclude/--include
</span><span class='line'>INFO: Retrieving list of remote files <span class="k">for </span>s3://emenar.com/gitevery/giteveryrepo1/ ...
</span><span class='line'>INFO: Summary: 30 <span class="nb">local </span>files to fetch, 60 remote files present
</span><span class='line'>INFO: Inflating<span class="o">[</span>1<span class="o">]</span> from S3 <span class="o">(</span>1<span class="o">)</span> <span class="o">(</span>sha1_55b15eb3ac72351249125a3de7a81aee2bda6a2a.blob<span class="o">)</span>: image/album/GitEverythingAlbum_01.jpg &lt;- s3://emenar.com/gitevery/giteveryrepo1/sha1_55b15eb3ac72351249125a3de7a81aee2bda6a2a.blob
</span><span class='line'>File s3://emenar.com/gitevery/giteveryrepo1/sha1_55b15eb3ac72351249125a3de7a81aee2bda6a2a.blob started <span class="o">[</span>1 of 30<span class="o">]</span>
</span><span class='line'>INFO: Receiving file <span class="s1">&#39;image/album/GitEverythingAlbum_01.jpg&#39;</span>, please
</span><span class='line'>...
</span><span class='line'>File s3://emenar.com/gitevery/giteveryrepo1/sha1_801a329248a9cbe48b512f2a75179437382dba02.blob saved as <span class="s1">&#39;image/album/GitEverythingAlbum_21.jpg&#39;</span> <span class="o">(</span>4194668 bytes in 3.1 seconds, 1330.45 kB/s<span class="o">)</span>
</span><span class='line'>File s3://emenar.com/gitevery/giteveryrepo1/sha1_7d5d055068a9b7e268e21279770f03a5e8c6c9d3.blob saved as <span class="s1">&#39;image/album/GitEverythingAlbum_22.jpg&#39;</span> <span class="o">(</span>4576223 bytes in 3.0 seconds, 1477.96 kB/s<span class="o">)</span>
</span><span class='line'>File s3://emenar.com/gitevery/giteveryrepo1/sha1_02bf4b647b623dac68e1913b8d3494856041047c.blob saved as <span class="s1">&#39;image/album/GitEverythingAlbum_25.jpg&#39;</span> <span class="o">(</span>4742594 bytes in 2.6 seconds, 1777.42 kB/s<span class="o">)</span>
</span><span class='line'>File s3://emenar.com/gitevery/giteveryrepo1/sha1_856984959467b2427c2a4e9ade642a3d3c26b0fd.blob saved as <span class="s1">&#39;image/album/GitEverythingAlbum_20.jpg&#39;</span> <span class="o">(</span>4208680 bytes in 4.2 seconds, 971.63 kB/s<span class="o">)</span>
</span><span class='line'>File s3://emenar.com/gitevery/giteveryrepo1/sha1_7cb2e0318459e276dc4b65987bbe8bd6021357df.blob saved as <span class="s1">&#39;image/album/GitEverythingAlbum_28.jpg&#39;</span> <span class="o">(</span>3559585 bytes in 2.2 seconds, 1559.41 kB/s<span class="o">)</span>
</span><span class='line'>File s3://emenar.com/gitevery/giteveryrepo1/sha1_b855966214caa10638f76a3aba6b6df7b0caffca.blob saved as <span class="s1">&#39;image/album/GitEverythingAlbum_29.jpg&#39;</span> <span class="o">(</span>3820335 bytes in 2.2 seconds, 1718.09 kB/s<span class="o">)</span>
</span><span class='line'>File s3://emenar.com/gitevery/giteveryrepo1/sha1_2abd18dfa4510e1dfc72f643bff3639b42f2aa32.blob saved as <span class="s1">&#39;image/album/GitEverythingAlbum_30.jpg&#39;</span> <span class="o">(</span>2679517 bytes in 2.1 seconds, 1229.88 kB/s<span class="o">)</span>
</span><span class='line'>File s3://emenar.com/gitevery/giteveryrepo1/sha1_fc322e938362e0c40ccf5e09789a1cb6b6995882.blob saved as <span class="s1">&#39;image/album/GitEverythingAlbum_26.jpg&#39;</span> <span class="o">(</span>3909187 bytes in 3.0 seconds, 1285.67 kB/s<span class="o">)</span>
</span><span class='line'>File s3://emenar.com/gitevery/giteveryrepo1/sha1_fd63032739c810743521ad1de0546d67b13b4357.blob saved as <span class="s1">&#39;image/album/GitEverythingAlbum_27.jpg&#39;</span> <span class="o">(</span>3465440 bytes in 2.9 seconds, 1157.55 kB/s<span class="o">)</span>
</span><span class='line'>File s3://emenar.com/gitevery/giteveryrepo1/sha1_798788e370f243a2a38f91bf8979fd46070a4ae2.blob saved as <span class="s1">&#39;image/album/GitEverythingAlbum_24.jpg&#39;</span> <span class="o">(</span>3461363 bytes in 5.3 seconds, 634.12 kB/s<span class="o">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>real  0m10.372s
</span><span class='line'>user  0m4.311s
</span><span class='line'>sys   0m2.948s
</span></code></pre></td></tr></table></div></figure>


<p>So it took 10 seconds to download 100MB.  That is 80Mb/s on an &#8216;m1.small&#8217; which is a pretty nice number to work with.  Changing to 100 workers doesn&#8217;t make much difference (about 9 seconds),
so this is pretty much the saturation of &#8216;m1.small&#8217; to S3 performance.</p>

<p>Larger instance types can perform even better.  During a particularly grueling annexing, the performance numbers looked like this:</p>

<p><img width="743" height="352" src="http://markfussell.emenar.com/images/git-about-everything-annex/ec2performance2.png" /></p>

<p>That is getting 200MB/s <em>minimum</em> and passing 1GB/s at peaks.</p>

<h2>Summary &#8211; Annexing makes Git good at binary files</h2>

<p>By using S3 as an Annex for binary files, we can make &#8216;git&#8217; be exceptionally good at dealing with large amount of binary content.  Git simply
manages the history of 50-byte annex-stub text files, and git is very fast and efficient at doing that.  The annex-enhanced s3cmd can run many
workers to upload/deflate and download/inflate the binary files to and from S3.  Especially on EC2 the performance numbers can be super-fast:</p>

<ul>
<li> Clone repository &lt; 5 seconds</li>
<li> Inflate 100MB of files &lt; 10 seconds</li>
</ul>


<p>By combining git with a powerful annex solution, working with lots of version-controlled information
of any size has become all of: very simple, very fast, very distributable, and very inexpensive.</p>

<h3>Alternatives</h3>

<p>There are some alternative approaches out there, which I should mention.  Some I tried and they didn&#8217;t perform well
enough.  Others didn&#8217;t match the needs we had at Rumble or my needs outside of Rumble.  But they are interesting
projects:</p>

<ul>
<li> <a href="http://git-annex.branchable.com/">http://git-annex.branchable.com/</a></li>
<li> <a href="https://github.com/schacon/git-media">https://github.com/schacon/git-media</a></li>
</ul>


<h3>Next</h3>

<p>Our next problem will be <a href="http://markfussell.emenar.com/blog/git-about-everything-it/">IT</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Being a git about everything (Intro)]]></title>
    <link href="http://markfussell.emenar.com/blog/git-about-everything-intro/"/>
    <updated>2013-01-11T18:16:00-08:00</updated>
    <id>http://markfussell.emenar.com/blog/git-about-everything-intro</id>
    <content type="html"><![CDATA[<p>There are times when a new technology comes along, that at first appears to be pretty similar to
existing technology, but certain characteristics make for radically different or just nicely new solutions.
A recent example of this is &#8216;git&#8217; and similar distributed version control systems (DVCS).  They may
at first appear to be an interesting version of centralized version/content management systems, but
they are really much more&#8230; a core piece of technology useful for many things.</p>

<p>This is a series about how to use git to solve many different problems, some obvious and some more unusual.
I hope a few of them are interesting to readers.</p>

<!-- more -->


<p>There are alternative DVCSs but I am not going to compare or translate examples&#8230; at least not on a first pass.
Git was created by Linus Torvalds in 2005.  It was initially quite &#8216;raw&#8217; and still maintains much of that rawness,
but other tools (e.g. github) and general improvements have made it more accessible.  For source-code control, git has some big wins
in collaboration and offline work compared to SVN, Perforce, and the like.  Whether these are worth some trade-offs depends on your team
and company&#8230; but that is a different topic.</p>

<h2>Git Syntax / Overview</h2>

<p>You can learn more about git somewhere like github:</p>

<ul>
<li> <a href="http://learn.github.com/p/intro.html">http://learn.github.com/p/intro.html</a></li>
</ul>


<p>Git has a lot of commands, but around seven are core to standard git flows:</p>

<ul>
<li> clone &mdash; copy a repository from a remote location</li>
<li> fetch &mdash; get updates from a remote repository</li>
<li> merge &mdash; merge changes from one branch into the current branch</li>
<li> pull &mdash; &#8216;fetch&#8217; and then &#8216;merge&#8217;</li>
<li> add &mdash; add changes to the commit stage of the current branch</li>
<li> commit &mdash; commit the changes into the current branch</li>
<li> push &mdash; try to make a remote branch look like the current branch</li>
</ul>


<p>Actually of those seven &#8216;pull&#8217; basically replaces/combines two of them, so you get
down to about five with a core loop like this:</p>

<ul>
<li> clone

<ul>
<li>pull</li>
<li>make changes (if needed)

<ul>
<li>add</li>
<li>commit</li>
<li>push</li>
</ul>
</li>
</ul>
</li>
</ul>


<p>Of these commands only &#8216;push&#8217; can fail due to timing.  &#8216;push&#8217; is transactional
and you can be contending with other people or machines that pushed to the same branch
as you between when you pulled and you pushed.  Merging can fail, but that
represents some actual file-level conflict vs. a timing issue (someone beat you to the &#8216;push&#8217;).
A proper &#8216;commit&#8217; can&#8217;t fail because it is local.</p>

<h3>Repositories and branches</h3>

<p>At least to begin, all these solutions will use a standard centralized repository approach
and generally not use branches.  So you don&#8217;t have to worry about git&#8217;s ability to
deal with many remotes and which branch a given git repository is using.  By default
at any current moment there is only</p>

<ul>
<li> local: &#8216;master&#8217; <-> remote: origin/master</li>
</ul>


<p>where things get interesting because there could be 100 different machines each with their own &#8216;local&#8217;.</p>

<h3>Problems with git / DVCS</h3>

<p>The biggest issue with git and similar DVCSs is that their model doesn&#8217;t work well for large amounts of
binary assets.  Large amounts of binary assets could occur either because there are a large number of
assets available at any time but only a subset are needed (so with Perforce or SVN many people would not
check out those directories) or more commonly, a modest number of binary assets are frequently
changing.  Because a git repository contains all assets throughout time and to work with a git repository
you clone the whole thing, having a large amount of binary assets punishes everyone.</p>

<p>What is a large amount?  That depends on the circumstances, but generally passing 100MB can start to
become painful depending on the purpose git is being used for.  Having 1GB of textual files in
a single git repository (even over time) is an unusual thing.  GBs of images is common.</p>

<p>So our first problems and solution is going to have to deal with this critical issue.</p>

<p>Enter the annex: <a href="http://markfussell.emenar.com/blog/git-about-everything-annex/">Annex</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Scratch on Flash]]></title>
    <link href="http://markfussell.emenar.com/blog/scratchonflash/"/>
    <updated>2008-09-19T18:00:00-07:00</updated>
    <id>http://markfussell.emenar.com/blog/scratchonflash</id>
    <content type="html"><![CDATA[<p>The original version of this posting is on the <a href="http://scratch.mit.edu/forums/viewtopic.php?id=9982">MIT Scratch Forum</a> and the
current location of the repository is <a href="https://github.com/markfussell/scratchonflash">https://github.com/markfussell/scratchonflash</a></p>

<p>In the spirit of release early and often&#8230;</p>

<p>I have made a full bottom-to-top pass at implementing Scratch in Flash.  It can:</p>

<ul>
<li> Read a scratch project file</li>
<li> Create the project model (Stage, Sprites, Blocks, etc.)</li>
<li> Run that model (the core variable assignments, loops, etc.)</li>
<li> And do a couple of the other kinds of Sprite blocks in the &#8216;motion&#8217; and &#8216;looks&#8217; categories</li>
</ul>


<!-- more -->


<p>It most definitely does not:</p>

<ul>
<li> Respond to mouse or key events yet (but that is trivial to finish&#8230;)</li>
<li> Do all the blocks&#8230; this is going to take work to map them all into Flash and especially the Sound area could be problematic</li>
<li> Draw things properly &#8211; for one, the center of the stage is not 0,0 and the y axis is &#8216;upside-down&#8217; [I said this was &#8216;early&#8217;]</li>
<li> Run the model correctly for all control blocks.  The core concepts are there and the blocks I have tested work right [and I picked interesting ones], but I have not tested beyond a couple projects</li>
<li> Read the Sound media at all</li>
<li> Show any of the Watchers &#8211; Either variables or lists</li>
</ul>


<p>But given those caveats and all that I have forgotten, there is a demo at Scratch on Flash</p>

<p>You put a project URL into the text area and click &#8216;Open&#8217;.  Then click &#8216;Go!&#8217; and if your project responds to &#8216;Go!&#8217; things may or may not start happening :-)    Note that the URL is smart about shared projects on this site (and locates the &#8216;.sb&#8217; file automatically if you give it the project&#8217;s url) but if you use a local file system URL or some other web site, you will need to have a full path to the &#8216;.sb&#8217; file.</p>

<p>The window has a console at the bottom, a textual dump of the program above that, and has a &#8216;Step Processor&#8217; above that.  By default the program is running one step every 30th of a second, but you can turn that off or make more steps occur every 30th of a second.</p>

<p>=======================</p>

<p>It could easily be that only the one project &#8216;Tower of Hanoi&#8217; does anything interesting&#8230; probably within a short time some other projects would work too.  By default, I would probably start picking and choosing among Tutorials or the included &#8216;Projects&#8217; (is there a Gallery on the site for all the Included projects?).</p>

<p>I will release source in some format in the next release &#8211; things are pretty clean and somewhat commented, but I think I should get a little further and make sure I am not going to rename or repackage anything.  And I will need to strip out the few &#8216;Flex&#8217; references from within the core Scratch model so a smaller SWF download is possible.</p>

<p>If anyone is interested in working on this &#8211; doing Blocks and verifying that functionality is working, please let me know.  If people are interested then I will put source into a public RCS like Subversion or Git sooner than later.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Scratch Textual Language]]></title>
    <link href="http://markfussell.emenar.com/blog/scratch-textual-language/"/>
    <updated>2008-09-17T20:28:00-07:00</updated>
    <id>http://markfussell.emenar.com/blog/scratch-textual-language</id>
    <content type="html"><![CDATA[<p><a href="http://scratch.mit.edu/">Scratch</a> is a visual programming language, but it might usefully have a textual version as well.
Scratch in it&#8217;s graphical form can verify syntax intuitively &amp; automatically, and the resulting graphics are definitely beautiful, but it took quite some effort to produce
<a href="http://markfussell.emenar.com/blog/a-taste-of-scratch">these diagrams</a>
when trying to document a program, and it is even harder to reference sections of the diagram.</p>

<!-- more -->


<p>This activity came out of producing a Scratch Player in Flash, and I wanted to see whether the parse of the file produced the correct program.  A textual dump of the parse was an obvious solution, but then this &#8216;dump&#8217; might as well be the same as a complete program declaration so it was clearly &#8216;complete&#8217; and I wasn&#8217;t missing anything.</p>

<h2>Scratch Textual</h2>

<p>The core concepts in this proposed textual language for Scratch are:</p>

<ul>
<li><p>It should match Scratch as closely as possible</p></li>
<li><p>It should be a readable and easily writeable textual language (vs. XML as an interchange format)</p></li>
<li><p>It should be translatable to other human languages for the blocks (as Scratch is)</p></li>
<li><p>It should be really simple to produce and parse</p></li>
<li><p>Given Scratch is graphical, visual indentation is reasonable</p></li>
<li><p>It is not a complete &#8216;dump&#8217; of the Scratch project &#8211; no media resources are included.</p></li>
</ul>


<p>The above concepts produced the following initial choices:</p>

<ul>
<li><p>Different sections start with simple keywords: &#8220;stage:&#8221; and &#8220;sprite:&#8221; for the main objects, &#8220;vars:&#8221; and &#8216;listVars:&#8221; for declaring variables, &#8220;comment:&#8221; for a comment section, and &#8220;script:&#8221; for declaring a sequence of blocks.</p></li>
<li><p>Variables simply define their name and an initial value (if desired&#8230; otherwise it would be &#8216;0&#8217;)</p></li>
<li><p>Each block is written out textually with its &#8216;spec&#8217; &#8211; a human readable description of the block and its parameters</p></li>
<li><p>The parameters to a block (if any) come immediately after, and are preferably indented [say 4 spaces] from the block they are parameters too.  Note that the indentation is not necessary because you can tell the number of parameters from the block &#8216;spec&#8217;, but indenting makes it more readable.</p></li>
<li><p>If a block can contain other blocks, contained blocks <em>must be</em> indented [say 4 spaces] so you can tell they are inside the block vs. after the block.  This is in a fashion similar to Python.</p></li>
<li><p>There should be no blank line within a &#8216;script:&#8217; section.  The end of a script: section is the first blank (non-comment) line.</p></li>
<li><p>Comments within the textual blocks use &#8216;#&#8217; to match with Python.  Multi-line comments do not exist.  Note that Textual Comments are not parsed at all (and do not round-trip), so they should be minimal and merely augment parsing the textual source &#8211; use &#8216;comment:&#8217; for real documentation.</p></li>
<li><p>&#8216;script:&#8217; and &#8216;comment:&#8217; could have position information after them using the &#8216;loc&#8217; property (e.g. &#8220;loc = 500@250&#8221;) but this is not likely to be useful since any edits would cause positions to be wrong</p></li>
</ul>


<h3>An Example</h3>

<p>The following is a complete &#8220;normal expanded format&#8221; version.  See further below for a possible optimization to make things more vertically compressed.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
<span class='line-number'>238</span>
<span class='line-number'>239</span>
<span class='line-number'>240</span>
<span class='line-number'>241</span>
<span class='line-number'>242</span>
<span class='line-number'>243</span>
<span class='line-number'>244</span>
<span class='line-number'>245</span>
<span class='line-number'>246</span>
<span class='line-number'>247</span>
<span class='line-number'>248</span>
<span class='line-number'>249</span>
<span class='line-number'>250</span>
<span class='line-number'>251</span>
<span class='line-number'>252</span>
<span class='line-number'>253</span>
<span class='line-number'>254</span>
<span class='line-number'>255</span>
<span class='line-number'>256</span>
<span class='line-number'>257</span>
<span class='line-number'>258</span>
<span class='line-number'>259</span>
<span class='line-number'>260</span>
<span class='line-number'>261</span>
<span class='line-number'>262</span>
<span class='line-number'>263</span>
<span class='line-number'>264</span>
<span class='line-number'>265</span>
<span class='line-number'>266</span>
<span class='line-number'>267</span>
<span class='line-number'>268</span>
<span class='line-number'>269</span>
<span class='line-number'>270</span>
<span class='line-number'>271</span>
<span class='line-number'>272</span>
<span class='line-number'>273</span>
<span class='line-number'>274</span>
<span class='line-number'>275</span>
<span class='line-number'>276</span>
<span class='line-number'>277</span>
<span class='line-number'>278</span>
<span class='line-number'>279</span>
<span class='line-number'>280</span>
<span class='line-number'>281</span>
<span class='line-number'>282</span>
<span class='line-number'>283</span>
<span class='line-number'>284</span>
<span class='line-number'>285</span>
<span class='line-number'>286</span>
<span class='line-number'>287</span>
<span class='line-number'>288</span>
<span class='line-number'>289</span>
<span class='line-number'>290</span>
<span class='line-number'>291</span>
<span class='line-number'>292</span>
<span class='line-number'>293</span>
<span class='line-number'>294</span>
<span class='line-number'>295</span>
<span class='line-number'>296</span>
<span class='line-number'>297</span>
<span class='line-number'>298</span>
<span class='line-number'>299</span>
<span class='line-number'>300</span>
<span class='line-number'>301</span>
<span class='line-number'>302</span>
<span class='line-number'>303</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c">#===========================</span>
</span><span class='line'><span class="c">#=== Morph: Stage </span>
</span><span class='line'><span class="c">#===========================</span>
</span><span class='line'><span class="n">stage</span><span class="p">:</span> <span class="n">Stage</span>
</span><span class='line'>
</span><span class='line'><span class="c">#============</span>
</span><span class='line'><span class="c">#=== Vars </span>
</span><span class='line'><span class="c">#============</span>
</span><span class='line'>
</span><span class='line'><span class="nb">vars</span><span class="p">:</span>
</span><span class='line'><span class="n">talest</span><span class="o">-</span><span class="n">pole</span><span class="o">-</span><span class="n">height</span> <span class="o">=</span> <span class="mi">6</span>
</span><span class='line'><span class="n">previous</span><span class="o">-</span><span class="n">moved</span><span class="o">-</span><span class="n">disk</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'><span class="n">potential</span><span class="o">-</span><span class="n">disk</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'><span class="n">num</span><span class="o">-</span><span class="n">disks</span> <span class="o">=</span> <span class="mi">5</span>
</span><span class='line'><span class="nb">next</span><span class="o">-</span><span class="n">disk</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'><span class="n">base</span><span class="o">-</span><span class="n">disk</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>
</span><span class='line'><span class="n">listVars</span><span class="p">:</span>
</span><span class='line'><span class="n">pole</span><span class="o">-</span><span class="mi">1</span> <span class="o">=</span> <span class="n">undefined</span>
</span><span class='line'><span class="n">pole</span><span class="o">-</span><span class="mi">2</span> <span class="o">=</span> <span class="n">undefined</span>
</span><span class='line'><span class="n">moveable</span><span class="o">-</span><span class="n">disks</span> <span class="o">=</span> <span class="n">undefined</span>
</span><span class='line'><span class="n">pole</span><span class="o">-</span><span class="mi">3</span> <span class="o">=</span> <span class="n">undefined</span>
</span><span class='line'>
</span><span class='line'><span class="c">#============</span>
</span><span class='line'><span class="c">#=== Script </span>
</span><span class='line'><span class="c">#============</span>
</span><span class='line'><span class="n">script</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'><span class="n">when</span> <span class="s">&#39;find-next-disk&#39;</span>
</span><span class='line'><span class="nb">set</span> <span class="nb">next</span><span class="o">-</span><span class="n">disk</span> <span class="n">to</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>    <span class="mi">0</span>
</span><span class='line'><span class="n">broadcast</span> <span class="o">%</span><span class="n">e</span> <span class="ow">and</span> <span class="n">wait</span>
</span><span class='line'>    <span class="n">propose</span><span class="o">-</span><span class="nb">next</span><span class="o">-</span><span class="n">disk</span>
</span><span class='line'><span class="n">repeat</span> <span class="n">until</span> <span class="o">%</span><span class="n">b</span>
</span><span class='line'>    <span class="o">%</span><span class="n">n</span> <span class="o">&gt;</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>        <span class="nb">next</span><span class="o">-</span><span class="n">disk</span>
</span><span class='line'>        <span class="mi">0</span>
</span><span class='line'>    <span class="nb">set</span> <span class="n">potential</span><span class="o">-</span><span class="n">disk</span> <span class="n">to</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">%</span><span class="n">b</span>
</span><span class='line'>        <span class="ow">not</span> <span class="o">%</span><span class="n">b</span>
</span><span class='line'>            <span class="o">%</span><span class="n">n</span> <span class="o">=</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>                <span class="n">potential</span><span class="o">-</span><span class="n">disk</span>
</span><span class='line'>                <span class="n">previous</span><span class="o">-</span><span class="n">moved</span><span class="o">-</span><span class="n">disk</span>
</span><span class='line'>        <span class="nb">set</span> <span class="nb">next</span><span class="o">-</span><span class="n">disk</span> <span class="n">to</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>            <span class="n">potential</span><span class="o">-</span><span class="n">disk</span>
</span><span class='line'><span class="n">broadcast</span> <span class="o">%</span><span class="n">e</span> <span class="ow">and</span> <span class="n">wait</span>
</span><span class='line'>    <span class="n">move</span><span class="o">-</span><span class="nb">next</span><span class="o">-</span><span class="n">disk</span>
</span><span class='line'>
</span><span class='line'><span class="c">#============</span>
</span><span class='line'><span class="c">#=== Script </span>
</span><span class='line'><span class="c">#============</span>
</span><span class='line'><span class="n">script</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'><span class="n">when</span> <span class="s">&#39;Scratch-StartClicked&#39;</span>
</span><span class='line'><span class="nb">set</span> <span class="n">num</span><span class="o">-</span><span class="n">disks</span> <span class="n">to</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>    <span class="mi">5</span>
</span><span class='line'><span class="nb">set</span> <span class="n">base</span><span class="o">-</span><span class="n">disk</span> <span class="n">to</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>    <span class="o">%</span><span class="n">n</span> <span class="o">+</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>        <span class="n">num</span><span class="o">-</span><span class="n">disks</span>
</span><span class='line'>        <span class="mi">1</span>
</span><span class='line'><span class="nb">set</span> <span class="nb">next</span><span class="o">-</span><span class="n">disk</span> <span class="n">to</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>    <span class="n">num</span><span class="o">-</span><span class="n">disks</span>
</span><span class='line'><span class="n">repeat</span> <span class="n">until</span> <span class="o">%</span><span class="n">b</span>
</span><span class='line'>    <span class="o">%</span><span class="n">n</span> <span class="o">&lt;</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>        <span class="nb">next</span><span class="o">-</span><span class="n">disk</span>
</span><span class='line'>        <span class="mi">1</span>
</span><span class='line'>    <span class="nb">set</span> <span class="nb">next</span><span class="o">-</span><span class="n">disk</span> <span class="n">to</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>        <span class="o">%</span><span class="n">n</span> <span class="o">-</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>            <span class="nb">next</span><span class="o">-</span><span class="n">disk</span>
</span><span class='line'>            <span class="mi">1</span>
</span><span class='line'><span class="n">broadcast</span> <span class="o">%</span><span class="n">e</span> <span class="ow">and</span> <span class="n">wait</span>
</span><span class='line'>    <span class="n">initialize</span>
</span><span class='line'><span class="nb">set</span> <span class="n">previous</span><span class="o">-</span><span class="n">moved</span><span class="o">-</span><span class="n">disk</span> <span class="n">to</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>    <span class="mi">0</span>
</span><span class='line'><span class="nb">set</span> <span class="n">talest</span><span class="o">-</span><span class="n">pole</span><span class="o">-</span><span class="n">height</span> <span class="n">to</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>    <span class="mi">0</span>
</span><span class='line'><span class="n">repeat</span> <span class="n">until</span> <span class="o">%</span><span class="n">b</span>
</span><span class='line'>    <span class="o">%</span><span class="n">n</span> <span class="o">&gt;</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>        <span class="n">talest</span><span class="o">-</span><span class="n">pole</span><span class="o">-</span><span class="n">height</span>
</span><span class='line'>        <span class="n">num</span><span class="o">-</span><span class="n">disks</span>
</span><span class='line'>    <span class="n">broadcast</span> <span class="o">%</span><span class="n">e</span> <span class="ow">and</span> <span class="n">wait</span>
</span><span class='line'>        <span class="n">find</span><span class="o">-</span><span class="nb">next</span><span class="o">-</span><span class="n">disk</span>
</span><span class='line'>    <span class="nb">set</span> <span class="n">talest</span><span class="o">-</span><span class="n">pole</span><span class="o">-</span><span class="n">height</span> <span class="n">to</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">%</span><span class="n">b</span>
</span><span class='line'>        <span class="o">%</span><span class="n">n</span> <span class="o">&gt;</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>            <span class="n">talest</span><span class="o">-</span><span class="n">pole</span><span class="o">-</span><span class="n">height</span>
</span><span class='line'>        <span class="nb">set</span> <span class="n">talest</span><span class="o">-</span><span class="n">pole</span><span class="o">-</span><span class="n">height</span> <span class="n">to</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c">#===========================</span>
</span><span class='line'><span class="c">#=== Morph: Sprite1 </span>
</span><span class='line'><span class="c">#===========================</span>
</span><span class='line'><span class="n">sprite</span><span class="p">:</span> <span class="n">Sprite1</span>
</span><span class='line'>
</span><span class='line'><span class="c">#============</span>
</span><span class='line'><span class="c">#=== Vars </span>
</span><span class='line'><span class="c">#============</span>
</span><span class='line'>
</span><span class='line'><span class="nb">vars</span><span class="p">:</span>
</span><span class='line'><span class="n">can</span><span class="o">-</span><span class="n">move</span> <span class="o">=</span> <span class="mi">3</span>
</span><span class='line'><span class="n">am</span><span class="o">-</span><span class="n">on</span><span class="o">-</span><span class="n">top</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'><span class="n">disk</span><span class="o">-</span><span class="nb">id</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'><span class="n">pole</span> <span class="o">=</span> <span class="mi">3</span>
</span><span class='line'><span class="n">height</span> <span class="o">=</span> <span class="mi">6</span>
</span><span class='line'><span class="n">previous</span><span class="o">-</span><span class="n">pole</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'><span class="n">pole</span><span class="o">-</span><span class="n">at</span><span class="o">-</span><span class="n">start</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'>
</span><span class='line'><span class="c">#============</span>
</span><span class='line'><span class="c">#=== Script </span>
</span><span class='line'><span class="c">#============</span>
</span><span class='line'><span class="n">script</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'><span class="n">when</span> <span class="s">&#39;move-next-disk&#39;</span>
</span><span class='line'><span class="k">if</span> <span class="o">%</span><span class="n">b</span>
</span><span class='line'>    <span class="o">%</span><span class="n">n</span> <span class="o">=</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>        <span class="n">disk</span><span class="o">-</span><span class="nb">id</span>
</span><span class='line'>        <span class="nb">next</span><span class="o">-</span><span class="n">disk</span>
</span><span class='line'>    <span class="nb">set</span> <span class="n">previous</span><span class="o">-</span><span class="n">moved</span><span class="o">-</span><span class="n">disk</span> <span class="n">to</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>        <span class="n">disk</span><span class="o">-</span><span class="nb">id</span>
</span><span class='line'>    <span class="nb">set</span> <span class="n">pole</span><span class="o">-</span><span class="n">at</span><span class="o">-</span><span class="n">start</span> <span class="n">to</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>        <span class="n">pole</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">%</span><span class="n">b</span>
</span><span class='line'>        <span class="o">%</span><span class="n">b</span> <span class="ow">and</span> <span class="o">%</span><span class="n">b</span>
</span><span class='line'>            <span class="ow">not</span> <span class="o">%</span><span class="n">b</span>
</span><span class='line'>                <span class="o">%</span><span class="n">b</span> <span class="ow">or</span> <span class="o">%</span><span class="n">b</span>
</span><span class='line'>                    <span class="o">%</span><span class="n">n</span> <span class="o">=</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>                        <span class="n">previous</span><span class="o">-</span><span class="n">pole</span>
</span><span class='line'>                        <span class="mi">1</span>
</span><span class='line'>                    <span class="o">%</span><span class="n">n</span> <span class="o">=</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>                        <span class="n">pole</span>
</span><span class='line'>                        <span class="mi">1</span>
</span><span class='line'>            <span class="o">%</span><span class="n">n</span> <span class="o">&lt;</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>                <span class="n">disk</span><span class="o">-</span><span class="nb">id</span>
</span><span class='line'>        <span class="nb">set</span> <span class="n">pole</span> <span class="n">to</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>            <span class="mi">1</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">%</span><span class="n">b</span>
</span><span class='line'>        <span class="o">%</span><span class="n">b</span> <span class="ow">and</span> <span class="o">%</span><span class="n">b</span>
</span><span class='line'>            <span class="ow">not</span> <span class="o">%</span><span class="n">b</span>
</span><span class='line'>                <span class="o">%</span><span class="n">b</span> <span class="ow">or</span> <span class="o">%</span><span class="n">b</span>
</span><span class='line'>                    <span class="o">%</span><span class="n">n</span> <span class="o">=</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>                        <span class="n">previous</span><span class="o">-</span><span class="n">pole</span>
</span><span class='line'>                        <span class="mi">2</span>
</span><span class='line'>                    <span class="o">%</span><span class="n">n</span> <span class="o">=</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>                        <span class="n">pole</span>
</span><span class='line'>                        <span class="mi">2</span>
</span><span class='line'>            <span class="o">%</span><span class="n">n</span> <span class="o">&lt;</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>                <span class="n">disk</span><span class="o">-</span><span class="nb">id</span>
</span><span class='line'>        <span class="nb">set</span> <span class="n">pole</span> <span class="n">to</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>            <span class="mi">2</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">%</span><span class="n">b</span>
</span><span class='line'>        <span class="o">%</span><span class="n">b</span> <span class="ow">and</span> <span class="o">%</span><span class="n">b</span>
</span><span class='line'>            <span class="ow">not</span> <span class="o">%</span><span class="n">b</span>
</span><span class='line'>                <span class="o">%</span><span class="n">b</span> <span class="ow">or</span> <span class="o">%</span><span class="n">b</span>
</span><span class='line'>                    <span class="o">%</span><span class="n">n</span> <span class="o">=</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>                        <span class="n">previous</span><span class="o">-</span><span class="n">pole</span>
</span><span class='line'>                        <span class="mi">3</span>
</span><span class='line'>                    <span class="o">%</span><span class="n">n</span> <span class="o">=</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>                        <span class="n">pole</span>
</span><span class='line'>                        <span class="mi">3</span>
</span><span class='line'>            <span class="o">%</span><span class="n">n</span> <span class="o">&lt;</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>                <span class="n">disk</span><span class="o">-</span><span class="nb">id</span>
</span><span class='line'>        <span class="nb">set</span> <span class="n">pole</span> <span class="n">to</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>            <span class="mi">3</span>
</span><span class='line'>    <span class="nb">set</span> <span class="n">previous</span><span class="o">-</span><span class="n">pole</span> <span class="n">to</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>        <span class="n">pole</span><span class="o">-</span><span class="n">at</span><span class="o">-</span><span class="n">start</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">%</span><span class="n">b</span>
</span><span class='line'>        <span class="o">%</span><span class="n">n</span> <span class="o">=</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>            <span class="n">previous</span><span class="o">-</span><span class="n">pole</span>
</span><span class='line'>            <span class="mi">1</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">%</span><span class="n">b</span>
</span><span class='line'>        <span class="o">%</span><span class="n">n</span> <span class="o">=</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>            <span class="n">previous</span><span class="o">-</span><span class="n">pole</span>
</span><span class='line'>            <span class="mi">2</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">%</span><span class="n">b</span>
</span><span class='line'>        <span class="o">%</span><span class="n">n</span> <span class="o">=</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>            <span class="n">previous</span><span class="o">-</span><span class="n">pole</span>
</span><span class='line'>            <span class="mi">3</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">%</span><span class="n">b</span>
</span><span class='line'>        <span class="o">%</span><span class="n">n</span> <span class="o">=</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>            <span class="n">pole</span>
</span><span class='line'>            <span class="mi">1</span>
</span><span class='line'>        <span class="nb">set</span> <span class="n">height</span> <span class="n">to</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">%</span><span class="n">b</span>
</span><span class='line'>        <span class="o">%</span><span class="n">n</span> <span class="o">=</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>            <span class="n">pole</span>
</span><span class='line'>            <span class="mi">2</span>
</span><span class='line'>        <span class="nb">set</span> <span class="n">height</span> <span class="n">to</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">%</span><span class="n">b</span>
</span><span class='line'>        <span class="o">%</span><span class="n">n</span> <span class="o">=</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>            <span class="n">pole</span>
</span><span class='line'>            <span class="mi">3</span>
</span><span class='line'>        <span class="nb">set</span> <span class="n">height</span> <span class="n">to</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>
</span><span class='line'><span class="c">#============</span>
</span><span class='line'><span class="c">#=== Script </span>
</span><span class='line'><span class="c">#============</span>
</span><span class='line'><span class="n">script</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'><span class="n">when</span> <span class="s">&#39;propose-next-disk&#39;</span>
</span><span class='line'><span class="nb">set</span> <span class="n">am</span><span class="o">-</span><span class="n">on</span><span class="o">-</span><span class="n">top</span> <span class="n">to</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>    <span class="mi">0</span>
</span><span class='line'><span class="nb">set</span> <span class="n">can</span><span class="o">-</span><span class="n">move</span> <span class="n">to</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>    <span class="mi">0</span>
</span><span class='line'><span class="k">if</span> <span class="o">%</span><span class="n">b</span>
</span><span class='line'>    <span class="o">%</span><span class="n">b</span> <span class="ow">and</span> <span class="o">%</span><span class="n">b</span>
</span><span class='line'>        <span class="o">%</span><span class="n">n</span> <span class="o">=</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>            <span class="n">pole</span>
</span><span class='line'>            <span class="mi">1</span>
</span><span class='line'>        <span class="o">%</span><span class="n">n</span> <span class="o">=</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>            <span class="n">disk</span><span class="o">-</span><span class="nb">id</span>
</span><span class='line'>    <span class="nb">set</span> <span class="n">am</span><span class="o">-</span><span class="n">on</span><span class="o">-</span><span class="n">top</span> <span class="n">to</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>        <span class="mi">1</span>
</span><span class='line'><span class="k">if</span> <span class="o">%</span><span class="n">b</span>
</span><span class='line'>    <span class="o">%</span><span class="n">b</span> <span class="ow">and</span> <span class="o">%</span><span class="n">b</span>
</span><span class='line'>        <span class="o">%</span><span class="n">n</span> <span class="o">=</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>            <span class="n">pole</span>
</span><span class='line'>            <span class="mi">2</span>
</span><span class='line'>        <span class="o">%</span><span class="n">n</span> <span class="o">=</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>            <span class="n">disk</span><span class="o">-</span><span class="nb">id</span>
</span><span class='line'>    <span class="nb">set</span> <span class="n">am</span><span class="o">-</span><span class="n">on</span><span class="o">-</span><span class="n">top</span> <span class="n">to</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>        <span class="mi">1</span>
</span><span class='line'><span class="k">if</span> <span class="o">%</span><span class="n">b</span>
</span><span class='line'>    <span class="o">%</span><span class="n">b</span> <span class="ow">and</span> <span class="o">%</span><span class="n">b</span>
</span><span class='line'>        <span class="o">%</span><span class="n">n</span> <span class="o">=</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>            <span class="n">pole</span>
</span><span class='line'>            <span class="mi">3</span>
</span><span class='line'>        <span class="o">%</span><span class="n">n</span> <span class="o">=</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>            <span class="n">disk</span><span class="o">-</span><span class="nb">id</span>
</span><span class='line'>    <span class="nb">set</span> <span class="n">am</span><span class="o">-</span><span class="n">on</span><span class="o">-</span><span class="n">top</span> <span class="n">to</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>        <span class="mi">1</span>
</span><span class='line'><span class="k">if</span> <span class="o">%</span><span class="n">b</span>
</span><span class='line'>    <span class="o">%</span><span class="n">n</span> <span class="o">&gt;</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>        <span class="n">am</span><span class="o">-</span><span class="n">on</span><span class="o">-</span><span class="n">top</span>
</span><span class='line'>        <span class="mi">0</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">%</span><span class="n">b</span>
</span><span class='line'>        <span class="o">%</span><span class="n">b</span> <span class="ow">and</span> <span class="o">%</span><span class="n">b</span>
</span><span class='line'>            <span class="ow">not</span> <span class="o">%</span><span class="n">b</span>
</span><span class='line'>                <span class="o">%</span><span class="n">b</span> <span class="ow">or</span> <span class="o">%</span><span class="n">b</span>
</span><span class='line'>                    <span class="o">%</span><span class="n">n</span> <span class="o">=</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>                        <span class="n">previous</span><span class="o">-</span><span class="n">pole</span>
</span><span class='line'>                        <span class="mi">1</span>
</span><span class='line'>                    <span class="o">%</span><span class="n">n</span> <span class="o">=</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>                        <span class="n">pole</span>
</span><span class='line'>                        <span class="mi">1</span>
</span><span class='line'>            <span class="o">%</span><span class="n">n</span> <span class="o">&lt;</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>                <span class="n">disk</span><span class="o">-</span><span class="nb">id</span>
</span><span class='line'>        <span class="nb">set</span> <span class="n">can</span><span class="o">-</span><span class="n">move</span> <span class="n">to</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>            <span class="mi">1</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">%</span><span class="n">b</span>
</span><span class='line'>        <span class="o">%</span><span class="n">b</span> <span class="ow">and</span> <span class="o">%</span><span class="n">b</span>
</span><span class='line'>            <span class="ow">not</span> <span class="o">%</span><span class="n">b</span>
</span><span class='line'>                <span class="o">%</span><span class="n">b</span> <span class="ow">or</span> <span class="o">%</span><span class="n">b</span>
</span><span class='line'>                    <span class="o">%</span><span class="n">n</span> <span class="o">=</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>                        <span class="n">previous</span><span class="o">-</span><span class="n">pole</span>
</span><span class='line'>                        <span class="mi">2</span>
</span><span class='line'>                    <span class="o">%</span><span class="n">n</span> <span class="o">=</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>                        <span class="n">pole</span>
</span><span class='line'>                        <span class="mi">2</span>
</span><span class='line'>            <span class="o">%</span><span class="n">n</span> <span class="o">&lt;</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>                <span class="n">disk</span><span class="o">-</span><span class="nb">id</span>
</span><span class='line'>        <span class="nb">set</span> <span class="n">can</span><span class="o">-</span><span class="n">move</span> <span class="n">to</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>            <span class="mi">2</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">%</span><span class="n">b</span>
</span><span class='line'>        <span class="o">%</span><span class="n">b</span> <span class="ow">and</span> <span class="o">%</span><span class="n">b</span>
</span><span class='line'>            <span class="ow">not</span> <span class="o">%</span><span class="n">b</span>
</span><span class='line'>                <span class="o">%</span><span class="n">b</span> <span class="ow">or</span> <span class="o">%</span><span class="n">b</span>
</span><span class='line'>                    <span class="o">%</span><span class="n">n</span> <span class="o">=</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>                        <span class="n">previous</span><span class="o">-</span><span class="n">pole</span>
</span><span class='line'>                        <span class="mi">3</span>
</span><span class='line'>                    <span class="o">%</span><span class="n">n</span> <span class="o">=</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>                        <span class="n">pole</span>
</span><span class='line'>                        <span class="mi">3</span>
</span><span class='line'>            <span class="o">%</span><span class="n">n</span> <span class="o">&lt;</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>                <span class="n">disk</span><span class="o">-</span><span class="nb">id</span>
</span><span class='line'>        <span class="nb">set</span> <span class="n">can</span><span class="o">-</span><span class="n">move</span> <span class="n">to</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>            <span class="mi">3</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">%</span><span class="n">b</span>
</span><span class='line'>        <span class="o">%</span><span class="n">n</span> <span class="o">&gt;</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>            <span class="n">can</span><span class="o">-</span><span class="n">move</span>
</span><span class='line'>            <span class="mi">0</span>
</span><span class='line'>
</span><span class='line'><span class="c">#============</span>
</span><span class='line'><span class="c">#=== Script </span>
</span><span class='line'><span class="c">#============</span>
</span><span class='line'><span class="n">script</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'><span class="n">when</span> <span class="s">&#39;initialize&#39;</span>
</span><span class='line'><span class="nb">set</span> <span class="n">disk</span><span class="o">-</span><span class="nb">id</span> <span class="n">to</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>    <span class="mi">1</span>
</span><span class='line'><span class="nb">set</span> <span class="n">pole</span> <span class="n">to</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>    <span class="mi">1</span>
</span><span class='line'><span class="nb">set</span> <span class="n">previous</span><span class="o">-</span><span class="n">pole</span> <span class="n">to</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>    <span class="mi">0</span>
</span><span class='line'><span class="nb">set</span> <span class="n">can</span><span class="o">-</span><span class="n">move</span> <span class="n">to</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>    <span class="mi">0</span>
</span><span class='line'><span class="nb">set</span> <span class="n">am</span><span class="o">-</span><span class="n">on</span><span class="o">-</span><span class="n">top</span> <span class="n">to</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>    <span class="mi">0</span>
</span><span class='line'><span class="nb">set</span> <span class="n">height</span> <span class="n">to</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>    <span class="o">%</span><span class="n">n</span> <span class="o">+</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>        <span class="o">%</span><span class="n">n</span> <span class="o">-</span> <span class="o">%</span><span class="n">n</span>
</span><span class='line'>            <span class="n">base</span><span class="o">-</span><span class="n">disk</span>
</span><span class='line'>            <span class="n">disk</span><span class="o">-</span><span class="nb">id</span>
</span><span class='line'>        <span class="mi">1</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Vertical Compression</h3>

<p>The format above has every block on its own line.  This is readable and informative (you can see the argument types) but is vertically expansive.  Assuming parentheses or some other paired delimiter are not used for anything else in names, we could replace the argument placeholders with parentheses like below.  This gives a more lisp-like feel, at least for the inner evaluations.  If you leave one or more placeholders off, they would come from the next lines in &#8216;missing&#8217; order, kind of like a macro.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">script</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'><span class="n">when</span> <span class="s">&#39;find-next-disk&#39;</span>
</span><span class='line'><span class="nb">set</span> <span class="nb">next</span><span class="o">-</span><span class="n">disk</span> <span class="n">to</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'><span class="n">broadcast</span> <span class="p">(</span><span class="n">propose</span><span class="o">-</span><span class="nb">next</span><span class="o">-</span><span class="n">disk</span><span class="p">)</span> <span class="ow">and</span> <span class="n">wait</span>
</span><span class='line'><span class="n">repeat</span> <span class="n">until</span> <span class="p">((</span><span class="nb">next</span><span class="o">-</span><span class="n">disk</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">0</span><span class="p">))</span>
</span><span class='line'>    <span class="nb">set</span> <span class="n">potential</span><span class="o">-</span><span class="n">disk</span> <span class="n">to</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="p">(</span> <span class="p">(</span><span class="n">potential</span><span class="o">-</span><span class="n">disk</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">previous</span><span class="o">-</span><span class="n">moved</span><span class="o">-</span><span class="n">disk</span><span class="p">))</span> <span class="p">)</span>
</span><span class='line'>        <span class="nb">set</span> <span class="nb">next</span><span class="o">-</span><span class="n">disk</span> <span class="n">to</span> <span class="p">(</span><span class="n">potential</span><span class="o">-</span><span class="n">disk</span><span class="p">)</span>
</span><span class='line'><span class="n">broadcast</span> <span class="p">(</span><span class="n">move</span><span class="o">-</span><span class="nb">next</span><span class="o">-</span><span class="n">disk</span><span class="p">)</span> <span class="ow">and</span> <span class="n">wait</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[A Taste of Scratch]]></title>
    <link href="http://markfussell.emenar.com/blog/a-taste-of-scratch/"/>
    <updated>2008-09-08T04:15:00-07:00</updated>
    <id>http://markfussell.emenar.com/blog/a-taste-of-scratch</id>
    <content type="html"><![CDATA[<p>One of my favored books in the 1980s was ‘A Taste of Smalltalk’. This was a very short book that gave you the flavor of Smalltalk programming (the language and IDE) as compared to Pascal, C, and Lisp. I believe it is always important to show multiple programming languages for concepts and this book followed that rule. The goal of this post-series is to take ‘A Taste of Smalltalk’ and apply it to Scratch (a visual programming language).  This is the third of my comparisons in this series, where the first one was in Ruby.</p>

<!-- more -->


<p>You can find the original book here:</p>

<ul>
<li><p><a href="http://www.iam.unibe.ch/~ducasse/FreeBooks/Taste/">A Taste of Smalltalk</a></p></li>
<li><p><a href="http://stephane.ducasse.free.fr/FreeBooks.html">Free Smalltalk Books</a></p></li>
</ul>


<p>Given the original book is available online, I will not repeat it.</p>

<p>You can both see the example in Scratch and get tools and background on the Scratch project at:
<a href="http://scratch.mit.edu/projects/parseroo/260752">Tower of Hanoi</a>.  The scratch tools and the community web site are free.</p>

<h2>Tower of Hanoi &#8211; Object-Oriented (V4) &#8211; Scratch</h2>

<p>The standard pattern for this series is to translate as closely as possible each of the chapters in &#8220;A Taste of Smalltalk&#8221; to the new target language.  This worked reasonably well for Ruby and Flex &#8211; the Smalltalk was translated and interesting features of the language came out with each translation.  But this approach utterly fails for Scratch because the first two &#8216;models&#8217; of the Hanoi algorithm are completely dependent on recursion, which Scratch does not have.  Even the third, stack-less version of Hanoi requires inter-object calls that Scratch can not handle.  So <em>none</em> of the algorithms within &#8220;A Taste of Smalltalk&#8221; can be directly translated to Scratch.</p>

<p>This might appear to be a limitation of the language (and in some ways it certainly is), but somewhat impressively, I believe thinking about this problem, with the restrictions of Scratch, actually leads to a better design solution than any of the ones in the book.  It is certainly a very object-oriented solution, where the &#8216;Hanoi Disks&#8217; have a lot of intelligence and are made as responsible as possible for figuring out what to do next.  This version of the algorithm, I will call &#8216;V4&#8217;.</p>

<h3>The V4 Algorithm</h3>

<p>The V4 Algorithm works as follows:</p>

<ol>
<li><p>Ask each of the disks whether they have a legal move</p></li>
<li><p>Decide which of the disks with a legal move should move</p></li>
<li><p>Tell that disk to move</p></li>
</ol>


<p>The interesting parts of this algorithm are that:</p>

<ul>
<li><p>Step 1 can be completely parallel.  You can ask 1 to 1000000 disks at the same moment whether they have a legal move.</p></li>
<li><p>Step 2 is really trivial: just don&#8217;t move the same disk you did last time</p></li>
</ul>


<p>Compared to the V3 version, the V4 version puts more intelligence in the disks (and less in the tower), couples them less, and supports mass parallel-execution.  The parallel-execution is not useful in Hanoi, but the concepts behind it are definitely very interesting &#8211; and Scratch&#8217;s restrictions forces this kind of &#8216;sophisticated&#8217; approach [or at least it forced me down this path to maintain code-sanity and maintainability].</p>

<h3>The main Scratch Player view</h3>

<p>Scratch is designed to be an easy-to-learn language and environment.  Its heritage is along the lines of the spirit of Logo: there is a Stage drawing area and a default Sprite (a Cat) that you interact with for animation and drawing.  But this Stage can also show the variables involved with the program.  So it produces a nice overview of the whole Hanoi program:</p>

<p><a href="http://chimu.files.wordpress.com/2008/09/atasteofscratch_d3.png"><img src="http://chimu.files.wordpress.com/2008/09/atasteofscratch_d3.png" alt="" /></a></p>

<p>Not all application variables are shown, but those shown are the most important ones.  The details of the variables will be gone over later, but some are self-evident:</p>

<ul>
<li><p>num-disks: The number of disks (the height) of the Tower of Hanoi</p></li>
<li><p>pole-#: A List (treated as a Stack) of Disk identifiers, where &#8216;6&#8217; = a base (immovable) disk</p></li>
<li><p>movable-disks: A List of disks that can be moved.  This is transitory for each iteration of the algorithm.</p></li>
</ul>


<p>If you click the &#8216;Green Flag&#8217;, the program executes and on pretty much every step the display is updated, so you can see disks being proposed and moved (in both animation and variables).  Independently of Scratch having a graphical programming language, it has a very nice graphical development and run environment.</p>

<h3>Application Variables</h3>

<p>The application variables are shown below.  All of these are &#8216;Globals&#8217; and can be accessed by any object.  Those variables colored in red are lists and those colored in orange are numbers/strings/etc.  All the variables that have check-marks next to them are being displayed on top of the Stage above.</p>

<p><a href="http://chimu.files.wordpress.com/2008/09/atasteofscratch_d1.png"><img src="http://chimu.files.wordpress.com/2008/09/atasteofscratch_d1.png" alt="" /></a></p>

<p>There is no such thing as a &#8216;local&#8217; variable (private to a block of code), so it might be useful to use a naming prefix to differentiate between &#8216;local&#8217; variables (like &#8216;potential-disk&#8217;) from instance variables and even &#8216;parameter&#8217; variables that go with a broadcast (&#8216;next-disk&#8217;).  But in-the-small, that is not particularly important.</p>

<h3>Application Initialization</h3>

<p>Now that we have an overview of the application and its global state variables, we can start working through the algorithm itself.  The main &#8216;Object&#8217; in Scratch is the Stage, and I made this own the outer-most aspects of the Hanoi application and algorithm.  The first activity is &#8216;Initialization&#8217;, which is triggered by the &#8216;Green Flag&#8217; [my particular choice].</p>

<p><a href="http://chimu.files.wordpress.com/2008/09/atasteofscratch_d2.png"><img src="http://chimu.files.wordpress.com/2008/09/atasteofscratch_d2.png" alt="" /></a></p>

<p>Because this is the first example of Scratch, I will walk through the sections of the code and what they do with a few visual marker numbers (see the right column of blue).</p>

<p>When the Stage gets the Green Flag event:</p>

<ol>
<li><p>It sets the number of disks to &#8216;5&#8217;.  This is hard-coded because Scratch is currently unable to clone Sprites (objects) on the fly, so we have to precreate all the needed sprites.  In any case, this is simple enough to change if someone wants.  The additional variable &#8216;base-disk&#8217; is defined so it can be used below.  &#8216;base-disk&#8217; is just a local variable and is never used again. After this, we just clear the lists so they are &#8216;clean&#8217;</p></li>
<li><p>Next we add the &#8216;base-disk&#8217; to the bottom of each pole.  The base-disks are invisible and immovable (no matching Sprite/Object), so this is a very clean way of making the algorithm simpler later on.</p></li>
<li><p>Next we add the disks to &#8216;pole-1&#8217; using what should be another local variable.  Later I reuse this variable [something I don&#8217;t like doing] just because we otherwise have a clutter of variables.</p></li>
<li><p>Next we send out a broadcast to <em>all objects</em> telling them to initialize themselves.  There is no direct message send to an object, so it is up to the other objects to know what to respond to and what to ignore.  The broadcast waits until all object&#8217;s acknowledge they are finished.</p></li>
<li><p>Finally, we go into the main loop.  Until all the disks have moved to a new pole, we will execute &#8216;find-next-disk&#8217; which both finds and moves the next disk.  When we are done, we make a noise :-)</p></li>
</ol>


<h3>Find and Move Next Disk</h3>

<p>The main part of the algorithm has some nice aspects and some nastier aspects.  The nice side: We simply send out a broadcast of &#8216;propose-next-disk&#8217;, which all Disks should respond to by adding themselves to &#8216;movable-disks&#8217; if they have a desire to move.  This will only ever be one or two movable disks at any given time.  One of those disks may have been moved immediately previously, so we skip over it.  The selected disk is put into &#8216;next-disk&#8217; and another broadcast goes out &#8220;move-next-disk&#8221;.  The second broadcast is not really a broadcast.  It is a message send to &#8216;next-disk&#8217;, but it is only by the disks themselves ignoring a broadcast that isn&#8217;t to them that it becomes a message send.  So that is slightly nasty.</p>

<p>In any case, the code is pretty clean and concise, and this ends the code on the Stage itself.  The rest of the algorithm is on the Disks.</p>

<p><a href="http://chimu.files.wordpress.com/2008/09/atasteofscratch_d4.png"><img src="http://chimu.files.wordpress.com/2008/09/atasteofscratch_d4.png" alt="" /></a></p>

<h3>Disks Variables</h3>

<p>The Disks have access to all the Stage global variables.  In addition, each Sprite can have its own instance-private variables, which are either true instance variables (&#8216;disk-id&#8217;, &#8216;pole&#8217;, &#8216;previous-pole&#8217;) or would be local variables if Scratch supported them (&#8216;can-move&#8217;, &#8216;am-on-top&#8217;, etc.)</p>

<p><a href="http://chimu.files.wordpress.com/2008/09/atasteofscratch_d5.png"><img src="http://chimu.files.wordpress.com/2008/09/atasteofscratch_d5.png" alt="" /></a></p>

<p>Instance variables can be displayed on the Stage also, but this becomes overwhelming if all instances are turned on.</p>

<h3>Disk Initialization</h3>

<p>Upon receiving the &#8216;initialize&#8217; broadcast, all Disks set their &#8216;disk-id&#8217; (which must be different for each disk), and then set themselves up properly in size, color, and move onto the correct pole.</p>

<p><a href="http://chimu.files.wordpress.com/2008/09/atasteofscratch_d6.png"><img src="http://chimu.files.wordpress.com/2008/09/atasteofscratch_d6.png" alt="" /></a></p>

<h3>Propose Next Disk</h3>

<p>Scratch has certain deficiencies that rear their heads badly in the Hanoi code.  The concept of Propose Next Disk is as simple as:</p>

<pre><code>If 
   * I am on-top of a pole 
   * And I can move to a new pole (with a bigger disk on its top) 
   * And that new pole isn't the pole I just came from
Then
   * Add myself to the movable-disks list
</code></pre>

<p>But because Scratch (or my knowledge of Scratch) is deficient in dynamic referencing of variables, the &#8216;propose-next-disk&#8217; code needs to expand all the potential pole values from 1 through 3.  Fortunately this is only a three-valued expansion, but the code looks quite nasty for being as simple as the above.</p>

<p><a href="http://chimu.files.wordpress.com/2008/09/atasteofscratch_d7.png"><img src="http://chimu.files.wordpress.com/2008/09/atasteofscratch_d7.png" alt="" /></a></p>

<h3>Move Next Disk</h3>

<p>The Move Next Disk code has (1) the filter on the broadcast (in this case by &#8216;disk-id&#8217;) to make it only go to a single object and (2) a ton of noise due to &#8216;pole&#8217; expansion mentioned above.  But the code gets the job done and it looks fairly colorful :-)</p>

<p><a href="http://chimu.files.wordpress.com/2008/09/atasteofscratch_d8.png"><img src="http://chimu.files.wordpress.com/2008/09/atasteofscratch_d8.png" alt="" /></a></p>

<h2>Conclusions</h2>

<p>I was impressed that Scratch was able to get Tower of Hanoi to run properly.  Scratch has actively avoided certain features that the Scratch team finds are difficult to understand.  But the toolbox of event processing, broadcasts, lists, and Sprites (objects with Stage presence :-) ) are rich enough that a pre-sized Hanoi can be created and will run correctly.  A dynamic Hanoi would require Sprite cloning, which is not in Scratch 1.3.</p>

<p>The nastiest aspect to Scratch was its inability to dynamically reference the pole lists.  And a missing feature to Scratch are simple procedures (for example, the &#8216;glide&#8217; code is repeated twice).  The missing recursion is clearly another missing feature, but in this case getting rid of that recursion made the algorithm somewhat nicer.</p>

<p>On the whole, Scratch is a very inspiring visual language and development environment, and it did a good job with this &#8216;offbeat&#8217; test.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Ruby Naming Convention Failure]]></title>
    <link href="http://markfussell.emenar.com/blog/ruby-naming-convention-failure/"/>
    <updated>2008-09-04T01:20:00-07:00</updated>
    <id>http://markfussell.emenar.com/blog/ruby-naming-convention-failure</id>
    <content type="html"><![CDATA[<p>Ruby has a strong recommendation against using CamelCase for method and variable names and to use only underscores instead.  There are lots of arguments out there on different naming conventions, and whatever side I pick in isolation is fairly irrelevant since either the whole community or the individual team has to chose the best approach.</p>

<!-- more -->


<p>In case people care, in isolation of other issues, I would pick this order as being the most natural:</p>

<ol>
<li><p>Mark-Fussell (or mark-fussell)</p></li>
<li><p>MarkFussell</p></li>
<li><p>Mark_Fussell (or mark_fussell)</p></li>
</ol>


<p>where the underscore goes third mostly because it can be hard to see [URLs and other things put underlines <em>on top</em> of that underline like thus <em>Mark_Fussell</em>], is harder to type, and it over spaces things visually.  So I (and lots of people actually) believe programming languages <em>should</em> use hyphens, but because a bunch of programming languages want &#8216;a-b&#8217; to be interpreted as &#8216;a - b&#8217;, they cop out and prevent the hyphen from being part of a name.  Ruby has that same cop out, so we can&#8217;t use hyphens in Ruby :-(</p>

<h2>Missing Phrase Delimiter</h2>

<p>So I said my opinion is fairly irrelevant, but I also want to say that people have missed an important aspect to this argument.  I may have a small preference for CamelCase over underlines as a single word delimiter, but I have a <em>huge</em> preference to having both a &#8216;word&#8217; and a &#8216;phrase&#8217; delimiter.  And by insisting on just one delimiter in this naming standard, Ruby has significantly interfered with expressiveness.  Maybe I am unusual, but I have long-time argued that we should have both words and phrases in methods and frequently even in classes.  Back in the 1990s, I documented this as part of my <a href="http://markfussell.emenar.com/blog/java-development-standards">JavaStandards</a> and this was based on Smalltalk naturally having both of these pieces.  It was clearly more readable and you were much less likely to produce bad method names.</p>

<p>For method naming, the quick summary is:</p>

<ul>
<li><p>When naming a method</p></li>
<li><p>Start with a verb phrase (what you are asking the object to do)</p></li>
<li><p>Put an underscore where a parameter is expected (up to the first two at least)</p></li>
<li><p>Describe what that parameter is for right before the underscore, if it is not obvious from the verb</p></li>
</ul>


<p>this way, the reader of the code can immediately know how the parameters (in the parentheses) map onto their role in the method itself.  And the whole method name becomes a readable phrase&#8230; not just a weird long word strung together (by whatever convention you want).</p>

<h3>Array::insert</h3>

<p>So an example is:</p>

<pre><code>Array::insert(index, obj)
</code></pre>

<p>This is a method name that is ambiguous in usage:</p>

<pre><code>anArray.insert(3,2)
</code></pre>

<p>It is not clear what the code is going to do and I would actually intuitively expect it to be the other way around (except I know about getting burned so would then have to look it up).</p>

<p>A better name would be:</p>

<pre><code>Array::insert_at(obj,index)
</code></pre>

<p>so reading:</p>

<pre><code>anArray.insert_at(3,2)
</code></pre>

<p>is clearly inserting the &#8216;3&#8217; not inserting the &#8216;2&#8217;.</p>

<p>Or if people like the order the other way:</p>

<pre><code>   Array::insertAt_value(index,obj)

   anArray.insertAt_value(2,3)
</code></pre>

<p>And in the Ruby case where any number of values could follow, we should have:</p>

<pre><code>   Array::insertAt_values(index,obj...)

   anArray.insertAt_values(2,3)
   anArray.insertAt_values(2,5,3)
</code></pre>

<p>and everything reads naturally something like this &#8220;anArray insertAt: 2 values: 5 and 3&#8221;.</p>

<h3>forPolesOtherThan_do(disk)</h3>

<p>Related to a recent post on the Tower of Hanoi, I believe the resulting choice of:</p>

<pre><code>forPolesOtherThan_do(disk) [block]
</code></pre>

<p>is much clearer in both communicating what the passed in &#8216;disk&#8217; is for and that it requires a block as a second (semi-hidden) argument than if you have only a word delimiter and have any of:</p>

<pre><code>   for_poles_other_than
   for_poles_other_than_do
   forPolesOtherThan
   forPolesOtherThanDo
</code></pre>

<h2>What to do?</h2>

<p>Given Ruby wants to use underscore to separate words&#8230; I can&#8217;t separate the phrases at all.  I tried to wrestle my mind around using something different, but Ruby surprisingly (for a modern and internationally-created) language does not have any other punctuation that is allowed and could plausibly work.  So maybe use two underscores for the phrase point?  That seems seriously ugly and also two underscores don&#8217;t really look different from one underscore:</p>

<pre><code>   insert_at__values
   for_poles_other_than__do
</code></pre>

<p>Using capitals for this purpose just comes off weird (plausible but weird):</p>

<pre><code>   insert_at_Values
   for_poles_other_than_Do
</code></pre>

<p>It is also exactly the opposite of Smalltalk, and I try to be able to work across languages without having to flip upside down all the time.  Same regarding Java and Flex (two other languages I actively work in).  For reference, the Smalltalk version of these examples are:</p>

<pre><code>   insertAt: values:
   forPolesOtherThan: do:
</code></pre>

<h3>Arguments about non-English speakers</h3>

<p>One argument I (so far) find specious is that using capitals prevents non-native speakers from understanding the code.  I could maybe believe this is true in rare cases &#8211; but (1) nobody has a study referenced that shows that, and (2) if that were true, someone simply has to learn the language better.  You can&#8217;t argue that some people&#8217;s inability to use a language is a reason to not use a feature of that language.  That would argue that almost all syntax in languages should be stripped, and few languages (and especially computer languages) can survive that.  Actually only Lisp survives that (give me just a pair of delimiters, and I can rule the world :-) )</p>

<p>Also given Ruby uses CamelCase for classes, you already have a requirement to understand this kind of syntax aspect.  So Ruby is presupposing the reader can read the syntax it is arguing the reader can&#8217;t read.</p>

<h3>The standard, in different languages</h3>

<p>A more interesting question is whether the &#8220;word and phrase standard&#8221; survives human-language change.  Obviously the standard does not work &#8220;as written&#8221; if the language used is not a capital-capable language.  And an obviously important language for that test is written Chinese (traditional or simplified).  But actually the &#8216;underscores for phrases and parameters&#8217; degrades with Chinese better than &#8216;underscores for words&#8217;.  Chinese doesn&#8217;t require spaces for words to be apparent, and does not use spaces at all for that purpose (normally) &#8211; it is obvious where each word starts and ends without spacing because a word is only a couple characters long.  So given words are apparent, the only thing left is to have phrases.  Although unnatural to use underscores for phrases and parameters, it at least seems plausibly useful.</p>

<p>Admittedly I have not tried in depth to program in Chinese (Smalltalk/Agents by QKS had the ability way back but I only played with it a little) and have not found a study on it&#8230;  so I can&#8217;t say for sure whether the underscore for parameters would make sense.  But it is at least plausible it would make sense and it would make much more sense than underscore to separate (already separated) words.</p>

<p>Another plausible language to test against would be Hindi, but (I believe) most writers of Hindi in the computer field are also excellent English writers, so that is harder to argue for.</p>

<h3>Could be hyphens</h3>

<p>Note that the convention is totally happy with using &#8216;hyphens&#8217; as word separators if the environment supports it.</p>

<pre><code>   insert-at_values
   for-poles-other-than_do
</code></pre>

<h2>Summary: Ruby has it wrong &#8211; We need CamelWords or hyphen-words</h2>

<p>So I believe Ruby has it wrong and am very unhappy a modern language started 20 years after Smalltalk and several years after Dylan would get this kind of thing wrong.  And I recommend moving the Ruby standard to the CamelWord_UnderPhrase standard, or allowing the hyphen and use the hyphen-word_under-phrase standard.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[A Taste of Ruby (Part 7)]]></title>
    <link href="http://markfussell.emenar.com/blog/a-taste-of-ruby-part-7/"/>
    <updated>2008-09-03T02:28:00-07:00</updated>
    <id>http://markfussell.emenar.com/blog/a-taste-of-ruby-part-7</id>
    <content type="html"><![CDATA[<p>This is a multi-part series.  The first in the series is <a href="http://markfussell.emenar.com/blog/a-taste-of-ruby">here</a>.</p>

<h2>Tower of Hanoi &mdash; Rules on Rails</h2>

<p>In part 6 we changed the algorithm of Tower Of Hanoi to work without requiring the stack &#8211; it instead &#8220;more naturally&#8221; put sufficient state and logic into the model that the model could start and stop and continue as needed.  I believe with Ruby 1.8.x, this is required to have Rails be able to work with the Tower of Hanoi.  So we should try it out and see how well it works :-)</p>

<!-- more -->




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;hanoi_7&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">HanoiController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">say</span>
</span><span class='line'>    <span class="vi">@hanoi</span> <span class="o">=</span> <span class="n">session</span><span class="o">[</span><span class="ss">:hanoi</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="vi">@hanoi</span> <span class="o">==</span> <span class="kp">nil</span><span class="p">)</span> <span class="k">then</span>
</span><span class='line'>      <span class="vi">@hanoi</span> <span class="o">=</span> <span class="n">createHanoi</span>
</span><span class='line'>      <span class="n">session</span><span class="o">[</span><span class="ss">:count</span><span class="o">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>      <span class="n">session</span><span class="o">[</span><span class="ss">:consoleLog</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="vi">@hanoi</span><span class="o">.</span><span class="n">initApp</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@isDone</span> <span class="o">=</span> <span class="vi">@hanoi</span><span class="o">.</span><span class="n">doNextMove_IsDone</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">#clear the app because otherwise it will be part of the attempted serialization</span>
</span><span class='line'>    <span class="c1">#could also override the marshaling code, but this is simpler</span>
</span><span class='line'>    <span class="vi">@hanoi</span><span class="o">.</span><span class="n">initApp</span><span class="p">(</span><span class="kp">nil</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">#clear out the session variable, but @hanoi is still valid through</span>
</span><span class='line'>    <span class="c1">#the rest of this interaction</span>
</span><span class='line'>    <span class="n">session</span><span class="o">[</span><span class="ss">:hanoi</span><span class="o">]</span> <span class="o">=</span> <span class="vi">@isDone</span> <span class="p">?</span> <span class="kp">nil</span> <span class="p">:</span> <span class="vi">@hanoi</span>
</span><span class='line'>
</span><span class='line'>    <span class="vi">@count</span> <span class="o">=</span> <span class="n">session</span><span class="o">[</span><span class="ss">:count</span><span class="o">]</span> <span class="o">||=</span> <span class="mi">0</span>
</span><span class='line'>    <span class="vi">@count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'>    <span class="n">session</span><span class="o">[</span><span class="ss">:count</span><span class="o">]</span> <span class="o">=</span> <span class="vi">@count</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="vi">@isDone</span><span class="p">)</span> <span class="k">then</span>
</span><span class='line'>      <span class="n">render</span><span class="p">(</span><span class="ss">:action</span> <span class="o">=&gt;</span> <span class="s1">&#39;say_done&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">appendLog</span><span class="p">(</span><span class="n">outString</span><span class="p">)</span>
</span><span class='line'>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Append to Log: &quot;</span><span class="o">+</span><span class="n">outString</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@consoleLog</span> <span class="o">=</span> <span class="n">session</span><span class="o">[</span><span class="ss">:consoleLog</span><span class="o">]</span> <span class="o">||=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="vi">@consoleLog</span> <span class="o">=</span> <span class="vi">@consoleLog</span> <span class="o">+</span> <span class="n">outString</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="n">session</span><span class="o">[</span><span class="ss">:consoleLog</span><span class="o">]</span> <span class="o">=</span> <span class="vi">@consoleLog</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">noteChange</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">createHanoi</span>
</span><span class='line'>    <span class="n">hanoi</span> <span class="o">=</span> <span class="no">RulesTowerOfHanoi</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>    <span class="n">hanoi</span><span class="o">.</span><span class="n">initHeight</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span class='line'>    <span class="n">hanoi</span><span class="o">.</span><span class="n">setup_disks</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">hanoi</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">getAsciiTowers</span>
</span><span class='line'>    <span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>    <span class="n">lines</span> <span class="o">=</span> <span class="nb">Array</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>    <span class="vi">@hanoi</span><span class="o">.</span><span class="n">stacks</span><span class="o">.</span><span class="n">each_with_index</span> <span class="k">do</span> <span class="o">|</span> <span class="n">eachStack</span><span class="p">,</span> <span class="n">i</span> <span class="o">|</span>
</span><span class='line'>      <span class="mi">0</span><span class="o">.</span><span class="n">upto</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span> <span class="n">j</span> <span class="o">|</span>
</span><span class='line'>        <span class="n">eachDisk</span> <span class="o">=</span> <span class="n">eachStack</span><span class="o">[</span><span class="n">j</span><span class="o">]</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">eachDisk</span> <span class="o">==</span> <span class="kp">nil</span><span class="p">)</span> <span class="k">then</span>
</span><span class='line'>          <span class="n">newLine</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">*</span><span class="mi">12</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>          <span class="n">newLine</span> <span class="o">=</span> <span class="n">eachDisk</span><span class="o">.</span><span class="n">to_s</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">newLine</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot; &quot;</span><span class="o">*</span><span class="p">(</span><span class="mi">12</span> <span class="o">-</span> <span class="n">newLine</span><span class="o">.</span><span class="n">length</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">currentLine</span> <span class="o">=</span> <span class="n">lines</span><span class="o">[</span><span class="n">j</span><span class="o">]</span> <span class="o">||=</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>        <span class="n">lines</span><span class="o">[</span><span class="n">j</span><span class="o">]</span> <span class="o">=</span> <span class="n">currentLine</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="n">newLine</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">lines</span><span class="o">.</span><span class="n">reverse</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">line</span><span class="o">|</span> <span class="n">result</span> <span class="o">+=</span> <span class="n">line</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">result</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="cp">&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot;</span>
</span><span class='line'><span class="cp">        &quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd&quot;&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;html</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.w3.org/1999/xhtml&quot;</span> <span class="na">xml:lang=</span><span class="s">&quot;en&quot;</span> <span class="na">lang=</span><span class="s">&quot;en&quot;</span><span class="nt">&gt;</span>
</span><span class='line'><span class="nt">&lt;head&gt;</span>
</span><span class='line'><span class="nt">&lt;title&gt;</span>Foo <span class="err">&lt;</span>%= @page_title %&gt;<span class="nt">&lt;/title&gt;</span>
</span><span class='line'><span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;Content-Type&quot;</span> <span class="na">content=</span><span class="s">&quot;text/html; charset=UTF-8&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;refresh&quot;</span> <span class="na">content=</span><span class="s">&quot;1&quot;</span><span class="nt">&gt;</span>
</span><span class='line'><span class="err">&lt;</span>%= javascript_include_tag :defaults %&gt;
</span><span class='line'><span class="nt">&lt;/head&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;body</span><span class="err">&lt;%</span> <span class="na">if</span> <span class="err">@</span><span class="na">page_class</span> <span class="err">%</span><span class="nt">&gt;</span> class=&quot;<span class="err">&lt;</span>%= @page_class %&gt;&quot;<span class="err">&lt;</span>% end %&gt;&gt;
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;h1&gt;</span>Tower of Hanoi (Move <span class="err">&lt;</span>%= @count %&gt;) <span class="nt">&lt;/h1&gt;</span>
</span><span class='line'>
</span><span class='line'>It&#39;s <span class="err">&lt;</span>%= Time.now %&gt;.
</span><span class='line'><span class="nt">&lt;br/&gt;</span>
</span><span class='line'>Done = <span class="err">&lt;</span>%= @isDone %&gt;
</span><span class='line'><span class="nt">&lt;br/&gt;</span>
</span><span class='line'>Render =
</span><span class='line'><span class="nt">&lt;pre&gt;</span>
</span><span class='line'><span class="err">&lt;</span>%= controller.getAsciiTowers %&gt;
</span><span class='line'><span class="nt">&lt;/pre&gt;</span>
</span><span class='line'>Log =
</span><span class='line'><span class="nt">&lt;pre&gt;</span>
</span><span class='line'><span class="err">&lt;</span>%= @consoleLog %&gt;
</span><span class='line'><span class="nt">&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;/body&gt;</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
</feed>
