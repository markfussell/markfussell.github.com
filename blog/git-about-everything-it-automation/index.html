
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Being a git about everything (IT Automation) - Polyglot</title>
  <meta name="author" content="Mark Fussell">

  
  <meta name="description" content="This is the fourth in a series of using git as part of interesting solutions to problems. The first is here: Intro Leveraging git to help enable &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://markfussell.emenar.com/blog/git-about-everything-it-automation/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Polyglot" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Polyglot</a></h1>
  
    <h2>Build Valuable Systems, Better and Faster</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:markfussell.emenar.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Home</a></li>
  <li><a href="/blog">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Being a Git About Everything (IT Automation)</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-16T18:16:00-08:00" pubdate data-updated="true">Feb 16<span>th</span>, 2013</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>This is the fourth in a series of using git as part of interesting solutions to problems.</p>

<p>The first is here: <a href="/blog/git-about-everything-intro/">Intro</a></p>

<h2>Leveraging git to help enable automated IT</h2>

<p>Doing IT for computers involves installing software, configuring things, doing backups, updates, etc.
The ultimate IT is one that <em>&#8216;simply works&#8217;</em> and involves almost no human interaction
even in failure situations.  Ideally IT should be equivalent to
a macro-level program that does everything that does not require touching
a physical machine.</p>

<p>This IT-as-program has become easier and easier over the last many years with
better and more standardized operating systems, free software that does not
require annoying human interaction during installation, and virtualization on top of physical
hardware that makes provisioning and reprovisioning easier.  With cloud computing,
IT-as-program becomes almost a necessity as hundreds of virtual computers are created, updated, failed,
migrated, and decommissioned.</p>

<p>Git alone doesn&#8217;t enable IT-as-program but it can be a core component in many areas.  Among these are:</p>

<ul>
<li> Easy &#8216;Live IT&#8217; servers</li>
<li> A Push-Me-Pull-You model for continual deployment</li>
<li> Server presence</li>
</ul>


<p>Having git as a core piece of IT infrastructure enables thousands of machines to very rapidly react (within a minute or two)
without needing a heavy infrastructure.  You simply need one or two (for redundancy) git servers, of which one can be GitHub
or a similar free or inexpensive service.  Other technologies in this space have significantly more complicated servers,
are more likely to be SPOFs (Single points of failures) or bottlenecks, and are much more expensive as a service.</p>

<!-- more -->


<h2>Easy &#8216;Live IT&#8217; servers</h2>

<p>A &#8216;Live IT&#8217; server is one that can automatically do new things when something about the IT world changes.  This
is not referring to how sophisticated the applications on a server are, but whether the server itself can
manage upgrades or other configuration changes to itself.  Examples are:</p>

<ul>
<li> Deploying new version of a Java war or a Rails app</li>
<li> Doing database backups and offloads</li>
<li> Offloading or deleting logs (that are harder than logrotate)</li>
<li> Reacting to simple configuration changes</li>
<li> Reacting to server presence changes</li>
</ul>


<p>There are a number of ways to do the activities listed above, from manually interacting with machines, through cron jobs,
mass &#8216;push&#8217; model interactions (e.g. Capistrano), and finally puppetry via Chef and similar.  I have found almost all of
these to be lacking in many ways, including:</p>

<ul>
<li> Lack of documented change-to-server</li>
<li> Difficulty in rolling back changes</li>
<li> Not scaling nicely (one client hitting many servers, or many servers doing queries against another server)</li>
<li> Lack of flexibility</li>
<li> Slowness or non-responsiveness (delays) of applying changes</li>
<li> Differences from &#8216;bootstrap&#8217; of cloud servers</li>
</ul>


<h3>Pull Model</h3>

<p>A different approach leveraging Git (or any other DVCS) seems to produce much simpler and more powerful
solutions.  The approach is composed of:</p>

<ul>
<li> A git repository that has working scripts (in any language people like, including Chef-solo)</li>
<li> A simple bootstrap script that clones the repository and calls an <code>init.sh</code> script in it</li>
<li> A cron job that is set up by the <code>init.sh</code> script.  This cron job executes every minute

<ul>
<li>Goes into the working git repository</li>
<li>Does a pull to get the latest version of scripts</li>
<li>Then calls into a <code>work.sh</code> script</li>
</ul>
</li>
</ul>


<p>This flow enables activity at every minute, using the latest version of the git repository, and with very little overhead
for the core behavior.  Advantages are:</p>

<ul>
<li> All changes to a server are caused by one or more git repositories changing.  Servers can even publish there status by showing the git revision they are on.</li>
<li> Rolling back changes is simply reversing a commit</li>
<li> The only centralized activity is the <code>git fetch</code> which is very simple and fast.</li>
<li> So far the only constraint is the time is every minute, and that could be sub-minute but needing that is rare</li>
<li> Delays are at most a minute, and again that could easily become less (but not sub-second)</li>
<li> The behavior is actually the same as bootstrapping a server.  A bootstrap is just the first minute of work.</li>
</ul>


<h3>Example-1</h3>

<p>Example-1 is the initial example of this model.  The repository is</p>

<ul>
<li> <a href="https://github.com/markfussell/giteveryrepo3/">https://github.com/markfussell/giteveryrepo3/</a></li>
</ul>


<p>with the CloudFormation template being:</p>

<ul>
<li> <a href="https://github.com/markfussell/giteveryrepo3/blob/master/it/aws/cloudformation/GitEverythingServer3.template">https://github.com/markfussell/giteveryrepo3/blob/master/it/aws/cloudformation/GitEverythingServer3.template</a></li>
</ul>


<p>This has a UserData section which does the initial bootstrap of cloning the repository and
calling an init script inside it.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'>      <span class="s2">&quot;yum -y install git \n&quot;</span><span class="err">,</span>
</span><span class='line'>      <span class="s2">&quot;mkdir /root/gitrepo \n&quot;</span><span class="err">,</span>
</span><span class='line'>      <span class="s2">&quot;cd /root/gitrepo \n&quot;</span><span class="err">,</span>
</span><span class='line'>      <span class="s2">&quot;git clone git://github.com/markfussell/giteveryrepo3.git  \n&quot;</span><span class="err">,</span>
</span><span class='line'>
</span><span class='line'>      <span class="s2">&quot;cd /root/gitrepo/giteveryrepo3 \n&quot;</span><span class="err">,</span>
</span><span class='line'>      <span class="s2">&quot;source bin/init/common/init.sh \n&quot;</span><span class="err">,</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>init.sh</code> script simply sets up a cron job that calls the <code>cron_1m.sh</code> script
in <code>/root/bin/</code>.  I prefer to have crontab files that are very simple (e.g. one line)
and call into /root/bin/ scripts so (a) it is more visible what crons are running
(b) if there are any inter-cron issues they can be managed, and (c) it is easy to
disable a cron by doing a rename.</p>

<p>The <code>init.sh</code> file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">================================</span>
</span><span class='line'><span class="c">#=== Have a preference that crons</span>
</span><span class='line'><span class="c">#=== all go through a single file</span>
</span><span class='line'><span class="c">#================================</span>
</span><span class='line'>
</span><span class='line'>mkdir -p /root/bin
</span><span class='line'>cp ./bin/init/common/cron_1m.sh /root/bin/cron_1m.sh
</span><span class='line'>chmod +x /root/bin/cron_1m.sh
</span><span class='line'>
</span><span class='line'>cat <span class="s">&lt;&lt;EOS &gt; /var/spool/cron/root</span>
</span><span class='line'><span class="s">MAILTO=&quot;&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="s">* * * * *  /root/bin/cron_1m.sh</span>
</span><span class='line'><span class="s">EOS</span>
</span></code></pre></td></tr></table></div></figure>


<p>And the <code>cron_1m.sh</code> file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#! /bin/bash</span>
</span><span class='line'><span class="c">#================================</span>
</span><span class='line'><span class="c">#=== Simple worker example</span>
</span><span class='line'><span class="c">#================================</span>
</span><span class='line'>
</span><span class='line'><span class="nb">export </span><span class="nv">ME</span><span class="o">=</span><span class="sb">`</span>basename <span class="nv">$0</span><span class="sb">`</span>
</span><span class='line'><span class="nb">export </span><span class="nv">LOG</span><span class="o">=</span>/root/log/<span class="k">${</span><span class="nv">ME</span><span class="k">}</span>_log.txt
</span><span class='line'><span class="nb">export </span><span class="nv">ERROR</span><span class="o">=</span>/root/log/<span class="k">${</span><span class="nv">ME</span><span class="k">}</span>_error.txt
</span><span class='line'><span class="nb">export </span><span class="nv">START_TSS</span><span class="o">=</span><span class="s2">&quot;`date +%Y%m%d-%H%M%S`&quot;</span>
</span><span class='line'>
</span><span class='line'>mkdir -p /root/log/
</span><span class='line'>
</span><span class='line'><span class="nb">exec </span>1&gt;&gt; <span class="k">${</span><span class="nv">LOG</span><span class="k">}</span>
</span><span class='line'><span class="nb">exec </span>2&gt;&gt; <span class="k">${</span><span class="nv">ERROR</span><span class="k">}</span>
</span><span class='line'>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;${ME}: Start  ${START_TSS}&quot;</span> &gt;&gt; <span class="k">${</span><span class="nv">LOG</span><span class="k">}</span>
</span><span class='line'>
</span><span class='line'><span class="nb">export </span><span class="nv">REPOS</span><span class="o">=</span><span class="sb">`</span>find /root/gitrepo/ -maxdepth 1 -mindepth 1 <span class="sb">`</span>
</span><span class='line'><span class="k">for </span>REPO in <span class="k">${</span><span class="nv">REPOS</span><span class="k">}</span>; <span class="k">do</span>
</span><span class='line'><span class="k">    </span><span class="nb">pushd</span> <span class="k">${</span><span class="nv">REPO</span><span class="k">}</span>
</span><span class='line'>        git pull
</span><span class='line'>
</span><span class='line'>        <span class="nb">source </span>bin/work/common/work.sh
</span><span class='line'>    <span class="nb">popd</span>
</span><span class='line'><span class="k">done</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nb">export </span><span class="nv">FINISH_TSS</span><span class="o">=</span><span class="s2">&quot;`date +%Y%m%d-%H%M%S`&quot;</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;${ME}: Finish ${FINISH_TSS}&quot;</span> &gt;&gt; <span class="k">${</span><span class="nv">LOG</span><span class="k">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see the <code>cron_1m.sh</code> script is &#8220;repo flexible&#8221;.
It will do any and all <code>work.sh</code> file it finds in the repositories under
<code>/root/gitrepo/</code>.  You might want to be more restrictive than
that (say only &#8216;active&#8217; repos), but this at least shows the power of the
generalization.</p>

<p>If you login to the server, you will find it doing some kind of work:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@ip-10-120-174-182 ~<span class="o">]</span><span class="c"># tail -f /root/log/*</span>
</span><span class='line'><span class="o">==</span>&gt; /root/log/cron_1m.sh_error.txt &lt;<span class="o">==</span>
</span><span class='line'>
</span><span class='line'><span class="o">==</span>&gt; /root/log/cron_1m.sh_log.txt &lt;<span class="o">==</span>
</span><span class='line'>Already up-to-date.
</span><span class='line'>We are doing some kind of work
</span><span class='line'>~
</span><span class='line'>cron_1m.sh: Finish 20130219-050202
</span><span class='line'>cron_1m.sh: Start  20130219-050301
</span><span class='line'>~/gitrepo/giteveryrepo3 ~
</span><span class='line'>Already up-to-date.
</span><span class='line'>We are doing some kind of work
</span><span class='line'>~
</span><span class='line'>cron_1m.sh: Finish 20130219-050301
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, the total time to do a &#8220;Hello World&#8221; is under a second.  Very fast!</p>

<h4>Inherent overhead of approach</h4>

<p>The amount of overhead associated associated with this approach is less than a second.  The fetch itself:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@ip-10-120-174-182 giteveryrepo3<span class="o">]</span><span class="c"># time git fetch</span>
</span><span class='line'>
</span><span class='line'>real  0m0.087s
</span><span class='line'>user  0m0.002s
</span><span class='line'>sys   0m0.006s
</span></code></pre></td></tr></table></div></figure>


<p>is 87 milliseconds and the system overhead is 8 milliseconds on an m1.small (that isn&#8217;t doing anything else).
With a busier server the &#8216;real&#8217; time goes up a bit, but the system overhead is still tens of milliseconds at
most.</p>

<p>Although fetching is useful on its own, we will initially always merge as well, so let us time that:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@ip-10-120-174-182 giteveryrepo3<span class="o">]</span><span class="c"># time git pull</span>
</span><span class='line'>Already up-to-date.
</span><span class='line'>
</span><span class='line'>real  0m0.105s
</span><span class='line'>user  0m0.007s
</span><span class='line'>sys   0m0.053s
</span></code></pre></td></tr></table></div></figure>


<p>Pulling requires a bit more effort to do a no-op merge but things are still in the tens of milliseconds of &#8216;effort&#8217;
and a clock time well under a second.</p>

<h2>Push-Me-Pull-You</h2>

<div style="float:right">
<img width="244" height="191" src="/images/git-about-everything-it-automation/Pushmepullyou_mlf1c.png" />
</div>


<p>The previous section discussed having &#8216;Live IT&#8217; servers that use the very-fast git pull to
get updates that the server will react to.  Updating central git repositories uses an atomic &#8216;push&#8217;
operation, so the obvious name for this pattern of pushing changes from one place (say &#8216;me&#8217;)
to a hundred servers who are listening (let us call them &#8216;you&#8217;) is&#8230; &#8216;Push-Me-Pull-You&#8217;&#8230;
which even has a handy mascot.</p>

<p>Some great things about the PushMePullYou were identified above:</p>

<ul>
<li> Extremely low overhead and very simple model</li>
<li> All changes to a server are caused by one or more git repositories changing.  Servers can even publish there status by showing the git revision they are on.</li>
<li> Rolling back changes is simply reversing a commit</li>
<li> The only centralized activity is the <code>git fetch</code> which is very simple and fast.</li>
<li> So far the only constraint is the time is every minute, and that could be sub-minute but needing that is rare</li>
<li> Delays are at most a minute, and again that could easily become less (but not sub-second)</li>
<li> The behavior is actually the same as bootstrapping a server.  A bootstrap is just the first minute of work.</li>
</ul>


<p>A few additional ones are:</p>

<ul>
<li> You can &#8216;push&#8217; from anywhere you want&#8230; so you can test a change on the target IT environment and then push from there if it works</li>
<li> It is very easy to organize many different kinds of machines, kinds of deployments, etc. within a single repository</li>
<li> It is very easy to detect whether a change happens at all, whether it is potentially relevant, and with a few easy patterns, whether it would have an impact that requires real action</li>
</ul>


<p>The architectural model looks a bit like this</p>

<p><img src="/images/git-about-everything-it-automation/pushmepullyou_simpleawsarch.png" /></p>

<h3>Going beyond naive</h3>

<p>The Example-1 above had the naive &#8216;pull and do something no matter what&#8217;.  We need to get a bit beyond that
to have a truly useful approach.</p>

<h3>Checking commit version</h3>

<p>The simplest sanity check is to see whether we have a new commit.  This can be done in a few ways, including:</p>

<ul>
<li> Do a &#8216;fetch&#8217; and check whether the remote branch is different from the local branch</li>
<li> After each action, store the commit version that was acted upon.  On each pull compare the old to the new</li>
<li> Have a local acted-upon branch separate from the main branch</li>
</ul>


<p>The last one has a nice feature of showing &#8216;history-according-to-this-machine&#8217; where the other two are purely
&#8216;what is now&#8217;, but it is simpler to avoid having a per-machine branch and multiple versions (the differing
merges depending on local history) occurring
everywhere.</p>

<h4>Fetch based</h4>

<p>The simplest check is just to see if there are any differences between the &#8216;origin&#8217; and the local branch.  This
would look something like <code>detectOriginFetchDiff.sh</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#=================================================</span>
</span><span class='line'><span class="c">#=== Detect whether the version of the origin</span>
</span><span class='line'><span class="c">#=== is the same as the local version.</span>
</span><span class='line'><span class="c">#=== Return the ORIGIN_VERSION if different</span>
</span><span class='line'><span class="c">#=================================================</span>
</span><span class='line'>
</span><span class='line'>git fetch
</span><span class='line'>
</span><span class='line'><span class="nb">export </span><span class="nv">ORIGIN_VERSION</span><span class="o">=</span><span class="sb">`</span>git rev-parse origin/master<span class="sb">`</span>
</span><span class='line'><span class="nb">export </span><span class="nv">LOCAL_VERSION</span><span class="o">=</span><span class="sb">`</span>git rev-parse HEAD<span class="sb">`</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;${ORIGIN_VERSION}&quot;</span> <span class="o">=</span> <span class="s2">&quot;${LOCAL_VERSION}&quot;</span> <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'>    : <span class="c">#Don&#39;t do anything</span>
</span><span class='line'><span class="k">else</span>
</span><span class='line'><span class="k">    </span><span class="nb">echo</span> <span class="k">${</span><span class="nv">ORIGIN_VERSION</span><span class="k">}</span>
</span><span class='line'><span class="k">fi</span>
</span></code></pre></td></tr></table></div></figure>


<p>Where you can use this script with:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;`./bin/pushmepullyou/detectOriginDiff.sh`&quot;</span> <span class="o">]]</span> ; <span class="k">then</span>
</span><span class='line'>   : <span class="c">#React to the change</span>
</span><span class='line'><span class="k">else</span>
</span><span class='line'>   : <span class="c">#Do nothing / exit</span>
</span><span class='line'><span class="k">fi</span>
</span></code></pre></td></tr></table></div></figure>


<p>This should be lightning fast.  The only drawback is:</p>

<ul>
<li> If you don&#8217;t pull (merge) until after executing the script&#8230; you might not be able to easily change the code determining whether to executing the script</li>
</ul>


<p>You can redo an action by forcing the local branch back a version.  For example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>git reset --hard master~1
</span></code></pre></td></tr></table></div></figure>


<h4>Last-action based</h4>

<p>An alternative to the fetch-based model is to record the last action performed by the local machine.  This
deals with the drawback above: you already have the latest version of code no matter what.  Also it starts
down the path of &#8216;mid-action&#8217; protection (to avoid doing a change or sequence of changes on top of each
other).  For example <code>detectLastActionDiff.sh</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#=================================================</span>
</span><span class='line'><span class="c">#=== Detect whether the last action version</span>
</span><span class='line'><span class="c">#=== is the same as the current pulled version.</span>
</span><span class='line'><span class="c">#=== Return the LOCAL_VERSION if different</span>
</span><span class='line'><span class="c">#=================================================</span>
</span><span class='line'>
</span><span class='line'><span class="nb">export </span><span class="nv">LOCAL_VERSION</span><span class="o">=</span><span class="sb">`</span>git rev-parse HEAD<span class="sb">`</span>
</span><span class='line'><span class="nb">export </span><span class="nv">LASTACTION_FILE</span><span class="o">=</span>./.temp/nodeinfo/lastaction.txt
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="o">[[</span> -e <span class="k">${</span><span class="nv">LASTACTION_FILE</span><span class="k">}</span> <span class="o">]]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">    </span><span class="nb">export </span><span class="nv">LAST_ACTION</span><span class="o">=</span><span class="sb">`</span>cat <span class="k">${</span><span class="nv">LASTACTION_FILE</span><span class="k">}</span><span class="sb">`</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;${LAST_ACTION}&quot;</span> <span class="o">=</span> <span class="s2">&quot;${LOCAL_VERSION}&quot;</span> <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'>        : <span class="c">#Don&#39;t do anything</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'><span class="k">        </span><span class="nb">echo</span> <span class="k">${</span><span class="nv">LOCAL_VERSION</span><span class="k">}</span>
</span><span class='line'>    <span class="k">fi</span>
</span><span class='line'><span class="k">else</span>
</span><span class='line'><span class="k">    </span><span class="nb">echo</span> <span class="k">${</span><span class="nv">LOCAL_VERSION</span><span class="k">}</span>
</span><span class='line'><span class="k">fi</span>
</span></code></pre></td></tr></table></div></figure>


<p>And after completing any action you write the version into the lastaction version file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">export </span><span class="nv">LOCAL_VERSION</span><span class="o">=</span><span class="sb">`</span>git rev-parse HEAD<span class="sb">`</span>
</span><span class='line'><span class="nb">export </span><span class="nv">LASTACTION_FILE</span><span class="o">=</span>./.temp/nodeinfo/lastaction.txt
</span><span class='line'><span class="nb">export </span><span class="nv">LASTACTION_DIR</span><span class="o">=</span><span class="s2">&quot;$( cd -P &quot;</span><span class="k">$(</span> dirname <span class="s2">&quot;${LASTACTION_FILE}&quot;</span> <span class="k">)</span><span class="s2">&quot; &amp;&amp; pwd )/&quot;</span>
</span><span class='line'>
</span><span class='line'>mkdir -p LASTACTION_DIR
</span><span class='line'><span class="nb">echo</span> <span class="k">${</span><span class="nv">LOCAL_VERSION</span><span class="k">}</span> &gt; <span class="k">${</span><span class="nv">LASTACTION_FILE</span><span class="k">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Avoiding mid-action collision</h3>

<p>The main advantage of the Last-action approach is it starts down the path of
making sure you are not executing things twice.  Alternatively, you could
have an <code>flock</code> associated with the calling script (say the <code>cron_1m.sh</code>),
but writing to a <code>currentaction</code> file is a bit more
OS independent, can document what version is being acted upon,
and supports multiple paths hitting the same file.</p>

<p>Ideally if anything is currently working, the automatic <code>merge</code> would stop,
so the test for <code>currentaction</code> should be very early.  We should go
back to our initial worker example</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#! /bin/bash</span>
</span><span class='line'><span class="c">#================================</span>
</span><span class='line'><span class="c">#=== Simple worker example</span>
</span><span class='line'><span class="c">#================================</span>
</span><span class='line'>
</span><span class='line'><span class="nb">export </span><span class="nv">ME</span><span class="o">=</span><span class="sb">`</span>basename <span class="nv">$0</span><span class="sb">`</span>
</span><span class='line'><span class="nb">export </span><span class="nv">LOG</span><span class="o">=</span>/root/log/<span class="k">${</span><span class="nv">ME</span><span class="k">}</span>_log.txt
</span><span class='line'><span class="nb">export </span><span class="nv">ERROR</span><span class="o">=</span>/root/log/<span class="k">${</span><span class="nv">ME</span><span class="k">}</span>_error.txt
</span><span class='line'><span class="nb">export </span><span class="nv">START_TSS</span><span class="o">=</span><span class="s2">&quot;`date +%Y%m%d-%H%M%S`&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="nb">export </span><span class="nv">CURRENTACTION_FILE</span><span class="o">=</span>./.temp/nodeinfo/currentaction.txt
</span><span class='line'>
</span><span class='line'>mkdir -p /root/log/
</span><span class='line'>
</span><span class='line'><span class="nb">exec </span>1&gt;&gt; <span class="k">${</span><span class="nv">LOG</span><span class="k">}</span>
</span><span class='line'><span class="nb">exec </span>2&gt;&gt; <span class="k">${</span><span class="nv">ERROR</span><span class="k">}</span>
</span><span class='line'>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;${ME}: Start  ${START_TSS}&quot;</span> &gt;&gt; <span class="k">${</span><span class="nv">LOG</span><span class="k">}</span>
</span><span class='line'>
</span><span class='line'><span class="nb">export </span><span class="nv">REPOS</span><span class="o">=</span><span class="sb">`</span>find /root/gitrepo/ -maxdepth 1 -mindepth 1 <span class="sb">`</span>
</span><span class='line'><span class="k">for </span>REPO in <span class="k">${</span><span class="nv">REPOS</span><span class="k">}</span>; <span class="k">do</span>
</span><span class='line'><span class="k">    </span><span class="nb">pushd</span> <span class="k">${</span><span class="nv">REPO</span><span class="k">}</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">[[</span> -e <span class="k">${</span><span class="nv">CURRENTACTION_FILE</span><span class="k">}</span> <span class="o">]]</span>; <span class="k">then</span>
</span><span class='line'>            : <span class="c">#Don&#39;t do anything until the current action completes</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'><span class="k">            </span>git pull
</span><span class='line'>
</span><span class='line'>            bash bin/work/common/work.sh
</span><span class='line'>        <span class="k">fi</span>
</span><span class='line'><span class="k">    </span><span class="nb">popd</span>
</span><span class='line'><span class="k">done</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nb">export </span><span class="nv">FINISH_TSS</span><span class="o">=</span><span class="s2">&quot;`date +%Y%m%d-%H%M%S`&quot;</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;${ME}: Finish ${FINISH_TSS}&quot;</span> &gt;&gt; <span class="k">${</span><span class="nv">LOG</span><span class="k">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Note: If you want to have each repository have more control of it&#8217;s behavior
you would need to move the <code>if</code> test and the <code>pull</code> into the work file.</p></blockquote>

<p>While the action is running you can either touch or copy
the current version into <code>currentaction</code>, and when
finished, delete or rename it.  Since everything
is running so fast, you probably don&#8217;t need to do
an <code>flock</code> or even a second <code>[[ -e ]]</code> check.  Acquiring
the lock is simply:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">export </span><span class="nv">LOCAL_VERSION</span><span class="o">=</span><span class="sb">`</span>git rev-parse HEAD<span class="sb">`</span>
</span><span class='line'><span class="nb">export </span><span class="nv">CURRENTACTION_FILE</span><span class="o">=</span>./.temp/nodeinfo/currentaction.txt
</span><span class='line'><span class="nb">export </span><span class="nv">CURRENTACTION_DIR</span><span class="o">=</span><span class="s2">&quot;$( cd -P &quot;</span><span class="k">$(</span> dirname <span class="s2">&quot;${CURRENTACTION_FILE}&quot;</span> <span class="k">)</span><span class="s2">&quot; &amp;&amp; pwd )/&quot;</span>
</span><span class='line'>
</span><span class='line'>mkdir -p CURRENTACTION_DIR
</span><span class='line'><span class="nb">echo</span> <span class="k">${</span><span class="nv">LOCAL_VERSION</span><span class="k">}</span> &gt; <span class="k">${</span><span class="nv">CURRENTACTION_FILE</span><span class="k">}</span>
</span><span class='line'>
</span><span class='line'><span class="c">#Now officially own the current action</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Dealing with different types and collections of servers</h3>

<p>All the above had a single type of machine watching any changes in the
repository and doing the same thing.  Although this does work if you
have either very few servers or are happy with a plethora of repositories
or branches, it would be good to have a way for many different types
and collections of servers to share a single repository.  We
will deal with that in the next blog.</p>

<h2>Summary</h2>

<p>Git can help automate IT with a very fast and effective PushMePullYou
model.  Hundreds of servers can be continually polling one or more
central Git servers to see if anything has changed and then act
upon those changes.  This provides history for any activity, a
very fast response time, and almost no load when nothing has changed.
Also, this approach enables bootstrapping and updating to use exactly
the same paths.</p>

<p>In all, it provides a superior foundation for IT automation in spite of
being so simple.</p>

<h2>References</h2>

<ul>
<li> Chef-Server Scalability

<ul>
<li><a href="http://lists.opscode.com/sympa/arc/chef/2012-01/msg00422.html">http://lists.opscode.com/sympa/arc/chef/2012-01/msg00422.html</a></li>
<li><a href="http://www.opscode.com/hosted-chef/">http://www.opscode.com/hosted-chef/</a></li>
</ul>
</li>
</ul>


<h2>Credit</h2>

<ul>
<li> Initial Llama for Push-Me-Pull-You Image credit: <a href='http://www.123rf.com/photo_11398752_llama-llove--two-llamas-kiss-their-necks-forming-a-heart-shape.html'>fiftyfootelvis / 123RF Stock Photo</a></li>
</ul>


<h2>Next</h2>

<p>Our next problem will be <a href="/blog/git-about-everything-it-automation-2/">Mass IT Automation</a></p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Mark Fussell</span></span>

      








  


<time datetime="2013-02-16T18:16:00-08:00" pubdate data-updated="true">Feb 16<span>th</span>, 2013</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/automation/'>Automation</a>, <a class='category' href='/blog/categories/cloud/'>Cloud</a>, <a class='category' href='/blog/categories/git/'>Git</a>, <a class='category' href='/blog/categories/it/'>IT</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://markfussell.emenar.com/blog/git-about-everything-it-automation/" data-via="" data-counturl="http://markfussell.emenar.com/blog/git-about-everything-it-automation/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/git-about-everything-it/" title="Previous Post: Being a git about everything (IT)">&laquo; Being a git about everything (IT)</a>
      
      
        <a class="basic-alignment right" href="/blog/git-about-everything-it-automation-2/" title="Next Post: Being a git about everything (IT Automation [2])">Being a git about everything (IT Automation [2]) &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>About Me</h1>
  <p>
      <a href="http://www.linkedin.com/in/markfussell/">Linked In</a>
      &bull;
      <a href="http://github.com/markfussell/">Github</a>
      &bull;
      <a href="http://palobots.org/">PaloBots</a>
  </p>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/arch-5/">FooPets: Two Decades of Systems and Architectures</a>
      </li>
    
      <li class="post">
        <a href="/blog/arch-4/">Winster: Two Decades of Systems and Architectures</a>
      </li>
    
      <li class="post">
        <a href="/blog/arch-3/">Velidom: Two Decades of Systems and Architectures</a>
      </li>
    
      <li class="post">
        <a href="/blog/arch-2/">Evant: Two Decades of Systems and Architectures</a>
      </li>
    
      <li class="post">
        <a href="/blog/arch-1/">Two Decades of Systems and Architectures</a>
      </li>
    
  </ul>
</section>
<section>
    <h1>Categories</h1>
    <span id="category-list"><a href='/blog/categories/add' style='font-size: 153.33333333333334%'>ADD</a> <a href='/blog/categories/agile' style='font-size: 135.55555555555554%'>Agile</a> <a href='/blog/categories/architecture' style='font-size: 111.11111111111111%'>Architecture</a> <a href='/blog/categories/automation' style='font-size: 155.55555555555554%'>Automation</a> <a href='/blog/categories/cloud' style='font-size: 155.55555555555554%'>Cloud</a> <a href='/blog/categories/database' style='font-size: 104.44444444444444%'>Database</a> <a href='/blog/categories/dylan' style='font-size: 102.22222222222223%'>Dylan</a> <a href='/blog/categories/dynamic' style='font-size: 115.55555555555556%'>Dynamic</a> <a href='/blog/categories/ephemeral' style='font-size: 102.22222222222223%'>Ephemeral</a> <a href='/blog/categories/estimation' style='font-size: 104.44444444444444%'>Estimation</a> <a href='/blog/categories/flex' style='font-size: 115.55555555555556%'>Flex</a> <a href='/blog/categories/git' style='font-size: 160.0%'>Git</a> <a href='/blog/categories/grails' style='font-size: 122.22222222222223%'>Grails</a> <a href='/blog/categories/guideline' style='font-size: 102.22222222222223%'>Guideline</a> <a href='/blog/categories/it' style='font-size: 157.77777777777777%'>IT</a> <a href='/blog/categories/java' style='font-size: 146.66666666666666%'>Java</a> <a href='/blog/categories/ooad' style='font-size: 102.22222222222223%'>OOAD</a> <a href='/blog/categories/oopsla' style='font-size: 102.22222222222223%'>OOPSLA</a> <a href='/blog/categories/rails' style='font-size: 104.44444444444444%'>Rails</a> <a href='/blog/categories/relational' style='font-size: 104.44444444444444%'>Relational</a> <a href='/blog/categories/ruby' style='font-size: 133.33333333333334%'>Ruby</a> <a href='/blog/categories/rubyshoes' style='font-size: 108.88888888888889%'>RubyShoes</a> <a href='/blog/categories/scale' style='font-size: 128.88888888888889%'>Scale</a> <a href='/blog/categories/scratch' style='font-size: 106.66666666666667%'>Scratch</a> <a href='/blog/categories/smalltalk' style='font-size: 140.0%'>Smalltalk</a> <a href='/blog/categories/stack' style='font-size: 122.22222222222223%'>Stack</a> <a href='/blog/categories/startup' style='font-size: 111.11111111111111%'>Startup</a> <a href='/blog/categories/virtualization' style='font-size: 102.22222222222223%'>Virtualization</a> </span>
</section>
<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/markfussell">@markfussell</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'markfussell',
            count: 6,
            skip_forks: false,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>






  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Mark Fussell -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'markfussell';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://markfussell.emenar.com/blog/git-about-everything-it-automation/';
        var disqus_url = 'http://markfussell.emenar.com/blog/git-about-everything-it-automation/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
