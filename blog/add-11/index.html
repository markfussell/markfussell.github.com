
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Advanced Development and Delivery (ADD) [Part-11] - Polyglot</title>
  <meta name="author" content="Mark Fussell">

  
  <meta name="description" content="This is the elevent installment of describing a radically more productive development and delivery environment. The first part is here: Intro. In the &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://markfussell.emenar.com/blog/add-11/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Polyglot" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Polyglot</a></h1>
  
    <h2>Build Valuable Systems, Better and Faster</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:markfussell.emenar.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Advanced Development and Delivery (ADD) [Part-11]</h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-10-14T01:00:00-07:00" pubdate data-updated="true">Oct 14<span>th</span>, 2015</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>This is the elevent installment of describing a radically more productive development and delivery environment.</p>

<p>The first part is here: <a href="/blog/add-1/">Intro</a>.  In the previous parts I described the big picture, Vagrant and EC2,
node initialization, the one minute configuration HeartBeat, HipChat integration, presence, EC2, configuring nodes, inter-machine presence,
and configuring an application server and its&#8217; stack.</p>

<h2>It&#8217;s Alive!</h2>

<p>We are close to having a viable semi-production environment running the latest version of our code, and with an incredible
capability of configuring, controlling, and being informed of that environment.  With the simple line:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mkdir -p /root/app/
</span><span class='line'><span class="nb">cd</span> /root/app
</span><span class='line'>
</span><span class='line'>git clone git@github.com:grails-samples/grails-petclinic.git
</span><span class='line'><span class="nb">cd </span>grails-petclinic
</span><span class='line'>./gradlew run
</span></code></pre></td></tr></table></div></figure>


<p>We got:</p>

<p><img src="/images/add-10/add10_grails2.png" /></p>

<!-- more -->


<p>Which is almost what we want&#8230; except.</p>

<ul>
<li> We need that IP address to be a stable domain name</li>
<li> We need the &#8216;clone&#8217; to be augmented with subsequent &#8216;git pull&#8217; in case there are subsequent updates</li>
</ul>


<p>In reverse order</p>

<h2>Pulling the Application</h2>

<p>Going back to the one-minute heartbeat, we had this &#8216;cron&#8217; job:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mkdir -p /root/bin
</span><span class='line'>cp <span class="k">${</span><span class="nv">RESOURCE</span><span class="k">}</span>/cron_1m.sh /root/bin/cron_1m.sh
</span><span class='line'>chmod +x /root/bin/cron_1m.sh
</span><span class='line'>
</span><span class='line'>cat <span class="s">&lt;&lt;EOS &gt; /var/spool/cron/root</span>
</span><span class='line'><span class="s">MAILTO=&quot;&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="s">* * * * *  /root/bin/cron_1m.sh</span>
</span><span class='line'><span class="s">EOS</span>
</span></code></pre></td></tr></table></div></figure>


<p>Where part of the cron was described as:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>        bash_ifexist bin/nodework/common/work.sh
</span><span class='line'>        bash_ifexist bin/nodework/part/<span class="sb">`</span>cat /root/nodeinfo/nodepart.txt<span class="sb">`</span>/work.sh
</span><span class='line'>        bash_ifexist bin/nodework/stacktype/<span class="sb">`</span>cat /root/nodeinfo/stacktype.txt<span class="sb">`</span>/work.sh
</span><span class='line'>        bash_ifexist bin/nodework/stacktype/<span class="sb">`</span>cat /root/nodeinfo/stacktype.txt<span class="sb">`</span>/part/<span class="sb">`</span>cat /root/nodeinfo/nodepart.txt<span class="sb">`</span>/work.sh
</span></code></pre></td></tr></table></div></figure>


<p>That is both too much code and too little to understand what is going on.  It is too much because we don&#8217;t need to put anything but
the first line in the &#8216;cron_1b.sh&#8217;.  It is &#8220;fine&#8221; to do so, but if we add some new concept we have to rebuild machines (or
dynamically copy in new &#8216;cron_1m.sh&#8217;) vs. the simpler option of just having the first &#8216;work&#8217; cal the rest of the &#8216;work&#8217;.</p>

<p>The part that is too little is the part where a bunch of git repositories are getting updated.  The full &#8216;cron_1m.sh&#8217; looks
like this:</p>

<h4>cron_1m.sh</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#! /bin/bash</span>
</span><span class='line'><span class="c">#================================</span>
</span><span class='line'><span class="c">#=== Simple worker example</span>
</span><span class='line'><span class="c">#================================</span>
</span><span class='line'>
</span><span class='line'><span class="nb">export </span><span class="nv">ME</span><span class="o">=</span><span class="sb">`</span>basename <span class="nv">$0</span><span class="sb">`</span>
</span><span class='line'><span class="nb">export </span><span class="nv">LOG</span><span class="o">=</span>/root/log/<span class="k">${</span><span class="nv">ME</span><span class="k">}</span>_log.txt
</span><span class='line'><span class="nb">export </span><span class="nv">ERROR</span><span class="o">=</span>/root/log/<span class="k">${</span><span class="nv">ME</span><span class="k">}</span>_error.txt
</span><span class='line'><span class="nb">export </span><span class="nv">START_TSS</span><span class="o">=</span><span class="s2">&quot;`date +%Y%m%d-%H%M%S`&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="nb">export </span><span class="nv">CURRENT_ACTION_FILE</span><span class="o">=</span>./.temp/nodeinfo/currentaction.txt
</span><span class='line'>
</span><span class='line'>bash_ifexist <span class="o">()</span> <span class="o">{</span> <span class="k">if</span> <span class="o">[[</span> -f <span class="s2">&quot;$1&quot;</span> <span class="o">]]</span>; <span class="k">then </span>bash <span class="s2">&quot;$1&quot;</span>; <span class="k">else </span><span class="nb">echo</span> <span class="s2">&quot;Skipped missing: $1&quot;</span>; <span class="k">fi</span> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>mkdir -p /root/log/
</span><span class='line'>
</span><span class='line'><span class="nb">exec </span>1&gt;&gt; <span class="k">${</span><span class="nv">LOG</span><span class="k">}</span>
</span><span class='line'><span class="nb">exec </span>2&gt;&gt; <span class="k">${</span><span class="nv">ERROR</span><span class="k">}</span>
</span><span class='line'>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;${ME}: Start  ${START_TSS}&quot;</span> &gt;&gt; <span class="k">${</span><span class="nv">LOG</span><span class="k">}</span>
</span><span class='line'>
</span><span class='line'><span class="nb">export </span><span class="nv">REPOS</span><span class="o">=</span><span class="sb">`</span>find /root/gitrepo/ -maxdepth 1 -mindepth 1 <span class="sb">`</span>
</span><span class='line'><span class="k">for </span>REPO in <span class="k">${</span><span class="nv">REPOS</span><span class="k">}</span>; <span class="k">do</span>
</span><span class='line'><span class="k">    </span><span class="nb">pushd</span> <span class="k">${</span><span class="nv">REPO</span><span class="k">}</span>
</span><span class='line'>        git pull
</span><span class='line'>    <span class="nb">popd</span>
</span><span class='line'><span class="k">done</span>
</span><span class='line'>
</span><span class='line'><span class="k">for </span>REPO in <span class="k">${</span><span class="nv">REPOS</span><span class="k">}</span>; <span class="k">do</span>
</span><span class='line'><span class="k">    </span><span class="nb">pushd</span> <span class="k">${</span><span class="nv">REPO</span><span class="k">}</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">[[</span> -e <span class="k">${</span><span class="nv">CURRENT_ACTION_FILE</span><span class="k">}</span> <span class="o">]]</span>; <span class="k">then</span>
</span><span class='line'>            : <span class="c">#Don&#39;t do anything until the current action completes</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'><span class="k">            </span>bash_ifexist bin/nodework/common/work.sh
</span><span class='line'>        <span class="k">fi</span>
</span><span class='line'><span class="k">    </span><span class="nb">popd</span>
</span><span class='line'><span class="k">done</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nb">export </span><span class="nv">FINISH_TSS</span><span class="o">=</span><span class="s2">&quot;`date +%Y%m%d-%H%M%S`&quot;</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;${ME}: Finish ${FINISH_TSS}&quot;</span> &gt;&gt; <span class="k">${</span><span class="nv">LOG</span><span class="k">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The reason for the double loop is to make sure inter-repository interactions are all &#8220;at the same time&#8221;.  After the set
of &#8216;pulls&#8217;, everything is stable.  We could even slow down the tempo of the system by simply pulling less often and
could jitter before the set of &#8216;pulls&#8217; which would jitter the whole system.</p>

<h3>Where to work?</h3>

<p>So if we have our &#8216;IT&#8217; repo as &#8216;repo2_petulant-cyril&#8217; and our application repo as &#8216;repo3_miniature-ironman&#8217;, where should
we do our &#8216;work.sh&#8217;?  The answer is unfortunatly simple: &#8220;where ever you want&#8221;.  The more you do work in &#8216;repo2&#8217; the
more &#8216;functional&#8217; your system.  Like classic functional / imperative programming.  The more you do work in &#8216;repo3&#8217; the
more &#8216;object-oriented&#8217; your system.  The more &#8216;repo3&#8217; is alive vs. being acted-upon.  On the other hand, the more you
do work in &#8216;repo2&#8217;, the more you can leverage similarities in the work (like knowing directory structures, git versions,
etc.) and the less &#8216;repo3&#8217; is complicated by these things.  Ultimately it would be ideal to be &#8216;aspect-oriented&#8217; and
add a &#8216;trait&#8217; to &#8216;repo3&#8217;.  But for the moment, I will keep things simple and do all the work in &#8216;repo2&#8217; where depending
on the kind of node you are, you <em>know about</em> &#8216;repo3&#8217; vs. &#8216;repo3&#8217; knowing it could be alive.</p>

<h3>&#8216;repo3:miniature-ironman&#8217;</h3>

<p>Why does &#8216;repo3&#8217; have two names?  The first is a simple identifier: it is a &#8216;repo&#8217; and it is the third of its kind.
This simplicity makes sure things like &#8216;find&#8217; produce a simple in-order answer.  If we have a lot of repositories, we
might start with &#8216;101&#8217; to make sure sorting works for a few hundred repositories.  The second part is a human-memorable
name, and to help associate the repository with its purpose.  You shouldn&#8217;t name a repository <em>after</em> its purpose, because
it&#8217;s purpose could change.  Outright change or simply grow.  Or another repo could have the same purpose and now we
can&#8217;t figure out which is right.  It would be like naming a kid &#8216;toddler&#8217;.  At first it might
not even be a toddler yet, but more importantly, eventually it will clearly no longer be a toddler.  And we would have
  a lot of &#8216;toddler&#8217;s so we can&#8217;t figure out which is what.</p>

<p>So instead, each repo just has a unique name.  We have to look at it and interact with it to figure out what it is.  Or
each has a README that we can try to keep current.</p>

<h3>app1/work.sh</h3>

<p>We can fetch &#8216;repo3&#8217; from &#8216;repo2&#8217; within the work of an application server:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#====================================================</span>
</span><span class='line'><span class="c">#=== lad1/app1</span>
</span><span class='line'><span class="c">#====================================================</span>
</span><span class='line'>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;Doing App1 work&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c">#====================================================</span>
</span><span class='line'><span class="c">#=== checkout the application repository</span>
</span><span class='line'><span class="c">#=== if it doesn&#39;t exist</span>
</span><span class='line'><span class="c">#====================================================</span>
</span><span class='line'>
</span><span class='line'><span class="nb">export </span><span class="nv">APP_REPO</span><span class="o">=</span>repo3_miniature-ironman
</span><span class='line'><span class="nb">export </span><span class="nv">APP_NAME</span><span class="o">=</span>app2
</span><span class='line'><span class="nb">export </span><span class="nv">APP_PATH</span><span class="o">=</span><span class="nv">$REPO_ROOT</span>/<span class="nv">$APP_NAME</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> ! -d <span class="s2">&quot;$APP_PATH&quot;</span> <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">  </span><span class="nb">echo</span> <span class="s2">&quot;git clone git@github.com:shaklee/${APP_REPO}.git $APP_PATH&quot;</span>
</span><span class='line'>  git clone git@github.com:shaklee/<span class="k">${</span><span class="nv">APP_REPO</span><span class="k">}</span>.git <span class="nv">$APP_PATH</span>
</span><span class='line'><span class="k">fi</span>
</span></code></pre></td></tr></table></div></figure>


<p>The rest of the script looks identical to our main &#8216;work.sh&#8217; except our directory has switched from &#8216;common&#8217; to
something more specific.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#====================================================</span>
</span><span class='line'><span class="c">#=== Temporary files location</span>
</span><span class='line'><span class="c">#=== Override the &#39;TEMP&#39; directory to be for this part</span>
</span><span class='line'><span class="c">#====================================================</span>
</span><span class='line'>
</span><span class='line'><span class="nb">export </span><span class="nv">ADD_TEMP</span><span class="o">=</span><span class="k">${</span><span class="nv">GIT_ROOT</span><span class="k">}</span>/.temp/add/lad1_app1b/
</span><span class='line'><span class="nb">export </span><span class="nv">MY_DIR</span><span class="o">=</span><span class="s2">&quot;$( cd -P &quot;</span><span class="k">$(</span> dirname <span class="s2">&quot;${BASH_SOURCE[0]}&quot;</span> <span class="k">)</span><span class="s2">&quot; &amp;&amp; pwd )&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>And we have to push/pop to get in the right directory for the &#8216;GIT&#8217; commands to work.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">pushd</span> <span class="nv">$APP_PATH</span>
</span><span class='line'><span class="nb">export </span><span class="nv">GIT_VERSION</span><span class="o">=</span><span class="sb">`</span>git rev-parse HEAD<span class="sb">`</span>
</span><span class='line'><span class="nb">export </span><span class="nv">DETECT_GIT_CHANGE</span><span class="o">=</span><span class="sb">`</span>git log --pretty<span class="o">=</span>oneline <span class="k">${</span><span class="nv">PREV_WORK_VERSION</span><span class="k">}</span>..  -- <span class="k">${</span><span class="nv">WORK_WATCH_VALUE</span><span class="k">}</span> | awk <span class="s1">&#39;{print $1}&#39;</span><span class="sb">`</span>
</span><span class='line'><span class="nb">popd</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Start / restart</h3>

<p>Ultimately we will run from a Tomcat or similar container, but currently we just have to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">pushd</span> <span class="nv">$APP_PATH</span>
</span><span class='line'>./gradlew run &amp;
</span><span class='line'><span class="nb">popd</span>
</span></code></pre></td></tr></table></div></figure>


<p>Except for a couple issues</p>

<ul>
<li>We would like the error and standard output to go somewhere in case something goes wrong</li>
<li>We need to not collide with an previous &#8216;run&#8217; because they hold onto the same port</li>
</ul>


<p>Solving these is pretty trivial if we are allowed to be &#8216;brutal&#8217; and accept downtime.  Ultimately this won&#8217;t be
a problem because we will first &#8216;shutdown&#8217; and let the load balancer pull us out of rotation before we actually
upgrade versions.</p>

<h4>Launching</h4>

<p>Making something into a daemon is a common approach, but an even simpler approach is just redirect stdout and stderr
on a detached process.  Trying this from a terminal appears to not work, because everything is a child
of the terminal login process.  But to get out of that problem, you can just use &#8216;screen&#8217; and
create a non-terminal-connected screen.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>screen
</span><span class='line'>./gradlew run &amp;
</span><span class='line'><span class="c">#Control-D</span>
</span><span class='line'>ps aux | grep java
</span></code></pre></td></tr></table></div></figure>


<p>This is just for testing with a manual launch.  Our cron job doesn&#8217;t have this issue and can start and restart
things without the extra effort.</p>

<h4>Logging</h4>

<p>The heartbeat cron job has its own logs, so everything would appear there by default.  We can change the destination to
something more informative / isolated by redirecting stdout and stderr.  Ultimately we would use a logging
framework and infrastructure (e.g. Graylog) to get everything off the machine and into a central logger.</p>

<h4>Killing</h4>

<p>Again, because we will ultimate decommission ourselves, we can be quite brutal to the running application.  Whenever
we are going offline, we mark ourselves as decommissioned and drain out all &#8216;clients&#8217;.  For a web server this is
very quick.  For other servers (like a game server with shared game state), this can take a while.  So the states are:</p>

<ul>
<li>Running

<ul>
<li>Add Users</li>
<li>Keep Steady</li>
<li>Drain Users</li>
</ul>
</li>
<li>Decommissioning

<ul>
<li>Drain Users</li>
<li>Drained</li>
</ul>
</li>
<li>Decommission

<ul>
<li>Graceful shutdown</li>
<li>Kill application</li>
</ul>
</li>
</ul>


<p>The last one is the critical one.  Although &#8216;tomcat&#8217; and others have a graceful shutdown, <em>it does not always work</em>.
We must be able to decommission properly, or we have to kill the application.  If we can&#8217;t decommission a node
successfully, we can not bring it back to &#8216;running&#8217; and so our instance pool has shrunk.  Ideally our infrastructure
recognizes this and either (a) kills the node or (b) marks the node as permanently unavailable and bumps the count
of expected nodes in the array (say from 4 to 5 to include one being permanently unavailable).
The benefit of &#8216;b&#8217; is we can investigate the node later.  But either is operationally reasonable.</p>

<p>So for the moment, lets just do the last one to decommission:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># Log what we are killing... could also test whether &#39;kill&#39; is needed</span>
</span><span class='line'>
</span><span class='line'>ps aux | grep java | grep -v grep
</span><span class='line'>ps aux | grep java | grep -v grep | awk <span class="s1">&#39;{print $2}&#39;</span> | xargs <span class="nb">kill</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Are we alive?</h4>

<p>Finally, we should at least reasonably check whether we are alive with the new version.  The load balancer is
checking our URL, so it knows.  But the load balancer can&#8217;t tell the world (HipChat) whether the deploy was
successful.</p>

<p>A simple &#8216;curl&#8217; to our local port can though.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>curl localhost:8080 &gt; <span class="nv">$ADD_TEMP</span>/curl_test.html
</span><span class='line'><span class="nb">export </span><span class="nv">CURL_TEST</span><span class="o">=</span><span class="sb">`</span>cat  <span class="nv">$ADD_TEMP</span>/curl_test.html<span class="sb">`</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="o">[[</span> -z <span class="s2">&quot;$CURL_TEST&quot;</span> <span class="o">]]</span> ;
</span><span class='line'><span class="k">then</span>
</span><span class='line'><span class="k">    </span><span class="nb">echo</span> <span class="s1">&#39;Deployment failed!&#39;</span>;
</span><span class='line'><span class="k">else</span>
</span><span class='line'><span class="k">    </span><span class="nb">echo</span> <span class="s1">&#39;Success!&#39;</span>;
</span><span class='line'><span class="k">fi</span>
</span></code></pre></td></tr></table></div></figure>


<h2>DNS Stability</h2>

<p>The DNS stability is a trivial thing on EC2 and basically any modern DNS system.  Trivial as long as we understand
one fatal flaw:</p>

<ul>
<li>Everyone caches</li>
</ul>


<p>We can have stability so long as we accept that everyone is trying to cache the DNS to IP address for as long as
possible.  This can be minutes or even longer <em>in spite</em> of our DNS records saying otherwise.  This is actually
 one of the reason load balancers are so important.  Load balancing is a very simple concept.  Your load balancers
 should be simple enough to &#8216;keep running&#8217; and be rarely flipped.  So their IP addresses will be stable: like the person
 who is always hanging out on their front porch.  You can always find them there and ask them to ask someone else
 a question.  They will take care of the rest.</p>

<p>So ultimately we don&#8217;t want the application server obtaining a domain-name, we want it to register with a load
balancer.  But for the moment (and for some useful internal capabilities) we will have each application server
take-a-name.</p>

<h3>How to take a name?</h3>

<p>Before the cloud, the common ways to take a name were:</p>

<ul>
<li>To assign a name via the console of the domain name server</li>
<li>To dynamically attach an IP address to a name via various protocols</li>
</ul>


<p>Pre-cloud, these work fairly well.  If you DN server is smart enough, it can take failed servers out of rotation
with a health check.  And even early versions of cloud computing used a similar model where servers took
possession of a pre-allocated IP address that the DN server knew about.  But these models don&#8217;t scale as
well as a much simpler model.  Route-53.</p>

<p>Route-53 takes the &#8216;dynamically&#8217; to a whole new level.  You can dynamically add / change / delete most anything
and the common latency for the change to take affect is very short.  The rest of the world <em>still caches</em> but
at least you know the DN servers are up to date.  In the following, you can see the &#8216;gaps2c&#8217; project I created
a while ago as a demonstration of this ability.  The main domain registry for &#8216;gaps2c.com&#8217; is elsewhere, but
the subdomain of &#8216;aws.gaps2c.com&#8217; is managed by route53.  The last entry works and says <a href="google.aws.gaps2c.com">google.aws.gaps2c.com</a>
knows where the google servers are.</p>

<p><img src="/images/add-11/add11_route53_1.png" /></p>

<h3>Registering with Route-53</h3>

<p>There are a lot of ways to register with Route-53:</p>

<ul>
<li> Via the console</li>
<li> Via an XML-based payload update</li>
<li> Via adding some elements to a CloudFormation</li>
</ul>


<p>The first is easy, but not scalable.  The second is not hard, but a bit &#8216;peculiar&#8217; in how the payload works.  The
third is trivial and scalable.</p>

<p>So lets start with the third</p>

<h4>Registering via a CloudFormation template</h4>

<p>The good news is it is simple in a CloudFormation.  The bad news is it requires a bit more infrastructure to appear, so
it isn&#8217;t a one-liner.  The issue with CloudFormations is that they must be <em>complete</em>.  They can only auto-wire things
they know about.  So they are relatively monolithic.  It is possible to compose them somewhat, but that is really
just embedding one formation into another vs. wiring two independent formations up.  Ultimately to wire up independent
formations, you need to &#8216;know what you said&#8217; and tell two or more formations enough information that they can find
each other.  That is not hard but it isn&#8217;t free.</p>

<p>But for free, we can add three things to our application stack and get a DNS registration for our application tier.</p>

<ul>
<li> A HostedZone entry – Pointing into the Route 53 database</li>
<li> An ElasticLoadBalancer – Which enables the CloudFormation to know about IP addresses</li>
<li> A PrimaryDnsZone – Which defines the FQDN of the application tier</li>
</ul>


<p>And we need to augment our AutoScalingGroup to know about the ELB.  Adding all this gives:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="s2">&quot;HostedZone&quot;</span> <span class="err">:</span> <span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;Type&quot;</span> <span class="p">:</span> <span class="s2">&quot;String&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;Default&quot;</span> <span class="p">:</span> <span class="s2">&quot;aws.gaps2c.com&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;Description&quot;</span> <span class="p">:</span> <span class="s2">&quot;The DNS name of an existing Amazon Route 53 hosted zone&quot;</span>
</span><span class='line'><span class="p">}</span><span class="err">,</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="s2">&quot;PrimaryElb&quot;</span> <span class="err">:</span> <span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;Type&quot;</span> <span class="p">:</span> <span class="s2">&quot;AWS::ElasticLoadBalancing::LoadBalancer&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;Metadata&quot;</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;Comment&quot;</span> <span class="p">:</span> <span class="s2">&quot;Configure the Load Balancer with a simple health check and cookie-based stickiness&quot;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nt">&quot;Properties&quot;</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;AvailabilityZones&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="nt">&quot;Fn::GetAZs&quot;</span> <span class="p">:</span> <span class="s2">&quot;&quot;</span> <span class="p">},</span>
</span><span class='line'>    <span class="nt">&quot;LBCookieStickinessPolicy&quot;</span> <span class="p">:</span> <span class="p">[</span> <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;PolicyName&quot;</span> <span class="p">:</span> <span class="s2">&quot;CookieBasedPolicy&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;CookieExpirationPeriod&quot;</span> <span class="p">:</span> <span class="s2">&quot;30&quot;</span>
</span><span class='line'>    <span class="p">}</span> <span class="p">],</span>
</span><span class='line'>    <span class="nt">&quot;Listeners&quot;</span> <span class="p">:</span> <span class="p">[</span> <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;LoadBalancerPort&quot;</span> <span class="p">:</span> <span class="s2">&quot;8080&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;InstancePort&quot;</span> <span class="p">:</span> <span class="s2">&quot;8080&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;Protocol&quot;</span> <span class="p">:</span> <span class="s2">&quot;HTTP&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;PolicyNames&quot;</span> <span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;CookieBasedPolicy&quot;</span> <span class="p">]</span>
</span><span class='line'>    <span class="p">}</span> <span class="p">]</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span><span class="err">,</span>
</span><span class='line'>
</span><span class='line'><span class="s2">&quot;PrimaryDnsZone&quot;</span> <span class="err">:</span> <span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;Type&quot;</span> <span class="p">:</span> <span class="s2">&quot;AWS::Route53::RecordSet&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;Properties&quot;</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;HostedZoneName&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="nt">&quot;Fn::Join&quot;</span> <span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">[{</span><span class="nt">&quot;Ref&quot;</span> <span class="p">:</span> <span class="s2">&quot;HostedZone&quot;</span><span class="p">},</span> <span class="s2">&quot;.&quot;</span> <span class="p">]]},</span>
</span><span class='line'>    <span class="nt">&quot;Comment&quot;</span> <span class="p">:</span> <span class="s2">&quot;CNAME redirect to aws.amazon.com.&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;Name&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="nt">&quot;Fn::Join&quot;</span> <span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">[{</span> <span class="nt">&quot;Fn::FindInMap&quot;</span> <span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;TemplateConstant&quot;</span><span class="p">,</span> <span class="s2">&quot;deployment&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span> <span class="p">]</span> <span class="p">},</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="nt">&quot;Fn::FindInMap&quot;</span> <span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;TemplateConstant&quot;</span><span class="p">,</span> <span class="s2">&quot;nodepart&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span> <span class="p">]</span> <span class="p">},</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nt">&quot;Ref&quot;</span> <span class="p">:</span> <span class="s2">&quot;HostedZone&quot;</span><span class="p">},</span> <span class="s2">&quot;.&quot;</span><span class="p">]]},</span>
</span><span class='line'>    <span class="nt">&quot;Type&quot;</span> <span class="p">:</span> <span class="s2">&quot;CNAME&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;TTL&quot;</span> <span class="p">:</span> <span class="s2">&quot;900&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;ResourceRecords&quot;</span> <span class="p">:</span> <span class="p">[{</span> <span class="nt">&quot;Fn::GetAtt&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;PrimaryElb&quot;</span><span class="p">,</span><span class="s2">&quot;CanonicalHostedZoneName&quot;</span><span class="p">]</span> <span class="p">}]</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span><span class="err">,</span>
</span><span class='line'>
</span><span class='line'><span class="s2">&quot;PrimaryServerGroup&quot;</span> <span class="err">:</span> <span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;Type&quot;</span> <span class="p">:</span> <span class="s2">&quot;AWS::AutoScaling::AutoScalingGroup&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;Properties&quot;</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;Tags&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>      <span class="p">{</span> <span class="nt">&quot;Key&quot;</span><span class="p">:</span> <span class="s2">&quot;add:deployment&quot;</span><span class="p">,</span> <span class="nt">&quot;Value&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="nt">&quot;Fn::FindInMap&quot;</span> <span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;TemplateConstant&quot;</span><span class="p">,</span> <span class="s2">&quot;deployment&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span> <span class="p">]</span> <span class="p">},</span> <span class="nt">&quot;PropagateAtLaunch&quot;</span> <span class="p">:</span> <span class="s2">&quot;true&quot;</span> <span class="p">},</span>
</span><span class='line'>      <span class="p">{</span> <span class="nt">&quot;Key&quot;</span><span class="p">:</span> <span class="s2">&quot;add:nodepart&quot;</span><span class="p">,</span> <span class="nt">&quot;Value&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="nt">&quot;Fn::FindInMap&quot;</span> <span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;TemplateConstant&quot;</span><span class="p">,</span> <span class="s2">&quot;nodepart&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span> <span class="p">]</span> <span class="p">},</span> <span class="nt">&quot;PropagateAtLaunch&quot;</span> <span class="p">:</span> <span class="s2">&quot;true&quot;</span> <span class="p">},</span>
</span><span class='line'>      <span class="p">{</span> <span class="nt">&quot;Key&quot;</span><span class="p">:</span> <span class="s2">&quot;add:stacktype&quot;</span><span class="p">,</span> <span class="nt">&quot;Value&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="nt">&quot;Fn::FindInMap&quot;</span> <span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;TemplateConstant&quot;</span><span class="p">,</span> <span class="s2">&quot;stacktype&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span> <span class="p">]</span> <span class="p">},</span> <span class="nt">&quot;PropagateAtLaunch&quot;</span> <span class="p">:</span> <span class="s2">&quot;true&quot;</span> <span class="p">},</span>
</span><span class='line'>      <span class="p">{</span> <span class="nt">&quot;Key&quot;</span><span class="p">:</span> <span class="s2">&quot;add:statelog&quot;</span><span class="p">,</span> <span class="nt">&quot;Value&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="nt">&quot;Fn::FindInMap&quot;</span> <span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;TemplateConstant&quot;</span><span class="p">,</span> <span class="s2">&quot;statelog&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span> <span class="p">]</span> <span class="p">},</span> <span class="nt">&quot;PropagateAtLaunch&quot;</span> <span class="p">:</span> <span class="s2">&quot;true&quot;</span> <span class="p">},</span>
</span><span class='line'>      <span class="p">{</span> <span class="nt">&quot;Key&quot;</span><span class="p">:</span> <span class="s2">&quot;add:state&quot;</span><span class="p">,</span> <span class="nt">&quot;Value&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="nt">&quot;Fn::FindInMap&quot;</span> <span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;TemplateConstant&quot;</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span> <span class="p">]</span> <span class="p">},</span> <span class="nt">&quot;PropagateAtLaunch&quot;</span> <span class="p">:</span> <span class="s2">&quot;true&quot;</span> <span class="p">},</span>
</span><span class='line'>      <span class="p">{</span> <span class="nt">&quot;Key&quot;</span><span class="p">:</span> <span class="s2">&quot;add:statetss&quot;</span><span class="p">,</span> <span class="nt">&quot;Value&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="nt">&quot;Fn::FindInMap&quot;</span> <span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;TemplateConstant&quot;</span><span class="p">,</span> <span class="s2">&quot;statetss&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span> <span class="p">]</span> <span class="p">},</span> <span class="nt">&quot;PropagateAtLaunch&quot;</span> <span class="p">:</span> <span class="s2">&quot;true&quot;</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">],</span>
</span><span class='line'>    <span class="nt">&quot;AvailabilityZones&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="nt">&quot;Fn::GetAZs&quot;</span> <span class="p">:</span> <span class="s2">&quot;&quot;</span> <span class="p">},</span>
</span><span class='line'>    <span class="nt">&quot;LaunchConfigurationName&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="nt">&quot;Ref&quot;</span> <span class="p">:</span> <span class="s2">&quot;PrimaryLaunchConfig&quot;</span> <span class="p">},</span>
</span><span class='line'>    <span class="nt">&quot;MinSize&quot;</span> <span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;MaxSize&quot;</span> <span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;DesiredCapacity&quot;</span> <span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;LoadBalancerNames&quot;</span> <span class="p">:</span> <span class="p">[</span> <span class="p">{</span> <span class="nt">&quot;Ref&quot;</span> <span class="p">:</span> <span class="s2">&quot;PrimaryElb&quot;</span> <span class="p">}</span> <span class="p">]</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span><span class="err">,</span>
</span></code></pre></td></tr></table></div></figure>


<p>After adding all that, we get a new Route53 entry</p>

<p><img src="/images/add-11/add11_route53_2.png" /></p>

<p>And can also look at our load balancer:</p>

<p><img src="/images/add-11/add11_route53_3.png" /></p>

<p>And the instance associated with it:</p>

<p><img src="/images/add-11/add11_route53_4.png" /></p>

<p>And the rule we use to figure out whether the instance is alive</p>

<p><img src="/images/add-11/add11_route53_5.png" /></p>

<h2>Voilà!</h2>

<h3>Domain-Based, Auto-Scaling, IT and Application Stack</h3>

<p>We now have a stable domain name for our stack: &#8216;fed1-app1.aws.gapcom.com&#8217;</p>

<p><img src="/images/add-11/add11_dns1.png" /></p>

<p>which can scale up and down machines automatically.  Ideally there are at least four in production to make sure
all the availability zones under &#8216;US East&#8217; are covered.  But for anything else, one or two is sufficient depending
on what you are testing.</p>

<h3>Autodeploying IT and Application</h3>

<p>We now have a completely automated upgrade system for both our IT (servers) and
for the applications those servers are running.  Whenever we touch the code base
and &#8216;push&#8217; the changes so the servers can see/pull them (PushMePullYou), they automatically
decommission, deploy and confirm the deploy was successful.</p>

<p><img src="/images/add-11/add11_autodeploy1.png" /></p>

<h3>What Next?</h3>

<p>Basically nothing is left for the core of the ADD.  This series has described how the four ingredients
are cooked/hooked together and shown what that looks like on EC2.  Other topics are just filling in details
that are really just nuances and flavors of the ADD. For example:</p>

<ul>
<li>What is the Grails application stack like?</li>
<li>How does Vagrant handle the one minute crons and other more advanced features?</li>
<li>Should you <em>develop in Vagrant</em> or on the host operating system?

<ul>
<li>Answer: Either depending on what you are doing and how productive you are, but the closer you are to production, the more likely you are to catch issues</li>
</ul>
</li>
<li>How does HAProxy and the database configuration using presence work?</li>
<li>What about NewRelic and other monitoring tools</li>
<li>Where is Angular in all this?</li>
</ul>


<p>The first and last topic I will cover in the next multi-part series called the &#8216;AddStack&#8217;.  The others are more specific topics that I may get to eventually, but
are not critical to understanding and using the ADD.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Mark Fussell</span></span>

      








  


<time datetime="2015-10-14T01:00:00-07:00" pubdate data-updated="true">Oct 14<span>th</span>, 2015</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/add/'>ADD</a>, <a class='category' href='/blog/categories/automation/'>Automation</a>, <a class='category' href='/blog/categories/cloud/'>Cloud</a>, <a class='category' href='/blog/categories/git/'>Git</a>, <a class='category' href='/blog/categories/it/'>IT</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://markfussell.emenar.com/blog/add-11/" data-via="" data-counturl="http://markfussell.emenar.com/blog/add-11/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/add-10/" title="Previous Post: Advanced Development and Delivery (ADD) [Part-10]">&laquo; Advanced Development and Delivery (ADD) [Part-10]</a>
      
      
        <a class="basic-alignment right" href="/blog/addstack-1/" title="Next Post: ADD Stack [Part-1]">ADD Stack [Part-1] &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>About Me</h1>
  <p>
      <a href="http://www.linkedin.com/in/markfussell/">Linked In</a>
      &bull;
      <a href="http://github.com/markfussell/">Github</a>
      &bull;
      <a href="http://palobots.org/">PaloBots</a>
  </p>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/addstack-3/">ADD Stack [Part-3]</a>
      </li>
    
      <li class="post">
        <a href="/blog/addstack-2/">ADD Stack [Part-2]</a>
      </li>
    
      <li class="post">
        <a href="/blog/addstack-1/">ADD Stack [Part-1]</a>
      </li>
    
      <li class="post">
        <a href="/blog/add-11/">Advanced Development and Delivery (ADD) [Part-11]</a>
      </li>
    
      <li class="post">
        <a href="/blog/add-10/">Advanced Development and Delivery (ADD) [Part-10]</a>
      </li>
    
  </ul>
</section>
<section>
    <h1>Categories</h1>
    <span id="category-list"><a href='/blog/categories/add' style='font-size: 144.21052631578948%'>ADD</a> <a href='/blog/categories/agile' style='font-size: 103.15789473684211%'>Agile</a> <a href='/blog/categories/automation' style='font-size: 150.5263157894737%'>Automation</a> <a href='/blog/categories/cloud' style='font-size: 153.68421052631578%'>Cloud</a> <a href='/blog/categories/database' style='font-size: 106.3157894736842%'>Database</a> <a href='/blog/categories/dylan' style='font-size: 103.15789473684211%'>Dylan</a> <a href='/blog/categories/dynamic' style='font-size: 122.10526315789474%'>Dynamic</a> <a href='/blog/categories/ephemeral' style='font-size: 103.15789473684211%'>Ephemeral</a> <a href='/blog/categories/flex' style='font-size: 122.10526315789474%'>Flex</a> <a href='/blog/categories/git' style='font-size: 160.0%'>Git</a> <a href='/blog/categories/grails' style='font-size: 109.47368421052632%'>Grails</a> <a href='/blog/categories/guideline' style='font-size: 103.15789473684211%'>Guideline</a> <a href='/blog/categories/it' style='font-size: 153.68421052631578%'>IT</a> <a href='/blog/categories/java' style='font-size: 115.78947368421052%'>Java</a> <a href='/blog/categories/ooad' style='font-size: 103.15789473684211%'>OOAD</a> <a href='/blog/categories/oopsla' style='font-size: 103.15789473684211%'>OOPSLA</a> <a href='/blog/categories/rails' style='font-size: 106.3157894736842%'>Rails</a> <a href='/blog/categories/relational' style='font-size: 106.3157894736842%'>Relational</a> <a href='/blog/categories/ruby' style='font-size: 147.3684210526316%'>Ruby</a> <a href='/blog/categories/rubyshoes' style='font-size: 112.63157894736842%'>RubyShoes</a> <a href='/blog/categories/scratch' style='font-size: 109.47368421052632%'>Scratch</a> <a href='/blog/categories/smalltalk' style='font-size: 153.68421052631578%'>Smalltalk</a> <a href='/blog/categories/stack' style='font-size: 109.47368421052632%'>Stack</a> <a href='/blog/categories/virtualization' style='font-size: 103.15789473684211%'>Virtualization</a> </span>
</section>
<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/markfussell">@markfussell</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'markfussell',
            count: 6,
            skip_forks: false,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>






  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Mark Fussell -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'markfussell';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://markfussell.emenar.com/blog/add-11/';
        var disqus_url = 'http://markfussell.emenar.com/blog/add-11/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
